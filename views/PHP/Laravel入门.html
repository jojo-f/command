<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Laravel | LLORZ-O</title>
    <meta name="description" content="与君共勉">
    <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.cc085390.css" as="style"><link rel="preload" href="/assets/js/app.47c924c6.js" as="script"><link rel="preload" href="/assets/js/4.4a909b2e.js" as="script"><link rel="preload" href="/assets/js/1.412fd552.js" as="script"><link rel="preload" href="/assets/js/21.f77bec32.js" as="script"><link rel="prefetch" href="/assets/js/10.bee858e5.js"><link rel="prefetch" href="/assets/js/11.38f4443d.js"><link rel="prefetch" href="/assets/js/12.33d57f5f.js"><link rel="prefetch" href="/assets/js/13.9a85efae.js"><link rel="prefetch" href="/assets/js/14.68e24796.js"><link rel="prefetch" href="/assets/js/15.93441024.js"><link rel="prefetch" href="/assets/js/16.b6333f12.js"><link rel="prefetch" href="/assets/js/17.fb733925.js"><link rel="prefetch" href="/assets/js/18.7f22e8b6.js"><link rel="prefetch" href="/assets/js/19.4a71e6a8.js"><link rel="prefetch" href="/assets/js/2.90ebb111.js"><link rel="prefetch" href="/assets/js/20.9e7175ec.js"><link rel="prefetch" href="/assets/js/22.412c9495.js"><link rel="prefetch" href="/assets/js/23.03ee322c.js"><link rel="prefetch" href="/assets/js/24.1ba7bd6b.js"><link rel="prefetch" href="/assets/js/25.fa44eb9e.js"><link rel="prefetch" href="/assets/js/26.4e0ceaae.js"><link rel="prefetch" href="/assets/js/27.ef71ef9a.js"><link rel="prefetch" href="/assets/js/28.65489282.js"><link rel="prefetch" href="/assets/js/29.594894eb.js"><link rel="prefetch" href="/assets/js/30.d70d1394.js"><link rel="prefetch" href="/assets/js/31.f134f541.js"><link rel="prefetch" href="/assets/js/5.f232a475.js"><link rel="prefetch" href="/assets/js/6.ed43c739.js"><link rel="prefetch" href="/assets/js/7.b0e2ce4c.js"><link rel="prefetch" href="/assets/js/8.f5102ae2.js"><link rel="prefetch" href="/assets/js/9.33224a89.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cc085390.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container"><div><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/head.jpg" alt="LLORZ-O" class="logo"> <span class="site-name">LLORZ-O</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><!----> <div class="dark-theme-options toggle-option"><label for="dark-theme-toggle">Enable Dark Theme?</label> <input id="dark-theme-toggle" type="checkbox" checked="checked"></div></div></div></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/代码.html" class="nav-link"><i class="iconfont undefined"></i>
  代码
</a></li><li class="dropdown-item"><!----> <a href="/category/Tools.html" class="nav-link"><i class="iconfont undefined"></i>
  Tools
</a></li><li class="dropdown-item"><!----> <a href="/category/Chaos.html" class="nav-link"><i class="iconfont undefined"></i>
  Chaos
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><a href="/say/" class="nav-link"><i class="iconfont reco-account"></i>
  说说
</a></div><div class="nav-item"><a href="/collection/" class="nav-link"><i class="iconfont reco-other"></i>
  收藏
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      关于我
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Mrzhoulichao" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="/unpack/about.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于我
</a></li><li class="dropdown-item"><!----> <a href="/unpack/memo.html" class="nav-link"><i class="iconfont reco-document"></i>
  备忘录
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/代码.html" class="nav-link"><i class="iconfont undefined"></i>
  代码
</a></li><li class="dropdown-item"><!----> <a href="/category/Tools.html" class="nav-link"><i class="iconfont undefined"></i>
  Tools
</a></li><li class="dropdown-item"><!----> <a href="/category/Chaos.html" class="nav-link"><i class="iconfont undefined"></i>
  Chaos
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><a href="/say/" class="nav-link"><i class="iconfont reco-account"></i>
  说说
</a></div><div class="nav-item"><a href="/collection/" class="nav-link"><i class="iconfont reco-other"></i>
  收藏
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      关于我
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Mrzhoulichao" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="/unpack/about.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于我
</a></li><li class="dropdown-item"><!----> <a href="/unpack/memo.html" class="nav-link"><i class="iconfont reco-document"></i>
  备忘录
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Laravel</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#路由与控制器" class="sidebar-link">路由与控制器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#路由" class="sidebar-link">路由</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#路由分组" class="sidebar-link">路由分组</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#控制器" class="sidebar-link">控制器</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#路由进阶" class="sidebar-link">路由进阶</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#表单方法伪造-csrf-保护" class="sidebar-link">表单方法伪造 CSRF 保护</a></li></ul></li><li><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#view-blade-tpl" class="sidebar-link">view &amp; blade tpl</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#view" class="sidebar-link">view</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#blade-模板" class="sidebar-link">Blade 模板</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#模板继承-组件引入" class="sidebar-link">模板继承 &amp; 组件引入</a></li></ul></li><li><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#laravel-前端" class="sidebar-link">Laravel 前端</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#copy" class="sidebar-link">copy</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#version" class="sidebar-link">version()</a></li></ul></li><li><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#请求" class="sidebar-link">请求</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#文件上传" class="sidebar-link">文件上传</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#表单验证" class="sidebar-link">表单验证</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#表单请求类" class="sidebar-link">表单请求类</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#数组请求验证" class="sidebar-link">数组请求验证</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#自定义验证规则" class="sidebar-link">自定义验证规则</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#创建规则类自定义验证规则" class="sidebar-link">创建规则类自定义验证规则</a></li></ul></li><li><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#artisan" class="sidebar-link">Artisan</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#编写命令" class="sidebar-link">编写命令</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#进阶" class="sidebar-link">进阶</a></li></ul></li><li><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#laravel-eloquent" class="sidebar-link">Laravel &amp; Eloquent</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#基本配置" class="sidebar-link">基本配置</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#迁移" class="sidebar-link">迁移</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#索引和外键" class="sidebar-link">索引和外键</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#填充器" class="sidebar-link">填充器</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#crud" class="sidebar-link">CRUD</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#复杂查询语句" class="sidebar-link">复杂查询语句</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#模型-crud" class="sidebar-link">模型 CRUD</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#批量赋值-软删除" class="sidebar-link">批量赋值 &amp; 软删除</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#访问器-修改器" class="sidebar-link">访问器 &amp; 修改器</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#查询作用域" class="sidebar-link">查询作用域</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#模型事件" class="sidebar-link">模型事件</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#模型关联关系" class="sidebar-link">模型关联关系</a></li></ul></li><li><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#telescope-安装" class="sidebar-link">Telescope 安装</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#只在指定环境安装" class="sidebar-link">只在指定环境安装</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#配置" class="sidebar-link">配置</a></li><li class="sidebar-sub-header"><a href="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html#访问" class="sidebar-link">访问</a></li></ul></li></ul></section></li></ul> </aside> <div><main class="page reco-hide"> <div class="page-title"><h1>Laravel</h1> <hr> <div data-v-362e684e><i class="iconfont reco-account" data-v-362e684e><span data-v-362e684e>T9</span></i> <i class="iconfont reco-date" data-v-362e684e><span data-v-362e684e>2019-9-2</span></i> <span id="/views/PHP/Laravel%E5%85%A5%E9%97%A8.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-2e99e05a data-v-362e684e><i class="iconfont reco-eye" style="margin-right: .5rem" data-v-2e99e05a></i> <a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;" data-v-2e99e05a></a></span> <i class="iconfont reco-tag tags" data-v-362e684e><span class="tag-item" data-v-362e684e>
      PHP
    </span><span class="tag-item" data-v-362e684e>
      laravel
    </span></i></div></div> <div class="content__default"><h1 id="准备"><a href="#准备" class="header-anchor">#</a> 准备</h1> <ol><li>Composer <code>php</code>包管理器</li> <li>命名空间 作为后端框架模块划分是必需搞清楚不可的</li> <li><a href="https://laravelacademy.org/post/4281.html" target="_blank" rel="noopener noreferrer">Trait<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>Docker 虽不是必学的,但是非常的香</li></ol> <h1 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h1> <p>使用<code>Composer create project</code> 安装</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>composer create-project laravel/laravel blog --prefer-dist
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>composer <span class="token function">install</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>ERROR 1</p> <p><img src="http://yanxuan.nosdn.127.net/f58c830b1067cf974ff193365f7277ab.png" alt="UTOOLS1568028547215.png"></p> <p>打开<code>php.ini</code>文件</p> <p><code>O:\Dev_soft\phpStudy\PHPTutorial\php\php-7.2.1-nts\php.ini</code></p> <p>找到<code>extension=php_fileinfo.dll</code> 取消注释</p> <p>ERROR 2</p> <p>访问路径无效果</p> <p>在<code>vhosts.conf</code>文件添加虚拟主机配置</p> <div class="language-txt line-numbers-mode"><pre class="language-text"><code>&lt;VirtualHost *:80&gt;
     ServerName laravelht.vn
     DocumentRoot &quot;O:/Test_Project/blog/public&quot;
     SetEnv APPLICATION_ENV &quot;development&quot;
     &lt;Directory &quot;O:/Test_Project/blog/public&quot;&gt;
         DirectoryIndex index.php
         AllowOverride All
         Require all granted
         Order allow,deny
         Allow from all
     &lt;/Directory&gt;
 &lt;/VirtualHost&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>ERROR 3</p> <p>500 server error</p> <p>查看任务日志</p> <p><code>storage/logs</code></p> <div class="language-log line-numbers-mode"><pre class="language-text"><code>production.ERROR: No application encryption key has been specified.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan key:generate
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>生成密钥<code>ok</code>可以访问了</p> <h1 id="基础"><a href="#基础" class="header-anchor">#</a> 基础</h1> <h2 id="路由与控制器"><a href="#路由与控制器" class="header-anchor">#</a> 路由与控制器</h2> <h3 id="路由"><a href="#路由" class="header-anchor">#</a> 路由</h3> <p><code>php</code>中有两个定义路由,<code>routes/web.php</code>,<code>routes/api/php</code></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// 通用的方式 可设置post update delete等其它类型</span>
<span class="token comment">// 还有 any 任意类型,但不推荐使用</span>
Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 白名单 match</span>
Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'get'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'post'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'/'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 复杂业务拆分到控制器中实现</span>
Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'WelcomeController@index'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="路由传参"><a href="#路由传参" class="header-anchor">#</a> 路由传参</h4> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// 路由参数</span>
Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/{id}'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 可选参数,默认参数</span>
Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/{id?}'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$id</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 路由参数匹配规则</span>
Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/{id}/{num}'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">,</span><span class="token variable">$num</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'id'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'[0-9]+'</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'num'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'[0-9]{2,4}'</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="路由命名"><a href="#路由命名" class="header-anchor">#</a> 路由命名</h4> <div class="language-php+HTML line-numbers-mode"><pre class="language-text"><code>// 在view文件中 使用 url 函数将会为路由自动添加域名前缀 =&gt; 'pc.test/'
&lt;a href=&quot;\{\{ url('/') \}\}&quot;&gt;

// 命名式路由 使用name方法命名路由
Route::get('user/{id?}/{name}',function($id = 1){})-&gt;name('user.profile');
// 在view中使用按位传参命名路由(按位传参需要保证顺序),也可使用键值对
&lt;a href=&quot;\{\{ route('user.profile',['id'=&gt;100,'zhou']) \}\}&quot;&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="路由分组"><a href="#路由分组" class="header-anchor">#</a> 路由分组</h3> <p><strong>按中间件分组</strong></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// 多中间件 ['auth','another']</span>
Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'auth'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'dashboard'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'account'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 老版本</span>
Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'middleware'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'auth'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>路由前缀</strong></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// 匹配以 api 开头的路由</span>
Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">prefix</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'api'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>子域名</strong></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// 使用子域名分组的情况下,account永远是分组路由中路由的第一个参数</span>
Route<span class="token punctuation">:</span><span class="token function">domain</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'{account}.blog.test'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/{id}'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$account</span><span class="token punctuation">,</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>子命名空间</strong></p> <p>以控制器方式定义路由的时候，当我们没有显式指定控制器的命名空间时，默认的命名空间是 <code>App\Http\Controllers</code>（在 <code>app/Providers/RouteServiceProvider.php</code> 中设置），如果某些控制器位于这个命名空间下的子命名空间中，我们可以通过 <code>Route::namespace</code> 为同一子命名空间下的分组路由设置共同的子命名空间：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Route::get('/', 'Controller@index');

Route::namespace('Admin')-&gt;group(function() {
     // App\Http\Controllers\Admin\AdminController
     Route::get('/admin', 'AdminController@index');
});
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>路由命名前缀</strong></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'user.'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">prefix</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'user'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/{id}'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 该路由同时满足 /user/{id} ,路由命名 user.show</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'show'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="控制器"><a href="#控制器" class="header-anchor">#</a> 控制器</h3> <p>控制器的主要职责就是获取<code>HTTP</code>请求,进行简单的处理将其传递给真正的业务逻辑职能<code>Service</code>.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan make:controller TaskController
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在<code>app/Http/Controllers</code> 会出现一个 <code>TaskController.php</code> 文件</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Controllers</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">TaskController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span>
<span class="token punctuation">{</span>
	<span class="token comment">//Route::get('/task','TaskController@home')</span>
    <span class="token comment">// 没有指定完整的命名空间,web.php所有的控制器都位于app/Http/Controllers命名空间下</span>
	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">home</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// return 'hello world';</span>
        <span class="token comment">// 以下为常用控制器操作,通过Task::all() 查询所有任务数据(Task模型并未创建)</span>
        <span class="token comment">// 将其赋值给tasks变量在resources/views/task/index.blade.php 中渲染</span>
		<span class="token keyword">return</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'index'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'tasks'</span><span class="token punctuation">,</span>Task<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="客户端输入"><a href="#客户端输入" class="header-anchor">#</a> 客户端输入</h4> <p>这里是采用依赖注入的方式获取用户的输入并保存到<code>$task</code>模型中,日常开发中也推荐使用依赖注入的方式获取用户输入,包括<code>COOKIE</code>,<code>SESSION</code>等.</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">store</span><span class="token punctuation">(</span>Request <span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token variable">$task</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注意这个Task对象并没有实现</span>
		<span class="token variable">$task</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">title</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'title'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$task</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">description</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'description'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$task</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'task'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="资源控制器"><a href="#资源控制器" class="header-anchor">#</a> 资源控制器</h4> <p>键入命令生成<code>app/Http/Controllers/PostController.php</code>文件.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan make:controller PostController --resource
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>资源控制器方法列表</strong></p> <p>以上 <code>PostController</code> 控制器的每个方法都有对应的请求方式、路由命名、URL、方法名和业务逻辑约定。</p> <table><thead><tr><th style="text-align:left;">HTTP 请求方式</th> <th style="text-align:left;">URL</th> <th style="text-align:left;">控制器方法</th> <th style="text-align:left;">路由命名</th> <th style="text-align:left;">业务逻辑描述</th></tr></thead> <tbody><tr><td style="text-align:left;">GET</td> <td style="text-align:left;">post</td> <td style="text-align:left;">index()</td> <td style="text-align:left;">post.index</td> <td style="text-align:left;">展示所有文章</td></tr> <tr><td style="text-align:left;">GET</td> <td style="text-align:left;">post/create</td> <td style="text-align:left;">create()</td> <td style="text-align:left;">post.create</td> <td style="text-align:left;">发布文章表单页面</td></tr> <tr><td style="text-align:left;">POST</td> <td style="text-align:left;">post</td> <td style="text-align:left;">store()</td> <td style="text-align:left;">post.store</td> <td style="text-align:left;">获取表单提交数据并保存新文章</td></tr> <tr><td style="text-align:left;">GET</td> <td style="text-align:left;">post/{post}</td> <td style="text-align:left;">show()</td> <td style="text-align:left;">post.show</td> <td style="text-align:left;">展示单个文章</td></tr> <tr><td style="text-align:left;">GET</td> <td style="text-align:left;">post/{id}/edit</td> <td style="text-align:left;">edit()</td> <td style="text-align:left;">post.edit</td> <td style="text-align:left;">编辑文章表单页面</td></tr> <tr><td style="text-align:left;">PUT</td> <td style="text-align:left;">post/{id}</td> <td style="text-align:left;">update()</td> <td style="text-align:left;">post.update</td> <td style="text-align:left;">获取编辑表单输入并更新文章</td></tr> <tr><td style="text-align:left;">DELETE</td> <td style="text-align:left;">post/{id}</td> <td style="text-align:left;">destroy()</td> <td style="text-align:left;">post.desc</td> <td style="text-align:left;">删除单个文章</td></tr></tbody></table> <p><strong>绑定资源服务器</strong></p> <p>通过上面的表格已经了解了 Laravel 中对资源路由的命名约定，Laravel 还为我们提供了一个 <code>Route::resource</code> 方法用于一次注册包含上面列出的所有路由，并且遵循上述所有约定：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'post'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'PostController'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>通过<code>php artisan route:list</code>查看所有路由</p> <p><img src="https://user-gold-cdn.xitu.io/2019/9/3/16cf5e7153c6036e?w=1054&amp;h=286&amp;f=png&amp;s=50223" alt="UTOOLS1567493655327.png"></p> <p>编写<code>PostController.php</code></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>    <span class="token comment">/**
     * Display the specified resource.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
		<span class="token comment">//</span>
		<span class="token keyword">return</span> <span class="token single-quoted-string string">'Post'</span> <span class="token punctuation">.</span> <span class="token variable">$id</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'Link'</span> <span class="token punctuation">.</span> <span class="token function">route</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'post.show'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token variable">$id</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>直接访问<code>http://blog.test/post/1</code>,得到</p> <div class="language-txt line-numbers-mode"><pre class="language-text"><code>Post1Linkhttp://blog.test/post/1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="路由进阶"><a href="#路由进阶" class="header-anchor">#</a> 路由进阶</h3> <h4 id="路由模型绑定"><a href="#路由模型绑定" class="header-anchor">#</a> 路由模型绑定</h4> <p>定义特殊参数名告知路由解析器根据给定资源 ID 查询模型,并将查询结果作为参数传入.</p> <p><strong>隐式绑定</strong></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'task/{task}'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>\<span class="token package">App<span class="token punctuation">\</span>Models<span class="token punctuation">\</span>Task</span> <span class="token variable">$task</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">dd</span><span class="token punctuation">(</span><span class="token variable">$task</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>路由参数与方法参数一样,且约定<code>\App\Model\Task</code>类型的<code>$task</code>,该路由就会被识别为路由模型绑定.</p> <p>路由绑定默认将传入的<code>{task}</code>参数值作为模型主键 ID 进行查询,可通过在模型类中重写<code>getRouteKeyName()</code>来实现自定义查询字段.</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Models</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Database<span class="token punctuation">\</span>Eloquent<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Task</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getRouteKeyName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token single-quoted-string string">'name'</span><span class="token punctuation">;</span>  <span class="token comment">// 以任务名称作为路由模型绑定查询字段</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>显式绑定</strong></p> <p>显式绑定需要手动配置路由模型绑定，通常需要在 <code>App\Providers\RouteServiceProvider</code> 的 <code>boot()</code> 方法中新增如下这段配置代码：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 显式路由模型绑定</span>
    Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'task_model'</span><span class="token punctuation">,</span> Task<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">parent</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>编写完这段代码后，以后每次访问包含 <code>{task_model}</code> 参数的路由时，路由解析器都会从请求 URL 中解析出模型 ID ，然后从对应模型类 <code>Task</code> 中获取相应的模型实例并传递给闭包函数或控制器方法：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'task/model/{task_model}'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>\<span class="token package">App<span class="token punctuation">\</span>Models<span class="token punctuation">\</span>Task</span> <span class="token variable">$task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">dd</span><span class="token punctuation">(</span><span class="token variable">$task</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>由于在正式开发中，出于性能的考虑通常会对模型数据进行缓存，此外在很多情况下，需要关联查询才能得到我们需要的结果，所以并不建议过多使用这种路由模型绑定。</p> <h4 id="兜底路由"><a href="#兜底路由" class="header-anchor">#</a> 兜底路由</h4> <p>用于访问路由不存在时的处理逻辑,相当于 <code>*</code>任意路由(不使用兜底路由默认将返回 404)</p> <p>使用兜底路由的好处是我们可以对这类请求进行统计并进行一些自定义的操作，比如重定向，或者一些友好的提示什么的，兜底路由可以通过 <code>Route::fallback</code> 来定义：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">fallback</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token single-quoted-string string">'我是最后的屏障'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="访问频率"><a href="#访问频率" class="header-anchor">#</a> 访问频率</h4> <p>可设计限制用户失败尝试次数减少爬虫的频繁访问，流量高峰期限流</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'throttle:60,1'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 一分钟能只能访问路由分组的内路由（如 /user）60 次</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'throttle:rate_limit,1'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过被访问路由涉及到的模型定义属性(rate_limit)来动态定义路由的访问限制频率</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>路由缓存提升性能不大,且牺牲了闭包路由,得不偿失</strong></p> <h3 id="表单方法伪造-csrf-保护"><a href="#表单方法伪造-csrf-保护" class="header-anchor">#</a> 表单方法伪造 CSRF 保护</h3> <ul><li>OPTIONS：允许客户端查看服务器的性能。这个方法会请求服务器返回该资源所支持的所有 HTTP 请求方法，该方法会用'*'来代替资源名称，向服务器发送 OPTIONS 请求，可以测试服务器功能是否正常。JavaScript 的 XMLHttpRequest 对象进行 CORS 跨域资源共享时，就是使用 OPTIONS 方法发送嗅探请求，以判断是否有对指定资源的访问权限。</li> <li>GET：请求指定的页面信息，并返回响应实体。一般来说 GET 方法应该只用于数据的读取，而不应当用于会产生副作用的非幂等的操作中。</li> <li>HEAD：与 GET 方法一样，都是向服务器发出指定资源的请求，但是服务器在响应 HEAD 请求时不会回传资源的内容部分（即响应实体），这样我们在不传输全部内容的情况下，就可以获取服务器的响应头信息。HEAD 方法常被用于客户端查看服务器的性能。</li> <li>POST：向指定资源提交数据，请求服务器进行处理，如：表单数据提交、文件上传等，请求数据包含在请求体中。POST 方法是非幂等的方法，因为这个请求可能会创建新的资源或修改现有资源。</li> <li>PUT：向指定资源位置上传其最新内容，PUT 方法是幂等的方法。通过该方法客户端可以将指定资源的最新数据传送给服务器取代指定的资源的内容，常用于修改指定资源。</li> <li>DELETE：请求服务器删除所请求 URI 所标识的资源。DELETE 请求后指定资源会被删除，DELETE 方法也是幂等的。</li> <li>TRACE：请求服务器回显其收到的请求信息，该方法主要用于 HTTP 请求的测试或诊断。</li> <li>CONNECT：该方法是 HTTP/1.1 协议预留的，能够将连接改为管道方式的代理服务器。通常用于 SSL 加密服务器的链接与非加密的 HTTP 代理服务器的通信。</li> <li>PATCH：出现的较晚，它在 2010 年的 RFC 5789 标准中被定义。PATCH 请求与 PUT 请求类似，同样用于资源的更新。二者有以下两点不同：1、PATCH 一般用于资源的部分更新，而 PUT 一般用于资源的整体更新；2、当资源不存在时，PATCH 会创建一个新的资源，而 PUT 只会对已在资源进行更新。</li></ul> <p><strong>表单方法伪造</strong></p> <div class="language-php+HTML line-numbers-mode"><pre class="language-text"><code>&lt;form action=&quot;/task/1&quot; method=&quot;POST&quot;&gt;
    &lt;input type=&quot;hidden&quot; name=&quot;_method&quot; value=&quot;DELETE&quot;&gt;
&lt;/form&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>该请求将被识别为<code>Route:delete</code>路由,HTML 表单仅支持<code>GET/POST</code>请求</p> <p><strong>CSRF 保护</strong></p> <p>为了安全考虑，Laravel 期望所有路由都是「只读」操作的（对应请求方式是 GET、HEAD、OPTIONS），如果路由执行的是「写入」操作（对应请求方式是 POST、PUT、PATCH、DELETE），则需要传入一个隐藏的 Token 字段（<code>_token</code>）以避免[跨站请求伪造攻击]（CSRF）</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'task/{id}/delete'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token single-quoted-string string">'&lt;form method=&quot;post&quot; action=&quot;'</span> <span class="token punctuation">.</span> <span class="token function">route</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'task.delete'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token variable">$id</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'&quot;&gt;
	&lt;input type=&quot;hidden&quot; name=&quot;_method&quot; value=&quot;DELETE&quot;&gt;
	&lt;button type=&quot;submit&quot;&gt;删除任务&lt;/button&gt;
&lt;/form&gt;'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'task/{id}'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token single-quoted-string string">'Delete Task'</span> <span class="token punctuation">.</span> <span class="token variable">$id</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'task.delete'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>排除指定 URL 不做 CSRF 保护</strong></p> <p>对于应用中某些第三方回调路由，如第三方登录或支付回调，无法做 Token 校验，需要将这些授信路由排除在 CSRF 校验之外</p> <h2 id="view-blade-tpl"><a href="#view-blade-tpl" class="header-anchor">#</a> view &amp; blade tpl</h2> <h3 id="view"><a href="#view" class="header-anchor">#</a> view</h3> <p>视图文件位于<code>resources/views</code>目录下,多级目录以<code>.</code>分隔,且引用文件不带后缀</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// resources/views/user/profile.blade.php</span>
Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'user/{id}'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'user.profile'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'id'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$id</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'user.profile'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="视图与参数"><a href="#视图与参数" class="header-anchor">#</a> 视图与参数</h4> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">return</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'home'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'tasks'</span><span class="token operator">=</span><span class="token operator">&gt;</span>Task<span class="token punctuation">:</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 推荐</span>
<span class="token keyword">return</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'home'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'tasks'</span><span class="token punctuation">,</span>Task<span class="token punctuation">:</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="视图共享变量"><a href="#视图共享变量" class="header-anchor">#</a> 视图共享变量</h4> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token function">view</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">share</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Name'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'jojo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 然后就可以在任何视图文件中访问共享变量.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="blade-模板"><a href="#blade-模板" class="header-anchor">#</a> Blade 模板</h3> <ol><li><code>\{\{ \}\}</code> 这种占位符下的输出内容会被<code>htmlentities</code>进行 HTML 字符转义(可避免 XSS)</li> <li><code>\{\{!! !!\}\}</code> 不转义直接输出</li> <li><code>@</code> 逻辑控制</li> <li><code>@\{\{ \}\}</code>编译时移除<code>@</code>,保留双花括弧,方便兼容类似<code>vue</code>的语法</li> <li><code>\{\{-- 注释 --\}\}</code></li></ol> <h4 id="控制语句"><a href="#控制语句" class="header-anchor">#</a> 控制语句</h4> <p><strong>@if、@else、@elseif</strong></p> <p>Blade 模板中的 <code>@if</code> 等价于 PHP 的 <code>&lt;?php if ($condition):</code>，<code>@else</code> 和 <code>@elseif</code> 依次类推，最后以一个 <code>@endif</code>收尾：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@if (count($students) === 1)
    操场上只有一个同学
@elseif (count($students) === 0)
    操场上一个同学也没有
@else
    操场上有 \{\{ count($students) \}\} 个同学
@endif
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>和原生 PHP 中的用法如出一辙。</p> <p><strong>@unless</strong></p> <p><code>@unless</code> 是 Blade 提供的一个 PHP 中没有的语法，用于表示和 <code>@if</code> 条件相反的条件，<code>@unless($condition)</code> 可以理解为 <code>&lt;?php if (!$condition):</code>，然后以 <code>@endunless</code> 收尾：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@unless ($user-&gt;hasPaid())
    用户没有支付
@endunless
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>@isset、@empty</strong></p> <p>这两个指令和 PHP 中的 <code>isset()</code> 和 <code>empty()</code> 方法等价：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@isset($records)
    // 记录被设置
@endisset

@empty($records)
    // 记录为空
@endempty
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>后面两个都是语法糖，如果你不想记太多东西，不防都用 <code>@if</code> 来实现对应的逻辑了。</p> <p><strong>@switch</strong></p> <p>顾名思义，Blade 中的 <code>@switch</code> 指令和 PHP 中的 <code>switch</code> 语句等价，我们可以通过 <code>@switch</code>、<code>@case</code>、<code>@break</code>、<code>@default</code> 和 <code>@endswitch</code> 指令构建对应逻辑：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@switch($i)
    @case(1)
        // $i = 1 做什么
        @break

    @case(2)
        // $i = 2 做什么
        @break

    @default
        // 默认情况下做什么
@endswitch
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="循环结构"><a href="#循环结构" class="header-anchor">#</a> 循环结构</h4> <p><strong>@for、@foreach 和 @while</strong></p> <p>和 PHP 一样，在 Laravel 中，我们可以通过与之等价的 <code>@for</code>、<code>@foreach</code> 和 <code>@while</code> 实现循环控制结构，使用语法和 PHP 代码相仿：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// for 循环
@for ($i = 0; $i &lt; $talk-&gt;slotsCount(); $i++)
    The number is \{\{ $i \}\}&lt;br&gt;
@endfor

// foreach 循环
@foreach ($talks as $talk)
    \{\{ $talk-&gt;title \}\} (\{\{ $talk-&gt;length \}\} 分钟)&lt;br&gt;
@endforeach

// while 循环
@while ($item = array_pop($items))
    \{\{ $item-&gt;orSomething() \}\}&lt;br&gt;
@endwhile
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>@forelse</strong></p> <p>这个指令是 PHP 中具备的，可以理解为处理以下 PHP 代码逻辑：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;?php
if ($students) {
    foreach ($students as $student) {
       // do something ...
    }
} else {
    // do something else ...
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在 Blade 模板中我们可以使用 <code>@forelse</code> 指令通过以下代码实现上述逻辑：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@forelse ($students as $student)
    // do something ...
@empty
    // do something else ...
@endforelse
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>@foreach 和 @forelse 中的 $loop 变量</strong></p> <p>在循环控制结构中，我们要重磅介绍的就是 Blade 模板为 <code>@foreach</code> 和 <code>@forelse</code> 循环结构提供的 <code>$loop</code> 变量了，通过该变量，我们可以在循环体中轻松访问该循环体的很多信息，而不用自己编写那些恼人的面条式代码，比如当前迭代索引、嵌套层级、元素总量、当前索引在循环中的位置等，<code>$loop</code> 实例上有以下属性可以直接访问：</p> <p><img src="http://yanxuan.nosdn.127.net/1aac33a7da4d1abeca7948df16852925.png" alt="UTOOLS1568112412512.png"></p> <p>下面是一个简单的使用示例：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;ul&gt;
@foreach ($pages as $page)
    @if ($loop-&gt;first)
        // 第一个循环迭代
    @endif
    &lt;li&gt;\{\{ $loop-&gt;iteration \}\}: \{\{ $page-&gt;title \}\}
        @if ($page-&gt;hasChildren())
        &lt;ul&gt; @foreach ($page-&gt;children() as $child)
            &lt;li&gt;\{\{ $loop-&gt;parent-&gt;iteration \}\}. \{\{ $loop-&gt;iteration \}\}: \{\{ $child-&gt;title \}\}&lt;/li&gt;
            @endforeach
        &lt;/ul&gt;
        @endif
    &lt;/li&gt;
    @if ($loop-&gt;last)
        // 最后一个循环迭代
    @endif
@endforeach
&lt;/ul&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="模板继承-组件引入"><a href="#模板继承-组件引入" class="header-anchor">#</a> 模板继承 &amp; 组件引入</h3> <h4 id="yield-section-show"><a href="#yield-section-show" class="header-anchor">#</a> @yield @section/@show</h4> <p>模板 master</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> resources<span class="token operator">/</span>views<span class="token operator">/</span>template<span class="token operator">/</span>tpl<span class="token punctuation">.</span>blade<span class="token punctuation">.</span>php <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token double-quoted-string string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token double-quoted-string string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token double-quoted-string string">&quot;viewport&quot;</span> content<span class="token operator">=</span><span class="token double-quoted-string string">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>meta http<span class="token operator">-</span>equiv<span class="token operator">=</span><span class="token double-quoted-string string">&quot;X-UA-Compatible&quot;</span> content<span class="token operator">=</span><span class="token double-quoted-string string">&quot;ie=edge&quot;</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> \@<span class="token keyword">yield</span> 指定需要子视图继承实现的内容区<span class="token punctuation">,</span>第二参数为子视图未实现时的默认值 <span class="token operator">--</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>模板master <span class="token operator">|</span> @<span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'title'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'首页'</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token double-quoted-string string">&quot;contaienr&quot;</span><span class="token operator">&gt;</span>
		@<span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'content'</span><span class="token punctuation">)</span>
	<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
	@<span class="token function">section</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'masterFooter'</span><span class="token punctuation">)</span>
	<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> \@section<span class="token operator">/</span>\@show也用于指定子视图需要继承实现的内容区块<span class="token punctuation">,</span>也提供默认区块内容 <span class="token operator">--</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> \@section<span class="token operator">/</span>\@show 指定的默认子视图可通过 \@<span class="token keyword">parent</span>访问 \@<span class="token keyword">yield</span> 的默认内容对子视图不可见 <span class="token operator">--</span><span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token double-quoted-string string">&quot;footer&quot;</span><span class="token operator">&gt;</span>
			master footer
		<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
	@show
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h4 id="extends-section-endsection"><a href="#extends-section-endsection" class="header-anchor">#</a> @extends @section/@endsection</h4> <p>子模板 testTpl</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> resources<span class="token operator">/</span>views<span class="token operator">/</span>testTpl<span class="token punctuation">.</span>blade<span class="token punctuation">.</span>php <span class="token operator">--</span><span class="token operator">&gt;</span>
@<span class="token keyword">extends</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'template.tpl'</span><span class="token punctuation">)</span> <span class="token comment">// 指定被继承模板 目录以 . 分隔,模板文件需要位于 resources/views 中</span>

@<span class="token function">section</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'title'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'testTpl'</span><span class="token punctuation">)</span> <span class="token comment">// 简单的区块内容可以以第二参数形式传入</span>

@<span class="token function">section</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'content'</span><span class="token punctuation">)</span>
	testTpl container<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">content</span>
@endsection

@<span class="token function">section</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'masterFooter'</span><span class="token punctuation">)</span>
	@<span class="token keyword">parent</span>
	testTpl Footer
@endsection

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="include"><a href="#include" class="header-anchor">#</a> @include</h4> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> resources<span class="token operator">/</span>views<span class="token operator">/</span>login<span class="token operator">-</span>btn<span class="token punctuation">.</span>blade<span class="token punctuation">.</span>php <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>a <span class="token keyword">class</span><span class="token operator">=</span><span class="token double-quoted-string string">&quot;login-btn&quot;</span> <span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>i <span class="token keyword">class</span><span class="token operator">=</span><span class="token double-quoted-string string">&quot;exclamation-icon&quot;</span><span class="token operator">&gt;</span>\<span class="token punctuation">{</span>\<span class="token punctuation">{</span> <span class="token variable">$text</span> \<span class="token punctuation">}</span>\<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>i<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>导入组件并传参,视图中的被导入组件可引用视图中的变量,但是不推荐,因为被多个视图引用容易引起混乱</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>@<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'template.login-btn'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'text'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'组件按钮'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="each"><a href="#each" class="header-anchor">#</a> @each</h4> <div class="language-php+HTML line-numbers-mode"><pre class="language-text"><code>&lt;!-- resources/views/sidebar.blade.php --&gt;
&lt;div class=&quot;sidebar&quot;&gt;
    @each('partials.module', $modules, 'module', 'partials.empty-module')
&lt;/div&gt;

&lt;!-- resources/views/partials/module.blade.php --&gt;
&lt;div class=&quot;sidebar-module&quot;&gt;
    &lt;h1&gt;\{\{ $module-&gt;title \}\}&lt;/h1&gt;
&lt;/div&gt;

&lt;!-- resources/views/partials/empty-module.blade.php --&gt;
&lt;div class=&quot;sidebar-module&quot;&gt;
    No modules :(
&lt;/div&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><code>@each</code> 指令支持多个参数，第一个参数用于指定要循环引入的组件名，第二个参数是要遍历的集合变量，第三个参数是在引入组件中使用的变量名（对应 <code>$modules</code> 集合中单个元素），最后一个参数是集合数据为空时引入的默认组件</p> <h4 id="slot-component"><a href="#slot-component" class="header-anchor">#</a> @slot @component</h4> <p>和<code>vue</code>的插槽一样</p> <div class="language-php+HTML line-numbers-mode"><pre class="language-text"><code>&lt;!-- /resources/views/alert.blade.php --&gt;
&lt;div class=&quot;alert alert-danger&quot;&gt;
    &lt;h1&gt;
        \{\{$title\}\}
    &lt;/h1&gt;
    \{\{ $slot \}\}
&lt;/div&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>通过<code>@component</code></p> <div class="language-php+HTML line-numbers-mode"><pre class="language-text"><code>@component('alert',[
	'title'=&gt;$title
])
    &lt;strong&gt;哎呦!&lt;/strong&gt; 出错啦!
@endcomponent
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="view-composer"><a href="#view-composer" class="header-anchor">#</a> View Composer</h4> <p>由于单个组件可能在多个视图中引入,不可能为每个视图都传输一边组件需要的数据,遵循相同即为冗余(rong yu)的原则</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token function">view</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">composer</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'partials.siderbar'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$view</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$view</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">,</span>Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">recent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 通过数组指定多个视图组件</span>
<span class="token function">view</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">composer</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'partials.header'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'partials.footer'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$view</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$view</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">,</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">recent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 通过通配符指定多个视图组件</span>
<span class="token function">view</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">composer</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'partials.*'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$view</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$view</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">,</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">recent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>或者通过自定义类实现更加灵活的<a href="https://laravelacademy.org/post/9664.html" target="_blank" rel="noopener noreferrer">数据预设<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h4 id="视图注入"><a href="#视图注入" class="header-anchor">#</a> 视图注入</h4> <p>通过服务注入指令<code>@inject</code>在视图模板中注入服务,和<code>view composer</code>一样都是为了避免重复传值</p> <div class="language-php+HTML line-numbers-mode"><pre class="language-text"><code>@inject('analytics','App\Services\Anlytics')
&lt;div&gt;
    \{\{ $analytics-&gt;getData() \}\}
&lt;/div&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>其原理就是将注册到服务容器中的服务解析出来，然后就可以调用该服务提供的方法：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$analytics</span> <span class="token operator">=</span> <span class="token function">app</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'App\Services\Analytics'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>但是不推荐视图与业务逻辑混用</p> <h4 id="自定义-blade-指令"><a href="#自定义-blade-指令" class="header-anchor">#</a> 自定义 blade 指令</h4> <p>和 View Composer 一样，需要在 <code>AppServiceProvider</code> 的 <code>boot</code> 方法中注册这个指令</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>Blade::directive('datetime', function($expression) {
    return &quot;<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token punctuation">(</span><span class="token variable">$expression</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Y/m/d H:i:s'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?&gt;</span></span>&quot;;
});
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>第一个参数是方法名，第二个参数是一个闭包函数，用于定义指定实现逻辑。这样，我们就可以在视图模板中通过 <code>@datetime($time)</code> 指令统一显示指定格式的日期时间了。</p> <blockquote><p>注：更新完 Blade 指令逻辑后，必须删除所有的 Blade 缓存视图指令才能生效。缓存的 Blade 视图可以通过 Artisan 命令 <code>view:clear</code> 移除。</p></blockquote> <h2 id="laravel-前端"><a href="#laravel-前端" class="header-anchor">#</a> Laravel 前端</h2> <p>Laravel 集成了 vue 开发环境</p> <p>在入口 blade 文件中添加 vue 入口文件</p> <div class="language-php+html line-numbers-mode"><pre class="language-text"><code>&lt;!-- csrf 是必须的 --&gt;
&lt;meta name=&quot;csrf-token&quot; content=&quot;\{\{ csrf_token() \}\}&quot;&gt;
&lt;div id=&quot;app&quot;&gt;
	&lt;example-component&gt;&lt;/example-component&gt;
&lt;/div&gt;
&lt;script src=&quot;js/app.js&quot;&gt;&lt;/script&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>此外 Laravel 添加了一些基本的工具,在 axios 中也默认添加了<code>X-CSRF-TKEN</code>请求头.</p> <p><img src="https://user-gold-cdn.xitu.io/2019/9/4/16cfab6e22587ab3?w=898&amp;h=150&amp;f=png&amp;s=25759" alt="UTOOLS1567574380715.png"></p> <p>Laravel vue 支持 sass 语法(奇葩的是 laravel 并不支持 vue 组件的全局 scss 导入),你只能通过以下方式导入.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//  webpack.mix.js</span>
mix
  <span class="token punctuation">.</span><span class="token function">js</span><span class="token punctuation">(</span><span class="token string">&quot;resources/js/app.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;public/js&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token string">&quot;resources/sass/app.scss&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;public/css&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">webpackConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    resolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      alias<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;@&quot;</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;resources/sass&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-scss line-numbers-mode"><pre class="language-scss"><code><span class="token comment">// 组件</span>
<span class="token keyword">@import</span> <span class="token string">&quot;~@/_variables.scss&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>!参考<a href="https://github.com/JeffreyWay/laravel-mix/issues/2050" target="_blank" rel="noopener noreferrer">Issues 共享全局变量<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <h3 id="copy"><a href="#copy" class="header-anchor">#</a> copy</h3> <p><code>mix</code>提供<code>copy</code>方法,但是在拷贝目录时<code>copy</code>方法会铺平目录结构,要维持原目录结构,需要使用<code>copyDireactory</code>方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>mix<span class="token punctuation">.</span><span class="token function">copyDirectory</span><span class="token punctuation">(</span><span class="token string">&quot;assets/img&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;public/img&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="version"><a href="#version" class="header-anchor">#</a> version()</h3> <p><code>mix</code> 提供 <code>version</code>方法附加唯一哈希到文件名,实现缓存刷新 <code>mix.version()</code></p> <h2 id="请求"><a href="#请求" class="header-anchor">#</a> 请求</h2> <p>通过注入道控制器方法中的<code>Illuminate\Http\Request</code>对象实例,</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// app/Http/Controlllers/RequestController.php</span>
<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Controllers</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">RequestController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span><span class="token punctuation">{</span>

	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">form</span><span class="token punctuation">(</span>Request <span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>可通过<code>$request-&gt;all()</code>获取所有的请求数据</p> <p>通过<code>$request-&gt;except('id')</code>排除指定字段</p> <p>通过<code>$request-&gt;only(['id','site'])</code>获取指定字段</p> <p>使用<code>has</code>或<code>exists</code>判断某个字段是否存在<code>$id =$request-&gt;has('id')?$request-&gt;get('id') : 0</code>,使用<code>get</code>方法获取字段的值,如果是<code>post</code>方法就使用<code>post</code>获取值 ; <code>input</code>方法可以从所有请求方式中获取值 ;</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$site</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'site'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'aaa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第二参数为默认值,当参数site值为空</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>获取数组的值</strong></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'arr.0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 下标</span>
<span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'arr.0.id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 深度取值</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>控制器中获取路由参数</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>Rooute<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'form/{id}'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'RequestController@form'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 路由参数需要放在注入参数后面</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">form</span><span class="token punctuation">(</span>Request <span class="token variable">$request</span><span class="token punctuation">,</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>使用<code>$request-&gt;segment()</code>方法获取<code>$id</code></p> <h3 id="文件上传"><a href="#文件上传" class="header-anchor">#</a> 文件上传</h3> <p><code>$request-&gt;file()</code>将获取一个<code>Illuminate\Http\UploadFile</code>对象实例</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Controllers</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Facades<span class="token punctuation">\</span>Storage</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">RequestController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span><span class="token punctuation">{</span>

	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">formPage</span><span class="token punctuation">(</span>Request <span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'form'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">fileUpload</span><span class="token punctuation">(</span>Request <span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'picture'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token comment">// dd($request-&gt;file('picture'));</span>
			<span class="token variable">$picture</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'picture'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$picture</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token function">abort</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'无效上传文件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 文件扩展名</span>
			<span class="token variable">$extension</span> <span class="token operator">=</span> <span class="token variable">$picture</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getClientOriginalExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 文件名</span>
			<span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token variable">$picture</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//</span>
			<span class="token variable">$new_file_name</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$filename</span> <span class="token punctuation">.</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'.'</span> <span class="token punctuation">.</span> <span class="token variable">$extension</span><span class="token punctuation">;</span>
			<span class="token comment">// 图片保存路径</span>
			<span class="token variable">$save_path</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'images/'</span> <span class="token punctuation">.</span> <span class="token variable">$new_file_name</span><span class="token punctuation">;</span>
			<span class="token comment">// web访问路径</span>
			<span class="token variable">$web_path</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'/storage/'</span> <span class="token punctuation">.</span> <span class="token variable">$save_path</span><span class="token punctuation">;</span>
			<span class="token comment">// 将文件保存在 storage/app/public/images 下,先判断文件是否存在,如果存在直接返回</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>Storage<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">disk</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'public'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token variable">$save_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'path'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$web_path</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$picture</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">storePubliclyAs</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'images'</span><span class="token punctuation">,</span><span class="token variable">$new_file_name</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'disk'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'public'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'path'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$web_path</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">abort</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'文件上传失败'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
			<span class="token function">abort</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'请选择要上传的文件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>关于<code>Storage::disk()</code>,磁盘的配置可在<code>config/filesystems.php</code>查看</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'default'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'FILESYSTEM_DRIVER'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'local'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token single-quoted-string string">'cloud'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'FILESYSTEM_CLOUD'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'s3'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token single-quoted-string string">'disks'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>

        <span class="token single-quoted-string string">'local'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
            <span class="token single-quoted-string string">'driver'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'local'</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'root'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">storage_path</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'app'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token single-quoted-string string">'public'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
            <span class="token single-quoted-string string">'driver'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'local'</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'root'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">storage_path</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'app/public'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'url'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'APP_URL'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token single-quoted-string string">'/storage'</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'visibility'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'public'</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token single-quoted-string string">'s3'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
            <span class="token single-quoted-string string">'driver'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'s3'</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'key'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'AWS_ACCESS_KEY_ID'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'secret'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'AWS_SECRET_ACCESS_KEY'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'region'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'AWS_DEFAULT_REGION'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'bucket'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'AWS_BUCKET'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'url'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'AWS_URL'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>让上传到<code>storage/app/public</code>目录的文件可被外部访问需要执行<code>php artisan storage:link</code></p> <p>该命令会在项目根目录下的 <code>public</code> 中创建一个软链 <code>storage</code> 指向 <code>storage/app/public</code></p> <p><a href="https://laravelacademy.org/post/3585.html" target="_blank" rel="noopener noreferrer">Intervention Image<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>图片处理扩展包</p> <h3 id="表单验证"><a href="#表单验证" class="header-anchor">#</a> 表单验证</h3> <p>表单验证基于<code>ValidatesRequest</code>Trait 中的<code>validate()</code>方法</p> <p><a href="https://laravelacademy.org/post/9547.html#toc_17" target="_blank" rel="noopener noreferrer">表单验证规则大全<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">form</span><span class="token punctuation">(</span>Request <span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span><span class="token punctuation">[</span>
			<span class="token single-quoted-string string">'title'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'bail|required|string|between:2,32'</span><span class="token punctuation">,</span>
			<span class="token single-quoted-string string">'url'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'sometimes|url|max:200'</span><span class="token punctuation">,</span>
			<span class="token single-quoted-string string">'picture'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'nullable|string'</span>
		<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>
			<span class="token single-quoted-string string">'title.required'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'标题不为空'</span><span class="token punctuation">,</span>
			<span class="token single-quoted-string string">'title.string'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'标题必须是字符串'</span>
		<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'表单验证通过'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>通常对于表单请求验证失败时,页面会被重定向到原页面,可通过<code>$errors</code>获取错误信息</p> <p>如果是<code>ajax</code>,就处理 422 错误码</p> <p>如果控制器没有实现<code>ValidatesRequest</code>Trait 的话需要使用门面实现验证.</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">form</span><span class="token punctuation">(</span>Request <span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> Validator<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span><span class="token punctuation">[</span>
			<span class="token single-quoted-string string">'title'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'bail|required|string|between:2,32'</span><span class="token punctuation">,</span>
			<span class="token single-quoted-string string">'url'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'sometimes|url|max:200'</span><span class="token punctuation">,</span>
			<span class="token single-quoted-string string">'picture'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'nullable|string'</span>
		<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>
			<span class="token single-quoted-string string">'title.required'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'标题不为空'</span><span class="token punctuation">,</span>
			<span class="token single-quoted-string string">'title.string'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'标题必须是字符串'</span>
		<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'表单验证通过'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>通过<code>ValidatesRequest</code>的<code>make</code>方法最后在结尾调用<code>validate</code>方法,这样就可以在任意地方实现表单验证</p> <h3 id="表单请求类"><a href="#表单请求类" class="header-anchor">#</a> 表单请求类</h3> <p>在<code>app/Http/Requests</code>目录新增<code>SubmitFormRequest.php</code>文件</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan make:request SubmitFormRequest
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>authorize()</code>方法用于验证用户权限,返回<code>false</code>表示拥护无权提交表单(抛出权限异常终止请求),这里改为<code>true</code>接收用户表单验证;在<code>rules()</code>方法中定义验证规则</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">rules</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token punctuation">[</span>
			<span class="token single-quoted-string string">'title'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'bail|required|string|between:2,32'</span><span class="token punctuation">,</span>
			<span class="token single-quoted-string string">'url'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'sometimes|url|max:200'</span><span class="token punctuation">,</span>
			<span class="token single-quoted-string string">'picture'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'nullable|string'</span>
		<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 重写父类message方法实现错误消息自定义</span>
	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">messages</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token punctuation">[</span>
			<span class="token single-quoted-string string">'title.required'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'标题字段不能为空'</span><span class="token punctuation">,</span>
			<span class="token single-quoted-string string">'title.string'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'标题字段仅支持字符串'</span><span class="token punctuation">,</span>
			<span class="token single-quoted-string string">'title.between'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'标题长度必须介于2-32之间'</span><span class="token punctuation">,</span>
			<span class="token single-quoted-string string">'url.url'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'URL格式不正确，请输入有效的URL'</span><span class="token punctuation">,</span>
			<span class="token single-quoted-string string">'url.max'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'URL长度不能超过200'</span><span class="token punctuation">,</span>
		<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>将表单请求字段验证逻辑以类型提示的方式注入到请求路由对应的控制器方法就可以被执行.</p> <p>如果这个请求是一个表单请求类，则会自动执行其中定义的字段验证规则对请求字段进行验证，如果验证成功则继续执行控制器中的方法，否则会抛出验证失败异常.</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>
<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Controllers</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Requests<span class="token punctuation">\</span>SubmitFormRequest</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">RequestController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span><span class="token punctuation">{</span>
	<span class="token comment">//SubmitFormRequest 继承自 FormRequest 继承自 Request 类</span>
    <span class="token comment">// 所以请求参数获取也通过 $request</span>
	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">form</span><span class="token punctuation">(</span>SubmitFormRequest <span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'表单验证通过'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="数组请求验证"><a href="#数组请求验证" class="header-anchor">#</a> 数组请求验证</h3> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token single-quoted-string string">'books'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'required|array'</span><span class="token punctuation">,</span>   <span class="token shell-comment comment"># 验证 books[]</span>
<span class="token single-quoted-string string">'books.author'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'required|max:10'</span><span class="token punctuation">,</span>  <span class="token shell-comment comment"># 验证 books[author]</span>
<span class="token single-quoted-string string">'books.*.author'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'required|max:10'</span><span class="token punctuation">,</span>  <span class="token shell-comment comment"># 验证 books[test][author]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="自定义验证规则"><a href="#自定义验证规则" class="header-anchor">#</a> 自定义验证规则</h3> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">form</span><span class="token punctuation">(</span>Request <span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span><span class="token punctuation">[</span>
			<span class="token single-quoted-string string">'title'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>
				<span class="token single-quoted-string string">'bail'</span><span class="token punctuation">,</span>
				<span class="token single-quoted-string string">'required'</span><span class="token punctuation">,</span>
				<span class="token single-quoted-string string">'string'</span><span class="token punctuation">,</span>
				<span class="token single-quoted-string string">'between:2,32'</span><span class="token punctuation">,</span>
				<span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$attribute</span><span class="token punctuation">,</span><span class="token variable">$value</span><span class="token punctuation">,</span><span class="token variable">$fail</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token comment">/**
					 * $attribute 字段名
					 *  $value 字段值
					 *  $fail 失败的回调函数
					 */</span>
					<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'敏感词'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
						<span class="token keyword">return</span> <span class="token variable">$fail</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'标题包含敏感词'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">]</span>
		<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'表单验证通过'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="创建规则类自定义验证规则"><a href="#创建规则类自定义验证规则" class="header-anchor">#</a> 创建规则类自定义验证规则</h3> <p>在<code>app/Rules</code>创建<code>SensitiveWordRule.php</code>文件</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>php artisan make<span class="token punctuation">:</span>rule SensitiveWordRule
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code>
<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Rules</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Contracts<span class="token punctuation">\</span>Validation<span class="token punctuation">\</span>Rule</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">SensitiveWordRule</span> <span class="token keyword">implements</span> <span class="token class-name">Rule</span>
<span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">passes</span><span class="token punctuation">(</span><span class="token variable">$attribute</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'敏感词'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 字段名会被自动注入 :attribute</span>
        <span class="token keyword">return</span> <span class="token single-quoted-string string">':attribute 输入字段中包含敏感词'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span><span class="token punctuation">[</span>
			<span class="token single-quoted-string string">'title'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>
				<span class="token single-quoted-string string">'bail'</span><span class="token punctuation">,</span>
				<span class="token single-quoted-string string">'required'</span><span class="token punctuation">,</span>
				<span class="token single-quoted-string string">'string'</span><span class="token punctuation">,</span>
				<span class="token single-quoted-string string">'between:2,32'</span><span class="token punctuation">,</span>
				<span class="token keyword">new</span> <span class="token class-name">SensitiveWordRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">]</span>
		<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'表单验证通过'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="artisan"><a href="#artisan" class="header-anchor">#</a> Artisan</h2> <p><code>Artisan</code> 是一个<code>Laravel</code>内置的命令行操作工具集,支持自定义命令</p> <p>根目录下的<code>artisan</code>文件就是命令行交互的入口文件</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan list
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>内置命令</strong></p> <ul><li><code>help</code>：为指定命令提供使用帮助信息，如 <code>php artisan help make:request</code></li> <li><code>clear-compiled</code>：移除编译过的类文件，比如缓存、Blade 视图文件等</li> <li><code>down</code>：将应用切换到维护模式以便查找问题</li> <li><code>up</code>：将应用从维护模式恢复为正常模式</li> <li><code>env</code>：显示应用当前运行环境，如 <code>local</code>、<code>production</code></li> <li><code>migrate</code>：运行所有数据库迁移</li> <li><code>optimize</code>：优化应用以便提供更好的性能</li> <li><code>serve</code>：在本地 <code>localhost:8000</code> 端口启动 PHP 内置服务器</li> <li><code>tinker</code>：进入 Tinker REPL</li> <li><code>dump-server</code>：启动 dump server 收集 <code>dump</code> 信息</li> <li><code>preset</code>：切换应用前端框架脚手架代码，比如从 Vue 切换到 React</li></ul> <p><strong>选项</strong></p> <p>在我们继续介绍 Artisan 命令其它内容之前，我们先来看一下在运行 Artisan 命令时可以传入的选项参数：</p> <ul><li><code>-q</code>：禁止所有输出</li> <li><code>-v</code>、<code>-vv</code>、<code>-vvv</code>：命令执行输出的三个级别，分别代表正常、详细、调试</li> <li><code>--no-interaction</code>：不会问任何交互问题，所以适用于运行无人值守自动处理命令</li> <li><code>--env</code>：允许你指定命令运行的环境</li> <li><code>--version</code>：打印当前 Laravel 版本</li></ul> <p>上述选项可以单独运行，也可以和具体命令一起运行。</p> <p><strong>分组命令</strong></p> <p><code>php artisan list</code> 罗列出的其它命令都是被分门别类的，我们不会详细介绍所有命令，大致看一下分组：</p> <ul><li><code>app</code>：只包含 <code>app:name</code> 命令，用于替换应用默认命名空间 <code>App\</code></li> <li><code>auth</code>：只包含 <code>auth:clear-resets</code>，用于从数据库清除已过期的密码 Token</li> <li><code>cache</code>：应用缓存相关命令</li> <li><code>config</code>：<code>config:cache</code> 用于缓存应用配置，<code>config:clear</code> 用于清除缓存配置</li> <li><code>db</code>：<code>db:seed</code> 用于通过填充器填充数据库（如果编写了填充器的话）</li> <li><code>event</code>：<code>event:generate</code> 用于根据注册信息生成未创建的事件类及监听器类</li> <li><code>key</code>：<code>key:generate</code> 用于手动设置应用的 <code>APP_KEY</code></li> <li><code>make</code>：用于根据模板快速生成应用各种脚手架代码，如认证、模型、控制器、数据库迁移文件等等等，我们会将每个命令穿插在相应教程中介绍</li> <li><code>migrate</code>：数据库迁移相关命令（数据库教程中会详细介绍）</li> <li><code>notifications</code>：<code>notifications:table</code> 用于生成通知表</li> <li><code>optimize</code>：<code>optimize:clear</code> 用于清除缓存的启动文件</li> <li><code>package</code>：<code>package:discover</code> 用于重新构建缓存的扩展包 manifest</li> <li><code>queue</code>：队列相关命令（队列教程中会详细介绍）</li> <li><code>route</code>：路由相关命令，<code>route:cache</code> 和 <code>route:clear</code> 分别用于缓存路由信息和清除路由缓存，<code>route:list</code>用于列出应用所有路由信息</li> <li><code>schedule</code>：调度任务相关命令（调度任务教程中会介绍）</li> <li><code>session</code>： 对于数据库驱动的 Session，我们通过 <code>session:table</code> 生成 <code>sessions</code> 数据表</li> <li><code>storage</code>：<code>storage:link</code> 生成一个软链 <code>public/storage</code> 指向 <code>storage/app/public</code></li> <li><code>vendor</code>：<code>vendor:publish</code> 用于发布扩展包中的公共资源</li> <li><code>view</code>：<code>view:cache</code> 用于编译应用所有 Blade 模板，<code>view:clear</code> 用于清除这些编译文件</li></ul> <h3 id="编写命令"><a href="#编写命令" class="header-anchor">#</a> 编写命令</h3> <p>使用系统自带命令<code>make:command</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan make:command WelcomeMessage --command<span class="token operator">=</span>welcome:message
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>WelcomeMessage</code>为<code>Artisan</code>命令类名,<code>--command</code>自定义该命令名称(不指定系统会根据类名自动生成)</p> <p>创建一个<code>app/Console/Commands/WelcomeMessage.php</code></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Console<span class="token punctuation">\</span>Commands</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Console<span class="token punctuation">\</span>Command</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">WelcomeMessage</span> <span class="token keyword">extends</span> <span class="token class-name">Command</span>
<span class="token punctuation">{</span>
	<span class="token comment">// 命令名</span>
    <span class="token keyword">protected</span> <span class="token variable">$signature</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'welcome:message'</span><span class="token punctuation">;</span>
	<span class="token comment">// 命令名</span>
    <span class="token keyword">protected</span> <span class="token variable">$description</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'Command description'</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">parent</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 命令具体逻辑</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>在<code>App/Console/Kernel.php</code>下注册命令</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">protected</span> <span class="token variable">$commands</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
	App\<span class="token package">Console<span class="token punctuation">\</span>WelcomeMessage</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>routes/console.php</code>也可编写简单的命令</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>Artisan<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'info'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'这是一个 artisan 自定义命令'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">describe</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'自定义命令'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="进阶"><a href="#进阶" class="header-anchor">#</a> 进阶</h3> <p>EXAMPLE</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">protected</span> <span class="token variable">$signature</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'make:migration {name : The name of the migration}
    {--create= : The table to be created}
    {--table= : The table to migrate}
    {--path= : The location where the migration file should be created}
    {--realpath : Indicate any provided migration file paths are pre-resolved absolute paths}'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>要定义一个必填参数，需要用花括号将其包裹起来：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>make:migration {name}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>要定义一个可选参数，可以在参数名称后面加一个问号：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>make:migration {name?}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>要为可选参数定义默认值，可以这么做：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>make<span class="token punctuation">:</span>migration <span class="token punctuation">{</span>name<span class="token operator">=</span>create_users_table<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>选项和参数很像，但是选项有前缀 <code>--</code>，而且可以在没有值的情况下使用，要添加一个最基本的选项，可以通过花括号将其包裹：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>make:migration {name} {--table} // 现在这种写法仅代表命令,不接受值,它产出 1 | ''
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://user-gold-cdn.xitu.io/2019/9/5/16d013def31e9dd0?w=782&amp;h=201&amp;f=png&amp;s=29035" alt="UTOOLS1567683896158.png"></p> <p>如果这个选项必须要设置选项值，可以加上一个 <code>=</code>：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>make<span class="token punctuation">:</span>migration <span class="token punctuation">{</span>name<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">--</span>table<span class="token operator">=</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://user-gold-cdn.xitu.io/2019/9/5/16d01408ae23fd1e?w=787&amp;h=149&amp;f=png&amp;s=31065" alt="UTOOLS1567684066407.png"></p> <p>然后如果你想要为其设置默认选项值，可以这么做：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>make<span class="token punctuation">:</span>migration <span class="token punctuation">{</span>name<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">--</span>table<span class="token operator">=</span>users<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://user-gold-cdn.xitu.io/2019/9/5/16d013f940df658f?w=785&amp;h=162&amp;f=png&amp;s=35452" alt="UTOOLS1567684004378.png"></p> <p>此外，选项还支持缩写，比如我们可以通过 <code>T</code> 来代表 <code>table</code>：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>make:migration {name} {--T|table}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>不管是参数还是选项，如果你想要接收数组作为参数，都要使用 <code>*</code> 通配符：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>make:migration {name*} {--table=*}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>注：数组参数必须是参数列表中的最后一个参数。</p></blockquote> <p>常用的交互:</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
		<span class="token comment">// 文本输入</span>
		<span class="token variable">$name</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">ask</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'你的名字'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 提示</span>
		<span class="token variable">$city</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">anticipate</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'你来自哪个城市'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
			<span class="token double-quoted-string string">&quot;beijin&quot;</span><span class="token punctuation">,</span>
			<span class="token double-quoted-string string">&quot;hangzhou&quot;</span><span class="token punctuation">,</span>
			<span class="token double-quoted-string string">&quot;shenzhen&quot;</span>
		<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 隐藏输入</span>
		<span class="token variable">$password</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">secret</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'输入密码才能执行此命令'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$password</span> <span class="token operator">!=</span> <span class="token single-quoted-string string">'123'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'密码错误'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 确认</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">confirm</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'确定要执行此命令吗?'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 可选和默认值</span>
		<span class="token variable">$city</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">choice</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'你来自哪个城市'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
			<span class="token single-quoted-string string">'北京'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'杭州'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'深圳'</span>
		<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 行信息 白</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">line</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'11'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 注释信息 黄</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'22'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 输出问题 蓝底黑</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">question</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'33'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 输出表格</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'city'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'zhou'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'beijing'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'wang'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'shanghai'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 输出进度条</span>
		<span class="token variable">$totalUnits</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">output</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">progressStart</span><span class="token punctuation">(</span><span class="token variable">$totalUnits</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">++</span> <span class="token operator">&lt;</span> <span class="token variable">$totalUnits</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">output</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">progressAdvance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">output</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">progressFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>在应用代码中可通过<code>Artisan</code>调用命令</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$exit_code</span> <span class="token operator">=</span> Artisan<span class="token punctuation">:</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'welcome:message'</span><span class="token punctuation">,</span><span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'name'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'1'</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'--city'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token number">2</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>如果选项没有值以<code>true | false</code>代替</p> <h2 id="laravel-eloquent"><a href="#laravel-eloquent" class="header-anchor">#</a> Laravel &amp; Eloquent</h2> <h3 id="基本配置"><a href="#基本配置" class="header-anchor">#</a> 基本配置</h3> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token single-quoted-string string">'mysql'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'driver'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'mysql'</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'url'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'OLD_DATABASE_URL'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'host'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'OLD_DB_HOST'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'127.0.0.1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'port'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'OLD_DB_PORT'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'3306'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'database'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'OLD_DATABASE'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'forge'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'username'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'OLD_DB_USERNAME'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'forge'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'password'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'OLD_DB_PASSWORD'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'charset'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'utf8mb4'</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'collation'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'utf8mb4_unicode_ci'</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'prefix'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'prefix_indexes'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean constant">true</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'strict'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean constant">true</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'engine'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token constant">null</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>配置读写分离</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token single-quoted-string string">'mysql'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'driver'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'mysql'</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'read'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'host'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'OLD_DB_READ'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'127.0.0.1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// 读写分离也可单独配置账号</span>
        <span class="token comment">// username ...</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'write'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'host'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'OLD_DB_WRITE'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'127.0.0.1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// 这种配置双host或用户名的较常用于线上或多个数据库</span>
        <span class="token comment">// 本地模拟读写分离只需配置 database =&gt; 就可</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'url'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'OLD_DATABASE_URL'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'port'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'OLD_DB_PORT'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'3306'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'database'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'OLD_DATABASE'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'forge'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'username'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'OLD_DB_USERNAME'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'forge'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'password'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'OLD_DB_PASSWORD'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'charset'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'utf8mb4'</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'collation'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'utf8mb4_unicode_ci'</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'prefix'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'prefix_indexes'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean constant">true</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'strict'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean constant">true</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'engine'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token constant">null</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>读操作较为常用所以可配置多个读配置和主机</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token single-quoted-string string">'read'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'host'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'DB_HOST_READ_1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'DB_HOST_READ_2'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这里还有一个小插曲</p> <p>SCENE 1:</p> <p>新版本的<code>MySql</code>默认使用的连接验证是<code>caching_sha2_password</code>但是我安装的<code>php mysqli</code>扩展并不支持<code>caching_sha2</code>验证,解决方法如下</p> <p><img src="https://user-gold-cdn.xitu.io/2019/9/6/16d052b37951c0e8?w=726&amp;h=207&amp;f=png&amp;s=19330" alt="UTOOLS1567749776847.png"></p> <p>或者你可以启用<code>phpstudy</code>上的 sql 服务,关闭你的<code>laradock sql</code>服务或是修改端口,本质上是<code>laradock sql</code>版本较高无法连接.</p> <p>SCENE 2:</p> <p>在配置完读写分离本地配置后需要运行命令<code>php artisan migrate</code>将数据库迁移应用到写数据库.</p> <p>此时会报错</p> <div class="language-txt line-numbers-mode"><pre class="language-text"><code>SQLSTATE [42000]：语法错误或访问冲突：1071指定密钥太长; 最大密钥长度为767字节（SQL：alter table usersadd unique users_email_unique（email））
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>因为<code>Laravel 5.4</code> 对默认数据库字符集进行更改以便对储存表情符号提供支持,所以旧版<code>MySql</code>数据库会有字节长度超出的错误</p> <p><code>app/Providers/AppServiceProvider.php</code></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">{</span>
     <span class="token comment">// 在 boot 中指定默认字符长度</span>
     Schema<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">defaultStringLength</span><span class="token punctuation">(</span><span class="token number">191</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>接下来执行<code>php artisan migrate</code>就应用迁移了</p> <p><img src="https://user-gold-cdn.xitu.io/2019/9/6/16d059fc85c035c7?w=1037&amp;h=269&amp;f=png&amp;s=201940" alt="UTOOLS1567757416400.png"></p> <h3 id="迁移"><a href="#迁移" class="header-anchor">#</a> 迁移</h3> <p>将数据库操作通过编写代码来定义,这样在任何新环境都可以快速还原表结构.</p> <p>代码驱动的数据表结构定义功能叫做迁移(Migrations),意为在不同环境中快速迁移数据表结构变动</p> <p><code>database/mingrations</code>目录下有迁移文件</p> <blockquote><p>当我们迁移数据库时，系统获取所有数据库迁移文件（包括 <code>database/migrations</code> 目录下和扩展包中注册的），然后按照文件名中包含的日期时间排序，从最早的迁移文件开始，依次执行每个迁移类中的 <code>up</code> 方法，最后完成数据库迁移；反之，当我们回滚数据库时，按照日期时间排序，从最晚的迁移文件开始，依次执行每个迁移类的 <code>down</code> 方法，最后完成数据库回滚，如果指定回滚其中某几步的话，回滚到对应的迁移文件即终止。</p></blockquote> <p><strong>创建迁移文件 create_user_table</strong></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>php artisan make<span class="token punctuation">:</span>migration create_users_table <span class="token operator">--</span>create<span class="token operator">=</span>users  <span class="token shell-comment comment"># 创建数据表迁移</span>
php artisan make<span class="token punctuation">:</span>migration alter_users_add_nickname <span class="token operator">--</span>table<span class="token operator">=</span>users  <span class="token shell-comment comment"># 更新数据表迁移</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    	<span class="token comment">// 此时Schema用的是create方法</span>
        Schema<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>Blueprint <span class="token variable">$table</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 在回调函数中注入表操作</span>
			<span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">increments</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'email'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">unique</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'email_verified_at'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">nullable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">rememberToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">timestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><code>down()</code>函数用于<strong>删除表</strong>,<code>Schema::dropIfExists</code>较<code>Schema::drop</code>方法更好的地方在于,在函数前会判断表存在否</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Schema<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">dropIfExists</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>创建表迁移文件中可以添加表初始字段,但是<strong>修改表需要增量创建迁移文件</strong>.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan make:migration alter_users_add_nickname --table<span class="token operator">=</span>users <span class="token comment"># 新增nickname字段</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Schema<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>Blueprint <span class="token variable">$table</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'nickname'</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">nullable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'用户昵称'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Schema<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>Blueprint <span class="token variable">$table</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">dropColumn</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'nickname'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>修改表字段</strong>需要借助<code>doctrine/dbal</code>扩展包</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>composer require doctrine/dbal
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'nickname'</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 定义完新字段属性后调用change方法执行变更</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="索引和外键"><a href="#索引和外键" class="header-anchor">#</a> 索引和外键</h3> <p>前面我们已经演示了如何创建、删除、修改表字段，接下来我们要讨论如何对表字段设置索引和外键。</p> <p><strong>添加索引</strong></p> <p>对字段设置索引我们已经在 <code>create_users_table</code> 中看到过了：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$table-&gt;string('email')-&gt;unique();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>通过这种调用方式，我们将 <code>email</code> 字段设置为了唯一索引。我们还可以为某个字段设置普通索引：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$table-&gt;string('name')-&gt;index();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>主键索引通过 <code>increments</code> 方法创建，该方法会创建一个自动增长的主键索引：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$table-&gt;increments('id');
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>除了上述这些调用方式外，我们还可以通过另一种方式来为字段创建索引：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$table-&gt;primary('id');
$table-&gt;index('name');
$table-&gt;unique('email');
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这样做的一个好处是一次支持传入多个字段，从而构建混合索引：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$table-&gt;index(['name', 'email']);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>移除索引</strong></p> <p>移除索引也很简单：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$table-&gt;dropIndex('name');
$table-&gt;dropUnique('email');
$table-&gt;dropPrimary('id');
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>添加、移除外键</strong></p> <p>所谓外键指的是一张表的字段 A 引用另一张表的字段 B，那么字段 A 就是外键，通过外键可以建立起两张表之间的关联关系，这样，数据表之间就是有关联的了，而不是一个个孤立的数据集。</p> <p>在迁移类中，如果我们想建立文章表中的 <code>user_id</code> 字段与用户表中的 <code>id</code> 之间的关联关系，可以通过这种方式来定义外键索引来实现：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$table-&gt;foreign('user_id')-&gt;references('id')-&gt;on('users');
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果你还想进一步指定外键约束（级联删除和更新，比如我们删除了 <code>users</code> 表中的某个 <code>id</code> 对应记录，那么其在文章表中对应 <code>user_id</code> 的所有文章会被删除，好危险！），可以通过 <code>onDelete</code> 和 <code>onUpdate</code> 方法来实现：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$table-&gt;foreign('user_id')-&gt;references('id')-&gt;on('users')-&gt;onDelete('cascade');
$table-&gt;foreign('user_id')-&gt;references('id')-&gt;on('users')-&gt;onUpdate('cascade');
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如果你想要删除外键索引，可以通过 <code>dropForeign</code> 方法来实现：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$table-&gt;dropForeign(['user_id']);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>或者通过完整的外键索引名称来删除：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$table-&gt;dropForeign('posts_user_id_foreign');
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>注：不推荐使用外键，更不要使用外键约束功能，因为影响数据库性能，而且级联删除有可能造成非常严重的无法挽回的后果。关联关系我们建议通过业务逻辑代码来实现，比如后面介绍的 Eloquent ORM 专门提供了常见的关联关系方法</p></blockquote> <p><strong>执行迁移</strong></p> <p>执行变更很简单，通过：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>php artisan migrate
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>就可以按照迁移文件生成时间的先后顺序依次执行所有的数据库迁移。</p> <p>回滚要稍微复杂点，Laravel 支持多种形式的回滚，如果只回滚最后一个迁移文件的变更，可以通过：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>php artisan migrate:rollback
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>来实现，如果要回滚多个迁移文件的变更，可以通过 <code>--step=</code> 指定步数（按照迁移文件生成时间逆序执行）：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>php artisan migrate:rollback --step=5
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果是要回滚所有迁移文件的变更，将数据库恢复到初始状态，需要运行以下命令：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>php artisan migrate:reset
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="填充器"><a href="#填充器" class="header-anchor">#</a> 填充器</h3> <p><code>seed</code>填充类位于<code>database/seeds</code>目录</p> <p>Laravel 提供了两种方式来运行填充器：一种是独立的填充命令，另一种是在运行迁移命令时通过指定标识选项在创建数据表时填充。</p> <p>独立的填充命令如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>php artisan db:seed
php artisan db:seed --class=UsersTableSeeder
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>上述第一个 Artisan 命令会以 <code>DatabaseSeeder</code> 为入口类，调用该类的 <code>run</code> 方法，你可以将所有对其他填充器的调用定义在该方法中，例如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$this-&gt;call(UsersTableSeeder::class);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这样，就可以一次性调用所有填充器啦。</p> <p>当然，你也可以通过 <code>--class=</code> 选项指定运行某个填充器类的 <code>run</code> 方法。</p> <p>此外，在某些时候，你可能希望在运行迁移命令的同时填充测试数据，尤其是在初始化一些演示项目的时候。这可以通过不指定值的 <code>--seed</code> 选项来实现：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>php artisan migrate --seed
php artisan migrate:refresh --seed
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>第一条命令用于执行迁移命令时运行填充器类 <code>DatabaseSeeder</code> 填充数据，第二条命令用于回滚所有迁移并重新运行迁移同时填充初始化数据</p> <p><strong>新建填充器类</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan make:seeder UserTableSeeder
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>编写 run 方法</strong></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Database<span class="token punctuation">\</span>Seeder</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Facades<span class="token punctuation">\</span>DB</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">UserTableSeeder</span> <span class="token keyword">extends</span> <span class="token class-name">Seeder</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
		<span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
			<span class="token single-quoted-string string">'name'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token function">str_random</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token single-quoted-string string">'email'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token function">str_random</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'@example.com'</span><span class="token punctuation">,</span>
			<span class="token single-quoted-string string">'password'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token function">bcrypt</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'secret'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan db:seed --class<span class="token operator">=</span>UsersTableSeeder
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可在基类<code>DatabaseSeeder.php</code>中添加</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Database<span class="token punctuation">\</span>Seeder</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">DatabaseSeeder</span> <span class="token keyword">extends</span> <span class="token class-name">Seeder</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">call</span><span class="token punctuation">(</span>UsersTableSeeder<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan db:seed
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="通过模型工厂填充"><a href="#通过模型工厂填充" class="header-anchor">#</a> 通过模型工厂填充</h4> <p><code>database/factories</code></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">// database/factorise/UserFactory.php</span>
<span class="token comment">// 默认的User模型工厂</span>
<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>User</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Str</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Faker<span class="token punctuation">\</span>Generator</span> <span class="token keyword">as</span> Faker<span class="token punctuation">;</span>

<span class="token variable">$factory</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">define</span><span class="token punctuation">(</span>User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>Faker <span class="token variable">$faker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'name'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$faker</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">name</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'email'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$faker</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">unique</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">safeEmail</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'email_verified_at'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'password'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi'</span><span class="token punctuation">,</span> <span class="token comment">// password</span>
        <span class="token single-quoted-string string">'remember_token'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> Str<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><code>Faker</code>类库提供了伪造字段<a href="https://github.com/fzaninotto/Faker" target="_blank" rel="noopener noreferrer">方法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>,
<code>Faker</code>支持中文 <code>config/app.php</code></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token single-quoted-string string">'faker_locale'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'zh_CN'</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// DB::table('users')-&gt;insert([</span>
    <span class="token comment">// 	'name'=&gt;str_random(10),</span>
    <span class="token comment">// 	'email'=&gt;str_random(10) . '@example.com',</span>
    <span class="token comment">// 	'password'=&gt;bcrypt('secret'),</span>
    <span class="token comment">// ]);</span>

    <span class="token function">factory</span><span class="token punctuation">(</span>\<span class="token package">App<span class="token punctuation">\</span>User</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>通过全局的辅助函数<code>factory</code>调用,</p> <p>由于我们在 <code>UserFactory.php</code> 中全局定义了 <code>User</code> 模型的模型工厂，所以在这里只需调用 <code>factory</code> 方法，传入对应模型类和要填充的记录数即可，最后再调用 <code>create</code> 方法让变更生效。</p> <h3 id="crud"><a href="#crud" class="header-anchor">#</a> CRUD</h3> <p>通过 <code>DB</code> 门面提供的 <code>statement</code> 方法执行原生的 SQL Statement 语句，比如创建、删除、修改数据表操作：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">statement</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'drop table `users`'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">statement</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'create table `users` (`id` int(10) unsigned NOT NULL AUTO_INCREMENT,`name` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>查询</strong></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$users</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'select * from `users`'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$name</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'zhou'</span>
<span class="token variable">$users</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'select * from `users` where `name` = ?'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token variable">$name</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$users</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'select * from `users` where `name` = :name'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$name</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>原生插入语句</strong></p> <p>想要在数据库中插入一条记录，通过 <code>DB</code> 门面提供的 <code>insert</code> 语句即可：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$name = str_random(10);
$email = str_random(10) . '@163.com';
$password = bcrypt('secret');
$flag = DB::insert('insert into `users` (`name`, `email`, `password`) values (?, ?, ?)', [$name, $email, $password]);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如果插入成功，返回 <code>true</code>，插入失败，则抛出 <code>QueryException</code> 异常。</p> <p><strong>原生更新语句</strong></p> <p>要修改数据表记录，可以通过 <code>DB</code> 门面提供的 <code>update</code> 方法：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$name = str_random(8);
$id = 8;
$affectedRows = DB::update('update `users` set `name` = ? where id = ?', [$name, $id]);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果更新成功，返回受影响行数，如果更新数据与原记录数据一样，则返回<code>0</code>，如果更新出错，则抛出 <code>QueryException</code> 异常。</p> <p><strong>原生删除语句</strong></p> <p>要删除数据表记录，可以通过 <code>DB</code> 门面的 <code>delete</code> 方法实现：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$id = 8;
$affectedRows = DB::delete('delete from `users` where id = ?', [$id]);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>和更新语句一样，如果删除成功，该方法返回受影响行数，删除记录不存在，返回 <code>0</code>，删除出错，抛出 <code>QueryException</code> 异常。</p> <blockquote><p>友情提示：更新语句和删除语句一定要谨慎注意 <code>where</code> 条件，否则很容器由于疏忽更新了所有数据或删除了所有数据，后果不堪设想！</p></blockquote> <h4 id="构建器-crud"><a href="#构建器-crud" class="header-anchor">#</a> 构建器 CRUD</h4> <p>查询构建器是基于<code>DB</code>门面的，只不过需要调用其提供的 <code>table</code> 方法构建一个基于指定数据表的查询构建器</p> <p><code>$user = DB::table('users')-&gt;get()</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>λ php artisan tinker
Psy Shell v0.9.9 <span class="token punctuation">(</span>PHP <span class="token number">7.2</span>.1 — cli<span class="token punctuation">)</span> by Justin Hileman
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token variable">$user</span> <span class="token operator">=</span> DB::table<span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>-<span class="token operator">&gt;</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> Illuminate<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Collection <span class="token punctuation">{</span>#2970
     all: <span class="token punctuation">[</span>
       <span class="token punctuation">{</span>#2972
         +<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
         +<span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Mr. Ryder Bogan PhD&quot;</span>,
         +<span class="token string">&quot;nickname&quot;</span><span class="token builtin class-name">:</span> null,
         +<span class="token string">&quot;email&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;cartwright.felton@example.org&quot;</span>,
         +<span class="token string">&quot;email_verified_at&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2019-09-06 11:30:19&quot;</span>,
         +<span class="token string">&quot;password&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;<span class="token variable">$2y</span><span class="token variable">$10</span><span class="token variable">$92IXUNpkjO0rOQ5byMi</span>.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi&quot;</span>,
         +<span class="token string">&quot;remember_token&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;7V5VzUq7BA&quot;</span>,
         +<span class="token string">&quot;created_at&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2019-09-06 11:30:19&quot;</span>,
         +<span class="token string">&quot;updated_at&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2019-09-06 11:30:19&quot;</span>,
       <span class="token punctuation">}</span>,
       <span class="token punctuation">{</span>#2974
         +<span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2</span>,
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'Lamont Predovic'</span>
<span class="token variable">$users</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">,</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// []</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>使用查询构建器进行查询，无需手动设置参数绑定来规避 SQL 注入攻击，因为 Laravel 底层会帮助我们自动实现参数绑定，所以推荐使用查询构建器进行数据库操作。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">,</span> <span class="token variable">$name</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// {}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'name'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'email'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">,</span> <span class="token variable">$name</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回指定字段</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>插入记录</strong></p> <p>要通过查询构建器插入一条记录，也很简单，通过 <code>insert</code> 方法即可：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$flag</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'name'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">str_random</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'email'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">str_random</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'@163.com'</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'password'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">bcrypt</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'secret'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>如果想要在插入之后获取对应记录的主键 ID，将 <code>insert</code> 方法改为调用 <code>insertGetId</code> 方法：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$userId</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">insertGetId</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'name'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">str_random</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'email'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">str_random</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'@qq.com'</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'password'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">bcrypt</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'secret'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>查询构建器还支持一次插入多条记录：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">str_random</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'email'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">str_random</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'@qq.com'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'password'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">bcrypt</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'123'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">str_random</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'email'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">str_random</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'@qq.com'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'password'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">bcrypt</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'456'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">str_random</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'email'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">str_random</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'@qq.com'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'password'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">bcrypt</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'789'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>更新记录</strong></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$id</span> <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>
<span class="token variable">$affectedRows</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&gt;'</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">str_random</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>同样，该方法返回的也是受影响行数，具体逻辑和原生更新语句一样，不再赘述，我们可以通过 <code>where</code> 方法来指定过滤条件。</p> <blockquote><p>注：<code>where</code> 方法第二个参数省略的话，默认是 <code>=</code>，如果不是相等条件，需要手动指定该参数值，比如 <code>&gt;</code> 表示大于，<code>&lt;</code> 表示小于，和比较运算符一致。</p></blockquote> <p>如果是数值字段的更新的话，Laravel 还为我们提供了 <code>increment</code> 和 <code>decrement</code> 方法用于快速进行数值增减，默认步长是 <code>1</code>，当然你可以通过第二个参数指定步长值：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'views'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// views+1</span>
<span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'views'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// views+5</span>
<span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">decrement</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'votes'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// votes-1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>删除记录</strong></p> <p>通过查询构建器删除记录可以通过 <code>delete</code> 方法来实现：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$id</span> <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>
<span class="token variable">$affectedRows</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&gt;='</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>同样，我们通过 <code>where</code> 方法指定删除 <code>id &gt;= 11</code> 的记录，<code>delete</code> 方法返回受影响行数，具体逻辑和原生删除语句也是一样的。</p> <p>如果我们想要清空整张数据表，可以通过不指定 where 条件来实现：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$affectedRows</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果我们还想在清空记录之后重置自增 ID，可以通过 <code>truncate</code> 方法来实现：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$affectedRows</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">truncate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="复杂查询语句"><a href="#复杂查询语句" class="header-anchor">#</a> 复杂查询语句</h3> <p>获取返回数据的指定字段</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$name</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'zhou'</span><span class="token punctuation">;</span>
<span class="token variable">$users</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">,</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'email'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>通过<code>exists</code>方法判断某个字段值在数据库中是否存在对应记录
如果存在，返回 true，否则返回 false。该方法还有一个与之相对的方法 doesntExist()。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$users</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">,</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查询并返回以指定字段值为值,以指定字段值为键构建的数组</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$users</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'&lt;'</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">pluck</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [ 1=&gt;'user name' ,2=&gt;'username']</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>单次查询结果集较大,需要分块处理,避免内存泄漏</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$names</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">chunk</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$users</span><span class="token punctuation">)</span> <span class="token keyword">use</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$names</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$users</span> <span class="token keyword">as</span> <span class="token variable">$user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$names</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">name</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>聚合函数</strong></p> <p>在开发后台管理系统时，经常需要对数据进行统计、求和、计算平均值、最小值、最大值等，对应的方法名分别是 count、sum、avg、min、max：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$num</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token shell-comment comment"># 计数     9</span>
<span class="token variable">$sum</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token shell-comment comment"># 求和    45</span>
<span class="token variable">$avg</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token shell-comment comment"># 平均值   5</span>
<span class="token variable">$min</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token shell-comment comment"># 最小值   1</span>
<span class="token variable">$max</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token shell-comment comment"># 最大值   9</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="高级-where-查询"><a href="#高级-where-查询" class="header-anchor">#</a> 高级 where 查询</h4> <p><strong>base</strong></p> <p>第一个参数表示字段名，第二个参数表示运算符（支持 SQL 所有运算符），第三个参数表示比较值。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'views'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token shell-comment comment"># 此处等号可以省略</span>
<span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'views'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'views'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&lt;&gt;'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>like</strong></p> <p>模糊查询</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'title'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'like'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'Laravel%'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>and</strong></p> <p>以多条<code>where</code>的形式表示<code>and</code>查询</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&lt;'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'views'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&lt;'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token single-quoted-string string">'views'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>or</strong></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&lt;'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">orWhere</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'views'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>between</strong>区间查询</p> <p>在一些涉及数字和时间的查询中，BETWEEN 语句可以排上用场，用于获取在指定区间的记录。在查询构建器中，我们可以通过 <code>whereBetween</code> 方法来实现 between 查询：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DB::table('posts')-&gt;whereBetween('views', [10, 100])-&gt;get();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>上述代码表示获取 <code>where view between 10 and 100</code> 的数据库记录。与之相对的还有一个 <code>whereNotBetween</code> 方法，用于获取不在指定区间的数据库记录：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DB::table('posts')-&gt;whereNotBetween('views', [10, 100])-&gt;get();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>对应的 WHERE 条件是 <code>where views not between 10 and 100</code>。</p> <p>你可以看出来 between 语句是可以通过 and/or 查询来替代的，只不过使用 between 语句会更简单明了。</p> <p><strong>in 查询</strong></p> <p>IN 查询也很常见，比如我们需要查询的字段值是某个序列集合的子集的时候。IN 查询可以通过 whereIn 方法来实现：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DB::table('posts')-&gt;whereIn('user_id', [1, 3, 5, 7, 9])-&gt;get();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>对应的 WHERE 子句是 <code>where user_id in (1, 3, 5, 7, 9)</code>。使用该方法时，需要注意传递给 <code>whereIn</code> 的第二个参数不能是空数组，否则会报错。</p> <p>同样，与之相对的，还有一个 <code>whereNotIn</code> 方法，表示与 <code>whereIn</code> 相反的查询条件。将上述代码中的 <code>whereIn</code> 方法改为 <code>whereNotIn</code>，对应的查询子句就是 <code>where user_id not in (1, 3, 5, 7, 9)</code>。</p> <p><strong>null 查询</strong></p> <p>NULL 查询就是判断某个字段是否为空的查询，Laravel 查询构建器为我们提供了 <code>whereNull</code> 方法用于实现该查询：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DB::table('users')-&gt;whereNull('email_verified_at')-&gt;get();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>对应的 WHERE 查询子句是 <code>where email_verified_at is null</code>，同样，该方法也有与之相对的 <code>whereNotNull</code> 方法，例如，要进行 <code>where email_verified_at is not null</code> 查询，可以这么实现：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DB::table('users')-&gt;whereNotNull('email_verified_at')-&gt;get();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>日期查询</strong></p> <p>关于日常查询，查询构建器为我们提供了丰富的方法，从年月日到具体的时间都有覆盖：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DB::table('posts')-&gt;whereYear('created_at', '2018')-&gt;get();   # 年
DB::table('posts')-&gt;whereMonth('created_at', '11')-&gt;get();    # 月
DB::table('posts')-&gt;whereDay('created_at', '28')-&gt;get();      # 一个月的第几天
DB::table('posts')-&gt;whereDate('created_at', '2018-11-28')-&gt;get();  # 具体日期
DB::table('posts')-&gt;whereTime('created_at', '14:00')-&gt;get();  # 时间
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>上面这几个方法同时还支持 <code>orWhereYear</code>、<code>orWhereMonth</code>、<code>orWhereDay</code>、<code>orWhereDate</code>、<code>orWhereTime</code>。</p> <p><strong>字段相等查询</strong></p> <p>有的时候，我们并不是在字段和具体值之间进行比较，而是在字段本身之间进行比较，查询构建器提供了 <code>whereColumn</code> 方法来实现这一查询：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DB::table('posts')-&gt;whereColumn('updated_at', '&gt;', 'created_at')-&gt;get();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>对应的 WHERE 查询子句是 <code>where updated_at &gt; created_at</code>。</p> <p><strong>JSON 查询</strong></p> <p>从 MySQL 5.7 开始，数据库字段原生支持 JSON 类型，对于 JSON 字段的查询，和普通 where 查询并无区别，只是支持对指定 JSON 属性的查询：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DB::table('users')
    -&gt;where('options-&gt;language', 'en')
    -&gt;get();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果属性字段是个数组，还支持通过 <code>whereJsonContains</code> 方法对数组进行包含查询：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DB::table('users')
    -&gt;whereJsonContains('options-&gt;languages', 'en_US')
    -&gt;get();

DB::table('users')
    -&gt;whereJsonContains('options-&gt;languages', ['en_US', 'zh_CN'])
    -&gt;get();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>参数分组</strong></p> <p>除了以上这些常规的 WHERE 查询之外，查询构建器还支持更加复杂的查询语句，考虑下面这个 SQL 语句：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>select * from posts where id &lt;= 10 or (views &gt; 0 and created_at &lt; '2018-11-28 14:00');
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>貌似我们通过前面学到的方法解决不了这个查询语句的构造，所以我们需要引入更复杂的构建方式，那就是引入匿名函数的方式（和连接查询中构建复杂的连接条件类似）：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DB::table('posts')-&gt;where('id', '&lt;=', 10)-&gt;orWhere(function ($query) {
    $query-&gt;where('views', '&gt;', 0)
        -&gt;whereDate('created_at', '&lt;', '2018-11-28')
        -&gt;whereTime('created_at', '&lt;', '14:00');
})-&gt;get();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在这个匿名函数中传入的 <code>$query</code> 变量也是一个查询构建器的实例。这一查询构建方式叫做「参数分组」，在带括号的复杂 WHERE 查询子句中都可以参考这种方式来构建查询语句。</p> <p><strong>WHERE EXISTS</strong></p> <p>此外，我们还可以通过查询构建器提供的 <code>whereExists</code> 方法构建 WHERE EXISTS 查询：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DB::table('users')
    -&gt;whereExists(function ($query) {
        $query-&gt;select(DB::raw(1))
            -&gt;from('posts')
            -&gt;whereRaw('posts.user_id = users.id');
    })
-&gt;get();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>对应的 SQL 语句是：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>select * from `users` where exists (select 1 from `posts` where posts.user_id = users.id);
// 在posts 中找到一个与 users 一致的
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>用于查询发布过文章的用户。</p> <p><strong>子查询</strong></p> <p>有时候，我们会通过子查询关联不同的表进行查询，考虑下面这个 SQL 语句：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>select * from posts where user_id in (select id from users where email_verified_at is not null);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>对于这条 SQL 语句，我们可以通过查询构建器提供的子查询来实现：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$users = DB::table('users')-&gt;whereNotNull('email_verified_at')-&gt;select('id');
$posts = DB::table('posts')-&gt;whereInSub('user_id', $users)-&gt;get();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>除了 IN 查询外，普通的 WHERE 查询也可以使用子查询，对应的方法是 <code>whereSub</code>，但是子查询的效率不如连接查询高，所以我们下面来探讨连接查询在查询构建器中的使用。</p> <h4 id="连接查询"><a href="#连接查询" class="header-anchor">#</a> 连接查询</h4> <ul><li>内连接：使用比较运算符进行表间的比较，查询与连接条件匹配的数据，可细分为等值连接和不等连接
<ul><li>等值连接（=）：如 <code>select * from posts p inner join users u on p.user_id = u.id</code></li> <li>不等连接（&lt;、&gt;、&lt;&gt;等）：如 <code>select * from posts p inner join users u on p.user_id &lt;&gt; u.id</code></li></ul></li> <li>外链接：
<ul><li>左连接：返回左表中的所有行，如果左表中的行在右表中没有匹配行，则返回结果中右表中的对应列返回空值，如 <code>select * from posts p left join users u on p.user_id = u.id</code></li> <li>右连接：与左连接相反，返回右表中的所有行，如果右表中的行在左表中没有匹配行，则结果中左表中的对应列返回空值，如 <code>select * from posts p right join users u on p.user_id = u.id</code></li> <li>全连接：返回左表和右表中的所有行。当某行在另一表中没有匹配行，则另一表中的列返回空值，如 <code>select * from posts p full join users u on p.user_id = u.id</code></li></ul></li> <li>交叉连接：也称笛卡尔积，不带 <code>where</code> 条件子句，它将会返回被连接的两个表的笛卡尔积，返回结果的行数等于两个表行数的乘积，如果带 <code>where</code>，返回的是匹配的行数。如 <code>select * from posts p cross join users u on p.user_id = u.id</code></li></ul> <p><img src="http://yanxuan.nosdn.127.net/fcb64039ea8e5f2b4b620e3904556182.png" alt="UTOOLS1567775329384.png"></p> <p>创建迁移文件并定义迁移</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan make:migration create_posts_table --create<span class="token operator">=</span>posts
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-PHP line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Schema<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>Blueprint <span class="token variable">$table</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">increments</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'title'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'标题'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'content'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'内容'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'user_id'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">unsigned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token keyword">default</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'views'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">unsigned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token keyword">default</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'浏览数'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'user_id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">timestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>创建模型类,位于<code>app/Post.php</code>,模型类创建好后就是空的</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan make:model Post
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>创建模型工厂,并定义数据填充规则</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>php artisan make<span class="token punctuation">:</span>factory PostFactory <span class="token operator">--</span>model<span class="token operator">=</span>Post
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$factory</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">define</span><span class="token punctuation">(</span>Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>Faker <span class="token variable">$faker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
		<span class="token single-quoted-string string">'title'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$faker</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">title</span><span class="token punctuation">,</span>
		<span class="token single-quoted-string string">'content'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$faker</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">text</span><span class="token punctuation">,</span>
		<span class="token single-quoted-string string">'user_id'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token single-quoted-string string">'views'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$faker</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">randomDigit</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>创建填充类,定义<code>run</code>方法</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>php artisan make<span class="token punctuation">:</span>seeder PostsTableSeeder
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">factory</span><span class="token punctuation">(</span>\<span class="token package">App<span class="token punctuation">\</span>Post</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>执行迁移并填充数据</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>php artisan migrate <span class="token operator">--</span>seed <span class="token operator">--</span><span class="token keyword">class</span><span class="token operator">=</span>PostsTableSeeder
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>内连接</strong></p> <p>在查询构建器中实现</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$posts</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'users.id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'='</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'posts.user_id'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts.*'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'users.name'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'users.email'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>原生<code>SQL</code>查询</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> posts<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> users<span class="token punctuation">.</span>name<span class="token punctuation">,</span> users<span class="token punctuation">.</span>email <span class="token keyword">from</span> posts <span class="token keyword">inner</span> <span class="token keyword">join</span> users <span class="token keyword">on</span> users<span class="token punctuation">.</span>id <span class="token operator">=</span> posts<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>! 当两张表有字段名相同的字段，并且这两个字段都包含在 select 方法指定的字段中，需要为其中&gt; 一个字段取别名，否则会产生冲突<code>select('posts.*', 'users.name as username', 'users.email')</code></p></blockquote> <p><strong>左连接</strong></p> <p>左连接也可称作左外连接，在查询构建器中，可以通过 <code>leftJoin</code> 方法实现：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$posts = DB::table('posts')
    -&gt;leftJoin('users', 'users.id', '=', 'posts.user_id')
    -&gt;select('posts.*', 'users.name', 'users.email')
    -&gt;get();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>对应的 SQL 语句是：</p> <div class="language-SQL line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span>
	posts<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
	users<span class="token punctuation">.</span>NAME<span class="token punctuation">,</span>
	users<span class="token punctuation">.</span>email
<span class="token keyword">FROM</span>
	posts
	<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> users <span class="token keyword">ON</span> users<span class="token punctuation">.</span>id <span class="token operator">=</span> posts<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>左连接时<code>posts</code>即为左表</p> <p><strong>右连接</strong></p> <p>右连接也可称作右外链接，在查询构建器中，可以通过 <code>rightJoin</code> 方法实现：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$posts = DB::table('posts')
    -&gt;rightJoin('users', 'users.id', '=', 'posts.user_id')
    -&gt;select('posts.*', 'users.name', 'users.email')
    -&gt;get();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>对应的 SQL 语句如下：</p> <div class="language-SQL line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span>
	posts<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
	users<span class="token punctuation">.</span>NAME<span class="token punctuation">,</span>
	users<span class="token punctuation">.</span>email
<span class="token keyword">FROM</span>
	posts
	<span class="token keyword">RIGHT</span> <span class="token keyword">JOIN</span> users <span class="token keyword">ON</span> users<span class="token punctuation">.</span>id <span class="token operator">=</span> posts<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>右连接<code>users</code>即为右表</p> <p><strong>复杂查询</strong></p> <div class="language-SQL line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span>
	posts<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
	users<span class="token punctuation">.</span>NAME<span class="token punctuation">,</span>
	users<span class="token punctuation">.</span>email
<span class="token keyword">FROM</span>
	posts
	<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> users <span class="token keyword">ON</span> users<span class="token punctuation">.</span>id <span class="token operator">=</span> posts<span class="token punctuation">.</span>user_id
	<span class="token operator">AND</span> users<span class="token punctuation">.</span>email_verified_at <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token keyword">WHERE</span>
	posts<span class="token punctuation">.</span>views <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>通过匿名函数组装实现复杂查询</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$posts</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$join</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$join</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users.id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'='</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'posts.user_id'</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">whereNotNull</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users.email_verified_at'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts.*'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'users.name'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'users.email'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts.views'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>联合查询</strong></p> <p><code>union</code>合并多个查询结果</p> <div class="language-SQL line-numbers-mode"><pre class="language-sql"><code><span class="token punctuation">(</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>posts<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token operator">&lt;=</span> <span class="token number">10</span> <span class="token punctuation">)</span> <span class="token keyword">UNION</span>
<span class="token punctuation">(</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>posts<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>views<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$posts_a</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'views'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$posts_b</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&lt;='</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">union</span><span class="token punctuation">(</span><span class="token variable">$posts_a</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>查询构建器也支持 UNION ALL 查询，对应的方法是 unionAll，该方法与 union 的区别是允许重复记录</p> <p><strong>排序</strong></p> <p>倒序</p> <div class="language-SQL line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span>
	<span class="token operator">*</span>
<span class="token keyword">FROM</span>
	<span class="token punctuation">`</span>posts<span class="token punctuation">`</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
	<span class="token punctuation">`</span>created_at<span class="token punctuation">`</span> <span class="token keyword">DESC</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$users</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'created_at'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'desc'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>随机排序</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">inRandomOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>! 小结果集可以使用随机,但是大结果集会影响性能</p></blockquote> <p><strong>分组</strong></p> <div class="language-SQL line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span>
	user_id<span class="token punctuation">,</span>
	<span class="token function">SUM</span><span class="token punctuation">(</span> views <span class="token punctuation">)</span> <span class="token keyword">AS</span> total_views
<span class="token keyword">FROM</span>
	posts
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
	user_id
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$posts</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'user_id'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">selectRaw</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'user_id, sum(views) as total_views'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>使用<code>having</code>对分组结果进行过滤</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span>
	user_id<span class="token punctuation">,</span>
	<span class="token function">SUM</span><span class="token punctuation">(</span> views <span class="token punctuation">)</span> <span class="token keyword">AS</span> total_views
<span class="token keyword">FROM</span>
	posts
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
	user_id
<span class="token keyword">HAVING</span>
	total_views <span class="token operator">&gt;=</span> <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$posts</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'user_id'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">selectRaw</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'user_id, sum(views) as total_views'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">having</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'total_views'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&gt;='</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>分页查询</strong></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span>
<span class="token operator">*</span>
<span class="token keyword">FROM</span>
posts
<span class="token keyword">WHERE</span>
views <span class="token operator">&gt;</span> <span class="token number">0</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
created_at <span class="token keyword">DESC</span>
<span class="token keyword">LIMIT</span> <span class="token number">5</span> <span class="token keyword">OFFSET</span> <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-PHP line-numbers-mode"><pre class="language-php"><code><span class="token variable">$posts</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'created_at'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'desc'</span><span class="token punctuation">)</span>
   <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'views'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
   <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
   <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>skip 方法传入的参数表示从第几条记录开始，take 传入的参数表示一次获取多少条记录
offset 表示从第几条记录开始，limit 表示一次获取多少条记录</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$posts</span> <span class="token operator">=</span> <span class="token constant">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'created_at'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'desc'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'views'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="模型-crud"><a href="#模型-crud" class="header-anchor">#</a> 模型 CRUD</h3> <p>定义模型类</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan make:model Post
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>注：如果对应的数据表尚未创建，你还可以在创建模型类的同时创建对应的数据库迁移文件，通过<code>php artisan make:model Post -m</code> 即可。如果你想将模型类创建到 <code>app/Models</code> 目录下，可以这么运行上述命令 <code>php artisan make:model Models/Post</code></p></blockquote> <p><code>Post</code>模型类创建后并没有内容,但依据(约定优于配置)依然可以通过它完成数据表记录的增删改查</p> <p><strong>表名</strong></p> <p>Eloquent 约定模型类映射表名是将类名由驼峰格式转化为小写+下划线（含多个单词的话），最后将其转化为复数形式,<code>PostTag -&gt; post_tag</code> ,也可以通过手动设置模型类属性的方式进行自定义</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">protected</span> <span class="token variable">$table</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'articles'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>主键</strong></p> <p>Eloquent 默认假设每张数据表都有一个整型的自增主键，其字段名为 <code>id</code>，如果你的数据表主键名不是 <code>id</code>，可以通过 <code>$primaryKey</code> 属性来指定：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">protected</span> <span class="token variable">$primaryKey</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'post_id'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果主键不是自增的，还可以设置 <code>$incrementing</code> 属性为 <code>false</code>：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token variable">$incrementing</span> <span class="token operator">=</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果主键不是整型，还可以设置 <code>$keyType</code> 属性为 <code>string</code>：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">protected</span> <span class="token variable">$keyType</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'string'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>时间戳</strong></p> <p>Eloquent 默认约定每张表都有 <code>created_at</code> 和 <code>updated_at</code> 字段（迁移类中 <code>$table-&gt;timestamps()</code> 会生成这两个字段），并且在保存模型类时会自动维护这两个字段。如果你的数据表里面不包含这两个字段，或者只包含一个，都需要设置 <code>$timestamps</code> 属性为 <code>false</code>：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token variable">$timestamps</span> <span class="token operator">=</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>或者通过 <code>CREATED_AT</code> 和 <code>UPDATED_AT</code> 常量来设置自定义的创建和更新时间字段：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token constant">CREATED_AT</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'create_time'</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token constant">UPDATED_AT</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'update_time'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>此外，默认时间的存储格式是 <code>Y-m-d H:i:s</code>，你还可以通过 <code>$dateFormat</code> 属性来自定义时间戳的格式，该属性值通过 PHP 的 <code>date()</code> 函数进行解析，所以原则上支持 <a href="http://php.net/manual/en/function.date.php" target="_blank" rel="noopener noreferrer">date<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 函数支持的所有语法格式，比如将时间设置为 Unix 时间戳：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">protected</span> <span class="token variable">$dateFormat</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'U'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这样，保存到数据库的时间格式就是 Unix 时间戳了，前提是你的 <code>created_at</code> 和 <code>updated_at</code> 字段是整型，否则会报格式错误。</p> <p><strong>数据库连接</strong></p> <p>Eloquent 模型类默认约定的数据库连接是 <code>config/database.php</code> 中配置的默认连接，如果应用配置了多个数据库连接，可以通过 <code>$connection</code> 属性为模型类指定使用哪个连接：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">protected</span> <span class="token variable">$connection</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'connection_name'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="查询数据"><a href="#查询数据" class="header-anchor">#</a> 查询数据</h4> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$posts</span> <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取表所有记录</span>
<span class="token comment">// 结果集比较大使用 chunk</span>
Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">chunk</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$posts</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$posts</span> <span class="token keyword">as</span> <span class="token variable">$post</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">views</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token function">array_push</span><span class="token punctuation">(</span><span class="token variable">$re_arr</span><span class="token punctuation">,</span><span class="token variable">$post</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>每次只获取一条查询结果,减少内存消耗</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">foreach</span> <span class="token punctuation">(</span>Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">cursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$post</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">dump</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">title</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">':'</span> <span class="token punctuation">.</span> <span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>获取指定查询结果</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$posts</span> <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'views'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'title'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'content'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查询排序分页</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$posts</span> <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'views'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'desc'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>单条记录</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'学院君'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>主键<code>id</code>查询</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>通过 <code>firstOrFail</code> 或者 <code>findOrFail</code> 方法在找不到对应记录时抛出 404 异常，从而简化代码编写：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">findOrFail</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>获取聚合结果</strong></p> <p>Eloquent 模型类同样支持 <code>count</code>、<code>sum</code>、<code>avg</code>、<code>max</code>、<code>min</code> 等聚合函数查询：</p> <div class="language-PHP line-numbers-mode"><pre class="language-php"><code><span class="token variable">$num</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">whereNotNull</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'email_verified_at'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token shell-comment comment"># 计数</span>
<span class="token variable">$sum</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">whereNotNull</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'email_verified_at'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token shell-comment comment"># 求和</span>
<span class="token variable">$avg</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">whereNotNull</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'email_verified_at'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token shell-comment comment"># 平均值</span>
<span class="token variable">$min</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">whereNotNull</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'email_verified_at'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token shell-comment comment"># 最小值</span>
<span class="token variable">$max</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">whereNotNull</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'email_verified_at'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token shell-comment comment"># 最大值</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="插入数据"><a href="#插入数据" class="header-anchor">#</a> 插入数据</h4> <div class="language-PHP line-numbers-mode"><pre class="language-php"><code><span class="token variable">$post</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">App<span class="token punctuation">\</span>Post</span><span class="token punctuation">;</span>
<span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">title</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'测试文章标题'</span><span class="token punctuation">;</span>
<span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">content</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'测试文章内容'</span><span class="token punctuation">;</span>
<span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">user_id</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>快速插入<code>firstOrCreate</code> 和 <code>firstOrNew</code>，这两个方法都会先尝试通过指定查询条件在数据库中查找对应记录，如果没有找到的话，会创建对应模型类的实例，并将查询条件作为对应字段值设置到模型属性上。两者的区别是 <code>firstOrCreate</code> 方法在设置完模型属性后会将该模型记录保存到数据库中，而 <code>firstOrNew</code> 不会：</p> <div class="language-PHP line-numbers-mode"><pre class="language-php"><code><span class="token variable">$post_1</span> <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">firstOrCreate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'title'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'测试文章标题1'</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'user_id'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$post_2</span> <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">firstOrNew</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'title'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'测试文章标题1'</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'user_id'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="更新数据"><a href="#更新数据" class="header-anchor">#</a> 更新数据</h4> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$post</span> <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">title</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'测试文章标题更新'</span><span class="token punctuation">;</span>
<span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>快捷的更新方法 <code>updateOrCreate</code>，该方法首先会根据传入参数对模型对应记录进行更新，如果发现对应记录不存在，则会将更新数据作为初始数据插入数据库，并保存（同样也不建议这么做，除非你的场景特别适合）：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> user<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">updateOrCreate</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'学院君'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token single-quoted-string string">'email'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'admin@laravelacademy.org'</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>有的时候我们可能需要批量更新模型对应数据表的多条记录，这可以借助查询构建器来实现：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'views'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'views'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="删除数据"><a href="#删除数据" class="header-anchor">#</a> 删除数据</h4> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$post</span> <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>destroy</code>方法一次删除多条记录</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code>Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>删除指定记录</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'学院君'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">fisrt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="批量赋值-软删除"><a href="#批量赋值-软删除" class="header-anchor">#</a> 批量赋值 &amp; 软删除</h3> <p>批量赋值用于将用户提交的数据写入数据库</p> <p><code>Eloquent</code>中设有白名单和黑名单过滤用户提交的数据借以提高安全性</p> <p>白名单属性就是该属性中指定的字段才能应用批量赋值，不在白名单中的属性会被忽略；
黑名单属性指定的字段不会应用批量赋值，不在黑名单中的属性则会应用批量赋值。</p> <p>实际开发中建议使用白名单,安全性更好.对于相对稳定或者字段很多的数据表，建议使用黑名单，免去设置字段之苦，但是对于这样的模型类，每次修改数据表结构的时候都要记得维护这个黑名单，看看是否需要变动。</p> <p>黑白名单在模型中设置</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">/**
 * 使用批量赋值的属性（白名单）
 *
 * @var array
 */</span>
<span class="token keyword">protected</span> <span class="token variable">$fillable</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 不使用批量赋值的字段（黑名单）
 *
 * @var array
 */</span>
<span class="token keyword">protected</span> <span class="token variable">$guarded</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token single-quoted-string string">'*'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>更新模型</strong></p> <p>更新使用<code>fill</code>方法实现批量赋值</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$post</span> <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">findOrFail</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="软删除"><a href="#软删除" class="header-anchor">#</a> 软删除</h4> <p>软删除就是将信息打上删除标记,而不是真正的在数据库抹除数据</p> <p><code>Eloquent</code>模型类软删除原理是在支持软删除的数据表中添加<code>deleted_at</code>字段</p> <p>迁移文件</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan make:migration alter_posts_add_deleted_at --table<span class="token operator">=</span>posts
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Schema<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>Blueprint <span class="token variable">$table</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//</span>
        <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">softDeletes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Schema<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'posts'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>Blueprint <span class="token variable">$table</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//</span>
        <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">dropColumn</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'deleted_at'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>在模型类中添加支持软删除的<code>Trait</code></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Database<span class="token punctuation">\</span>Eloquent<span class="token punctuation">\</span>SoftDeletes</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Posts</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token package">SoftDeletes</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p>注：你也可以修改这个默认约定的 deleted_at 字段，但何必费这个劲呢，除非你是从其它系统迁移过来的，原来的表结构已经存在了，
这时候可以通过再模型类中设置静态属性 DELETED_AT 来自定义软删除字段。</p></blockquote> <ol><li>trashed 判断软删除</li></ol> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">trashed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token function">dump</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'记录已删除'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="2"><li>withTrashed 查询软删除记录</li></ol> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$post</span> <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">withTrashed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="3"><li>onlyTrashed 获取被删除记录</li></ol> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$post</span> <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">onlyTrashed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'views'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="4"><li>restore 恢复软删除</li></ol> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 恢复单条记录</span>
Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">onlyTrashed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'views'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 恢复多条记录</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="5"><li>forceDelete 物理删除</li></ol> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">forceDelete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="6"><li>delete 软删除</li></ol> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$post</span> <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">findOrFail</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 直接查询被软删除的记录使用这个 Api 会报错 404</span>
<span class="token variable">$posts</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="访问器-修改器"><a href="#访问器-修改器" class="header-anchor">#</a> 访问器 &amp; 修改器</h3> <p>要定义访问器很简单，在相应模型类中设置对应方法即可。以上面的 $user-&gt;display_name 为例，我们可以在 User 模型类中添加相应的方法 getDisplayNameAttribute（注意这里的转化方式，将小写字母+短划线格式属性转化为驼峰格式方法，后面的修改器也是这样）：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getDisplayNameAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">nickname</span> <span class="token operator">?</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">nickname</span> <span class="token punctuation">:</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">name</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这样，我们就可以在代码中直接通过 $user-&gt;display_name 访问期望的用户名了，以后如果你想要修改用户名显示逻辑，直接改这个方法里的代码就好了，非常方便。</p> <p>注：访问器方法名中包含的字段尽量不要和数据库字段名同名，否则会覆盖数据库字段，导致通过模型属性将永远无法访问该数据库字段；另外，如果访问器内部访问了某个数据库字段，则不能将访问器和该数据库字段同名，否则会导致循环引用而报错。比如此例中，就不能将访问器方法名设置为 getNameAttribute 或 getNickNameAttribute。</p> <p><strong>修改器</strong></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">setCardNoAttribute</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token single-quoted-string string">' '</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 将所有空格去掉</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">attributes</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'card_no'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>修改器传入形参<code>$value</code>不能漏掉,而后的所有该字段的操作都会通过修改器</p> <p>根据<code>Laravel</code>约定大于规则的原则,我们可以访问不存在的属性</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// 模型</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getNumAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">return</span> <span class="token number">123</span>
<span class="token punctuation">}</span>

<span class="token variable">$post</span> <span class="token operator">=</span> Posts<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">num</span><span class="token punctuation">;</span> <span class="token comment">// 123</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="数组-json-互转"><a href="#数组-json-互转" class="header-anchor">#</a> 数组 json 互转</h4> <p>模型内设置对应字段,注意需要<code>sql</code>字段的储存格式为<code>text</code>或<code>JSON</code>
在模型类中将字段对应属性类型转化设置为数组，这样在保存字段到数据库时，会自动将数组数据转化为 JSON 格式，在从数据库读取该字段时，会自动将 JSON 数据转化为数组格式，方便操作。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">protected</span> <span class="token variable">$casts</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'content'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'array'</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="查询作用域"><a href="#查询作用域" class="header-anchor">#</a> 查询作用域</h3> <p>全局作用域」，指的是预置过滤器在注册该「全局作用域」的模型类的所有查询中生效，不需要指定任何额外条件。</p> <p>要实现「全局作用域」，首先需要编写一个实现 Illuminate\Database\Eloquent\Scope 接口的全局作用域类，这里我们将其命名为 <code>EmailVerifiedAtScope</code>，并将其放到 app/Scopes 目录下：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Scopes</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Database<span class="token punctuation">\</span>Eloquent<span class="token punctuation">\</span>Builder</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Database<span class="token punctuation">\</span>Eloquent<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Database<span class="token punctuation">\</span>Eloquent<span class="token punctuation">\</span>Scope</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">EmailVerifiedAtScope</span> <span class="token keyword">implements</span> <span class="token class-name">Scope</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">apply</span><span class="token punctuation">(</span>Builder <span class="token variable">$builder</span><span class="token punctuation">,</span> Model <span class="token variable">$model</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$builder</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">whereNotNull</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'email_verified_at'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>实现全局作用域的<code>apply</code>方法,该方法返回查询构建器上应用过滤器方法的结果.将全局作用域类注册到<code>User</code>模型类上,这样，在 User 模型类上进行查询的时候才可以应用相应的过滤条件。这个工作可以通过在 <strong>User 模型类</strong>中重写父类的 boot 方法来完成：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">parent</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">addGlobalScope</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EmailVerifiedAtScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>接下来需要在<code>Telescope</code>中查看<code>Queries</code>对应的<code>SQL</code></p> <p><code>select * from</code>users<code>where</code>email_verified_at<code>is not null</code></p> <p>其中就包含了全局查询过滤条件</p> <h4 id="匿名函数实现"><a href="#匿名函数实现" class="header-anchor">#</a> 匿名函数实现</h4> <p>全局作用域实现比较麻烦,也可通过在<code>boot</code>方法使用匿名函数实现</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">parent</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">addGlobalScope</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'email_verified_at_scope'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>Builder <span class="token variable">$builder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$builder</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">whereNotNull</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'email_verified_at'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="特定情况下移除全局作用域查询规则"><a href="#特定情况下移除全局作用域查询规则" class="header-anchor">#</a> 特定情况下移除全局作用域查询规则</h4> <div class="language-php line-numbers-mode"><pre class="language-php"><code>User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">withoutGlobalScope</span><span class="token punctuation">(</span>EmailVerifiedAtScope<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token shell-comment comment"># 指定类</span>
User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">withoutGlobalScope</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'email_verified_at_scope'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token shell-comment comment"># 匿名函数</span>
User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">withoutGlobalScopes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token shell-comment comment"># 移除所有全局作用域</span>
User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">withoutGlobalScopes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>FirstScope<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span> SecondScope<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token shell-comment comment"># 移除多个类/匿名函数</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="局部作用域"><a href="#局部作用域" class="header-anchor">#</a> 局部作用域</h4> <p>「局部作用域」的实现也比较简单，在需要应用它的模型类中定义一个过滤器方法即可。该方法需要以 scope 开头，然后附加该过滤器的名称</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Database<span class="token punctuation">\</span>Eloquent<span class="token punctuation">\</span>Builder</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Database<span class="token punctuation">\</span>Eloquent<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Post</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token constant">ACTIVED</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'1'</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">scopePopular</span><span class="token punctuation">(</span>Builder <span class="token variable">$query</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'views'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'&gt;'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'0'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'views'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'desc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">scopeActive</span><span class="token punctuation">(</span>Builder <span class="token variable">$query</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 这里需要添加一个 status 字段</span>
        <span class="token comment">// php artisan make:migration alter_posts_add_status --table=posts</span>
        <span class="token comment">// 编写迁移 $table-boolean()-&gt;nullable()-&gt;comment('状态')</span>
        <span class="token comment">// $table-&gt;dropColumn('status')</span>
        <span class="token keyword">return</span> <span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'status'</span><span class="token punctuation">,</span>Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">ACTIVED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>然后调用对应的查询规则即可</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">post</span><span class="token punctuation">(</span>Request <span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$posts</span> <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">active</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">popular</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dd</span><span class="token punctuation">(</span><span class="token variable">$posts</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token single-quoted-string string">'post modle'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="动态作用域"><a href="#动态作用域" class="header-anchor">#</a> 动态作用域</h4> <p>所谓动态作用域指的是在查询过程中动态设置预置过滤器的查询条件</p> <p>在模型类中如下定义</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">scopeOfType</span><span class="token punctuation">(</span>Builder <span class="token variable">$query</span><span class="token punctuation">,</span> <span class="token variable">$type</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'type'</span><span class="token punctuation">,</span> <span class="token variable">$type</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>调用时动态传参</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$posts</span> <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">active</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">ofType</span><span class="token punctuation">(</span>Post<span class="token punctuation">:</span><span class="token punctuation">:</span>Article<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="模型事件"><a href="#模型事件" class="header-anchor">#</a> 模型事件</h3> <p>在 Eloquent 模型类上进行查询、插入、更新、删除操作时，会触发相应的模型事件（关于事件我们后面会单独讲），不管你有没有监听它们。这些事件包括：</p> <ul><li>retrieved：获取到模型实例后触发</li> <li>creating：插入到数据库前触发</li> <li>created：插入到数据库后触发</li> <li>updating：更新到数据库前触发</li> <li>updated：更新到数据库后触发</li> <li>saving：保存到数据库前触发（插入/更新之前，无论插入还是更新都会触发）</li> <li>saved：保存到数据库后触发（插入/更新之后，无论插入还是更新都会触发）</li> <li>deleting：从数据库删除记录前触发</li> <li>deleted：从数据库删除记录后触发</li> <li>restoring：恢复软删除记录前触发</li> <li>restored：恢复软删除记录后触发</li></ul> <h4 id="通过静态方法监听"><a href="#通过静态方法监听" class="header-anchor">#</a> 通过静态方法监听</h4> <p>重写事件服务供应商的 boot 方法</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">parent</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">retrieved</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        Log<span class="token punctuation">:</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'从模型中获取用户:['</span><span class="token punctuation">.</span> <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">id</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">']'</span> <span class="token punctuation">.</span> <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 接下来的user 表的查询都会被记录到 storage/log/ 里面去</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="通过订阅者监听模型事件"><a href="#通过订阅者监听模型事件" class="header-anchor">#</a> 通过订阅者监听模型事件</h4> <div class="language-txt line-numbers-mode"><pre class="language-text"><code>模型类-&gt; [ 模型类与自定义事件建立对应关系 ] &lt;-对应事件类-&gt; 注册至监听器类

+------------------------+           +----------------------+
| EventServiceProvider   +----------&gt;+UserEventSubscriber   |
+------------------------+           +----------------------+
                                     +------------------+
                                     |UserDeleting      | &lt;------ +---------------+
                                     |                  |         |User           |
                                     |Userdeleted       | ------&gt; +---------------+
                                     +------------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>EXAMPLE 初始化事件类</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artsian make:event UserDeleting
php artisan make:event UserDeleted
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>接下来在 <code>app\Events</code> 看到事件类,在这两个类的构造中中传入 <code>$user</code></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token variable">$user</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span>User <span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">user</span> <span class="token operator">=</span> <span class="token variable">$user</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在模型类中建立与事件类的映射</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">protected</span> <span class="token variable">$dispatchesEvents</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'deleting'</span><span class="token operator">=</span><span class="token operator">&gt;</span>UserDeleting<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'deleted'</span><span class="token operator">=</span><span class="token operator">&gt;</span>UserDeleted<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>为模型类创建事件订阅者类</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Listeners</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Events<span class="token punctuation">\</span>UserDeleting</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Events<span class="token punctuation">\</span>UserDeleted</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Facades<span class="token punctuation">\</span>Log</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">UserEventSubscriber</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">onUserDeleting</span><span class="token punctuation">(</span><span class="token variable">$event</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Log<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'用户即将删除['</span> <span class="token punctuation">.</span> <span class="token variable">$event</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">id</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">']:'</span> <span class="token punctuation">.</span> <span class="token variable">$event</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">onUserDeleted</span><span class="token punctuation">(</span><span class="token variable">$event</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Log<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'用户已经删除['</span> <span class="token punctuation">.</span> <span class="token variable">$event</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">id</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">']:'</span> <span class="token punctuation">.</span> <span class="token variable">$event</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token variable">$events</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$events</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">listen</span><span class="token punctuation">(</span>
            UserDeleting<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span>
            UserEventSubscriber<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span> <span class="token class-name"><span class="token punctuation">.</span></span> <span class="token single-quoted-string string">'@onUserDeleting'</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$events</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">listen</span><span class="token punctuation">(</span>
            UserDeleted<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span>
            UserEventSubscriber<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span> <span class="token class-name"><span class="token punctuation">.</span></span> <span class="token single-quoted-string string">'@onUserDeleted'</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>注册订阅者</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// app/Providers/EventServiceProvider.php</span>
<span class="token keyword">protected</span> <span class="token variable">$subscribe</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    UserEventSubscriber<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="通过观察者监听模型事件"><a href="#通过观察者监听模型事件" class="header-anchor">#</a> 通过观察者监听模型事件</h4> <p>创建针对<code>User</code>模型的观察者</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan make:observer UserObserver --model<span class="token operator">=</span>User
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>生成如下<code>app\Observers</code>
只需要填充对应的事件即可</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Observers</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>User</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Facades<span class="token punctuation">\</span>Log</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">UserObserver</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">created</span><span class="token punctuation">(</span>User <span class="token variable">$user</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Log<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">updated</span><span class="token punctuation">(</span>User <span class="token variable">$user</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">deleted</span><span class="token punctuation">(</span>User <span class="token variable">$user</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">restored</span><span class="token punctuation">(</span>User <span class="token variable">$user</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">forceDeleted</span><span class="token punctuation">(</span>User <span class="token variable">$user</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>在<code>User</code>模型上注册观察者即可生效
在<code>EventServiceProvider</code>中的<code>boot</code>方法中注册</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">parent</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">observe</span><span class="token punctuation">(</span>UserObserver<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="模型关联关系"><a href="#模型关联关系" class="header-anchor">#</a> 模型关联关系</h3> <h4 id="一对一"><a href="#一对一" class="header-anchor">#</a> 一对一</h4> <h5 id="建立关联关系"><a href="#建立关联关系" class="header-anchor">#</a> 建立关联关系</h5> <p>键入命令<code>php artisan make:model UserProfile -m</code> 同时创建迁移 与 模型
编辑表字段</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Schema<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'user_profiles'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>Blueprint <span class="token variable">$table</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">increments</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'user_id'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">unsigned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token keyword">default</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">unique</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'bio'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">nullable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'个性签名'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'city'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">nullable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'所在城市'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'hobby'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">nullable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'个人爱好'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">timestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在<code>User</code>模型类中创建与<code>UserProfile</code>关联的方法</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// app\User.php</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">profile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">hasOne</span><span class="token punctuation">(</span>UserProfile<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后在查询时调用</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code> <span class="token comment">// UserController.php</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">profile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$user</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">findOrFail</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$profile</span> <span class="token operator">=</span>  <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">profile</span><span class="token punctuation">;</span>
    <span class="token function">dd</span><span class="token punctuation">(</span><span class="token variable">$profile</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>在关联关系的建立过程中，Eloquent 也遵循了「约定大于配置」的原则</strong>hasOne 方法的完整签名是：</p> <p><code>public function hasOne($related, $foreignKey = null, $localKey = null)</code></p> <p>第一个参数是关联模型的类名，第二个参数是关联模型类所属表的外键，这里对应的是 user_profiles 表的 user_id 字段，第三个参数是关联表的外键关联到当前模型所属表的哪个字段，这里对应的是 users 表的 id 字段。为什么我们不需要指定 Laravel 就能完成这种关联呢，这是因为如果没有指定 $foreignKey，Eloquent 底层会通过如下方法去拼接：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getForeignKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> Str<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">snake</span><span class="token punctuation">(</span><span class="token function">class_basename</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token single-quoted-string string">'_'</span><span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getKeyName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="建立相对关联关系"><a href="#建立相对关联关系" class="header-anchor">#</a> 建立相对关联关系</h5> <p>使用<code>belongsTo</code>方法建立一对一的关联关系</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// app\UserProfile.php</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>使用关联方法名作为动态属性即可访问该模型所属的<code>User</code>模型实例</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$profile</span> <span class="token operator">=</span> UserProfile<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">findOrFail</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$profile</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">user</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>belongsTo</code> 其完整方法签名如下：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">belongsTo</span><span class="token punctuation">(</span><span class="token variable">$related</span><span class="token punctuation">,</span> <span class="token variable">$foreignKey</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span> <span class="token variable">$ownerKey</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span> <span class="token variable">$relation</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>$foreignKey</code>是当前模型类所属表的外键,即<code>user_profile</code>表的<code>user_id</code>字段
<code>$ownerKey</code>是关联模型类所属表的主键 <code>user</code>表的<code>id</code> <code>$relation</code>默认约定是对应关联关系方法名,这里是<code>user</code></p> <p><strong>注意: 这里的方法名需要与当前关联模型所属表的主键一致,因为 $relation 变量取的是当前关联关系的方法名,所以如果你需要定义语义化的关联关系方法名,就需要输入 <code>belongsTo</code>的参数</strong></p> <h4 id="一对多"><a href="#一对多" class="header-anchor">#</a> 一对多</h4> <p>返回模型类集合</p> <h5 id="建立关联关系-2"><a href="#建立关联关系-2" class="header-anchor">#</a> 建立关联关系</h5> <p>通过<code>hasMany</code>方法实现</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// User.php</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">posts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">hasMany</span><span class="token punctuation">(</span>Posts<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后通过动态属性的方式查询:</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">findOrFail</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$posts</span> <span class="token operator">=</span> <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">posts</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="建立相对关联关系-2"><a href="#建立相对关联关系-2" class="header-anchor">#</a> 建立相对关联关系</h5> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// Post</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">author</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 由于 方法名改为 author 不再遵循 约定.所以belongsTo的参数需要手动传入</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'user_id'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'author'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>进行关联查询</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">user_mm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$post</span> <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$author</span> <span class="token operator">=</span> <span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">author</span><span class="token punctuation">;</span>
    <span class="token function">dd</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token punctuation">,</span><span class="token variable">$author</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="渴求式加载"><a href="#渴求式加载" class="header-anchor">#</a> 渴求式加载</h5> <p>之前的关联关系查询都是通过动态属性查询,也可以称为<em>惰性加载</em>,用到的时候才去查询就意味着需要多次对数据库进行查询才能返回需要的结果.如果是单条记录获取关联关系就需要两次查询;如果是多条记录获取关联关系,就需要<em>N+1</em>次查询才能返回需要的结果</p> <p>使用<code>with</code>方法将需要查询的关联关系动态属性传入该方法,并将其链接到模型原有的查询中,就可以一次完成关联查询,加上模型自身查询,总共查询两次.这种查询方式被称为<em>渴求式加载</em></p> <p>查询所有需求数据,然后根据需求取其中的关联数据</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">user_mm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$post</span> <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'author'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'views'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'&gt;'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$author</span> <span class="token operator">=</span> <span class="token variable">$post</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">author</span><span class="token punctuation">;</span>

    <span class="token function">dd</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$author</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="多对多"><a href="#多对多" class="header-anchor">#</a> 多对多</h4> <p>多对多需要借助一张中间表才能建立关联关系.对于文章表<code>post</code>还需要一张<code>tag</code>表和<code>post_tag</code>表</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan make:model Tag -m
php artisan make:model PostTag -m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>填充 <code>tag</code> 迁移</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Schema<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'post_tags'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>Blueprint <span class="token variable">$table</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">bigIncrements</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'post_id'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">unsigned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token keyword">default</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'tag_id'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">unsigned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token keyword">default</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">unique</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'post_id'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'tag_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">timestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>填充<code>post_tag</code>迁移</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    Schema<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'post_tags'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>Blueprint <span class="token variable">$table</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">bigIncrements</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'post_id'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">unsigned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token keyword">default</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'tag_id'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">unsigned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token keyword">default</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">unique</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'post_id'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'tag_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">timestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>创建填充器类与填充工厂类</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan make:seeder TagTableSeeder
php artisan make:seeder PostTagTableSeeder
php artisan make:factory TagFactory --model<span class="token operator">=</span>Tag
php artisan make:factory PostTagFactory --model<span class="token operator">=</span>PostTag
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>定义工厂函数产出</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// TagFactory.php</span>
<span class="token variable">$factory</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">define</span><span class="token punctuation">(</span>Tag<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>Faker <span class="token variable">$faker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
       <span class="token single-quoted-string string">'name'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$faker</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">name</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// PostTagFactory.php</span>

<span class="token variable">$factory</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">define</span><span class="token punctuation">(</span>PostTag<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>Faker <span class="token variable">$faker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
        <span class="token double-quoted-string string">&quot;post_id&quot;</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$faker</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">unique</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">,</span><span class="token number">20000</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">numberBetween</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'tag_id'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$faker</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">unique</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">,</span><span class="token number">20000</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">numberBetween</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>然后在各自的填充器类中实现工厂函数</p> <p>在模型<code>Post</code>中定义<code>tags</code>方法</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">tags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 建立 post_tags 表与 post 和 tag 表之间的关联</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>Tag<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'post_tags'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在控制层中进行查询</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">tags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$posts</span> <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$tag</span> <span class="token operator">=</span> <span class="token variable">$posts</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">tags</span><span class="token punctuation">;</span>
    <span class="token function">dd</span><span class="token punctuation">(</span><span class="token variable">$tag</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>或是<strong>渴求式</strong>查询</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">tags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// with 的唯一参数 $relations 是当前 Post 模型的关联查询方法名</span>
    <span class="token variable">$posts</span> <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'tags'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$tag</span> <span class="token operator">=</span> <span class="token variable">$posts</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">tags</span><span class="token punctuation">;</span>
    <span class="token function">dd</span><span class="token punctuation">(</span><span class="token variable">$tag</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h5 id="多对多关联查询的底层约定"><a href="#多对多关联查询的底层约定" class="header-anchor">#</a> 多对多关联查询的底层约定</h5> <p><code>beloangsTo</code>方法签名:</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">belongsToMany</span><span class="token punctuation">(</span><span class="token variable">$related</span><span class="token punctuation">,</span>
<span class="token variable">$table</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span>
<span class="token variable">$foreignPivotKey</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span>
<span class="token variable">$relatedPivotKey</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span>
<span class="token variable">$parentKey</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span>
<span class="token variable">$relatedKey</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span>
<span class="token variable">$relation</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li><code>$related</code> 关联模型类名,当前是 <code>Post</code>关联<code>Tag</code></li> <li><code>$table</code> 多对多关联的中间表名 <code>post_tags</code></li> <li><code>$foreignPivotKey</code> 中间表的当前模型外键<code>post_id</code></li> <li><code>$relatedPivotKey</code> 中间表当前关联模型的外键<code>tag_id</code></li> <li><code>$parentKey</code> 对应当前模型的哪个字段<code>id</code></li> <li><code>$relatedKey</code> 对应当前关联模型的哪个字段<code>id</code></li> <li><code>$relation</code> 表示关联关系名称,默认为当前关联方法名<code>tags</code></li></ul> <h5 id="多对多的相对关联关系"><a href="#多对多的相对关联关系" class="header-anchor">#</a> 多对多的相对关联关系</h5> <p>在多对多关联关系中双方是对等的,不存在归属关系,所以对应查询只需要在<code>Tag</code>模型中创建查询方法即可</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">posts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'post_tags'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="获取中间表字段"><a href="#获取中间表字段" class="header-anchor">#</a> 获取中间表字段</h5> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">tags</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>Tag<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'post_tags'</span><span class="token punctuation">)</span>
                <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">withTimestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// or 获取 user_id 字段值</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">withPivot</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'user_id'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">withTimestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h5 id="自定义中间表模型类"><a href="#自定义中间表模型类" class="header-anchor">#</a> 自定义中间表模型类</h5> <p>中间表模型类继承自 Illuminate\Database\Eloquent\Relations\Pivot，Pivot 也是 Eloquent Model 类的子类，只不过为中间表操作定义了很多方法和属性，比如我们创建一个自定义的中间表模型类 PostTag</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">App</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Database<span class="token punctuation">\</span>Eloquent<span class="token punctuation">\</span>Relations<span class="token punctuation">\</span>Pivot</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">PostTag</span> <span class="token keyword">extends</span> <span class="token class-name">Pivot</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$table</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'post_tags'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>创建<code>post_tags</code>表的模型工厂与填充模型</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/** @var \Illuminate\Database\Eloquent\Factory $factory */</span>

<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>PostTag</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Faker<span class="token punctuation">\</span>Generator</span> <span class="token keyword">as</span> Faker<span class="token punctuation">;</span>

<span class="token variable">$factory</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">define</span><span class="token punctuation">(</span>PostTag<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>Faker <span class="token variable">$faker</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
        <span class="token double-quoted-string string">&quot;post_id&quot;</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$faker</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">unique</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">,</span><span class="token number">20000</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">numberBetween</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'tag_id'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$faker</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">unique</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">,</span><span class="token number">20000</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">numberBetween</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Database<span class="token punctuation">\</span>Seeder</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">PostTagTableSeeder</span> <span class="token keyword">extends</span> <span class="token class-name">Seeder</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">factory</span><span class="token punctuation">(</span>App\<span class="token package">PostTag</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>运行填充<code>php artisan db:seed --class=PostTagTableSeeder</code></p> <p>在<code>Post</code>模型类创建关联查询方法<code>tags</code></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">tags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 建立 post_tags 表与 post 和 tag 表之间的关联</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>Tag<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'post_tags'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在<code>PostController</code>中创建<code>tags</code>查询</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">tags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$posts</span> <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'tags'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$tag</span> <span class="token operator">=</span> <span class="token variable">$posts</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">tags</span><span class="token punctuation">;</span>
    <span class="token function">dd</span><span class="token punctuation">(</span><span class="token variable">$posts</span><span class="token punctuation">,</span><span class="token variable">$tag</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="http://yanxuan.nosdn.127.net/dfdbb1de696377c91732040dcf9025f2.png" alt="UTOOLS1571477896758.png"></p> <h4 id="远层一对多"><a href="#远层一对多" class="header-anchor">#</a> 远层一对多</h4> <p>用户与文章表形成一对多关系,国家与用户形成一对多关系,那么国家与文章表就存在<em>远层一对多关系</em></p> <div class="language-txt line-numbers-mode"><pre class="language-text"><code>
+------------------+             +-----------------+
|   User Table     |   One-to-More    Post Table   |
|                  +------------&gt;+                 |
+---------+--------+             +------+----------+
          ^                             |
          |                             |
          | One-to-more                 |
          |                             |
+---------+---------+                   |
|   Countries Table |                   | One-to-More
|                   +-------------------+
+-------------------+

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>创建国家表<code>countries</code>,在<code>users</code>表中添加<code>country_id</code>字段</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan make:model Countries
php artisan make:migration alter_users_add_country_id --table<span class="token operator">=</span>users
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>修改迁移文件</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Schema<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'users'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>Blueprint <span class="token variable">$table</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//</span>
        <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'country_id'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'国家id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>contory table</strong></p> <p><img src="http://yanxuan.nosdn.127.net/cfe139e5cac703be402b97cd1a82485f.png" alt="UTOOLS1571485592295.png"></p> <p>在<code>users</code>表中添加<code>country_id</code>字段值</p> <p>在模型类<code>countries</code>中定义国家与文章的远层一对多关系</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">posts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">/**
        * @param 3 中间模型关联当前模型关联字段
        * @param 4 目标模型关联中间模型关联字段
        */</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">hasManyThrough</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'App\Post'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'App\User'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'country_id'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'user_id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="多态关联"><a href="#多态关联" class="header-anchor">#</a> 多态关联</h4> <p>举例,同时具有文章和视频表,并评论表.评论表同时与文章或视屏具有关联性</p> <div class="language-txt line-numbers-mode"><pre class="language-text"><code>+----------------------------+     +-----------------------------+
|   Posts Table              |     |   Video Table               |
|                            |     |                             |
|                            |     |                             |
|                            |     |                             |
+--------------+-------------+     +---------------------+-------+
               ^                                         ^
               +--------------+ item_type +--------------+
               |                item_id                  |
               |                                         |
               |                                         |
               |   +--------------------------------+    |
               |   |     Comments Table             |    |
               +---+                                +----+
                   |                                |
                   |                                |
                   +----------------+---------------+
                                    ^
                                    |
                                    |user_id
                                    |
                   +----------------+---------------+
                   |     Users Table                |
                   |                                |
                   |                                |
                   |                                |
                   |                                |
                   +--------------------------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>评论表<code>comments</code>中同时存储<code>item_type</code>与<code>item_id</code>用来区分该条评论所属表</p> <p>创建<code>comments</code>表</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan make:migration create_comments_table --create<span class="token operator">=</span>Comments
php artisan migrate
php artisan make:factory CommentsFactory --model<span class="token operator">=</span>Comments
php artisan make:seeder CommentsTableSeeder
php artisan db:seed --class<span class="token operator">=</span>CommentsTableSeeder
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="http://yanxuan.nosdn.127.net/71212d8a3e2bed58c534a6be6079d58e.png" alt="UTOOLS1571638329537.png"></p> <p>首先在 Post 和 Video 模型类中定义关联评论如下：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">comments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">morphMany</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'App\Comments'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'item'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>其中第一个参数是关联模型类名，第二个参数是关联名称，即<code>$item_id</code>和<code>$item_type</code>中的<code>$item</code>部分。当然也可以传递完整参数到<code>morphMany</code>方法：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">morphMany</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'App\Comment'</span><span class="token punctuation">,</span><span class="token variable">$item</span><span class="token punctuation">,</span><span class="token variable">$item_type</span><span class="token punctuation">,</span><span class="token variable">$item_id</span><span class="token punctuation">,</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 参数$id是posts/videos表的主键。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如果需要也可以在<code>Comment</code>模型中定义相对的关联关系获取其所属节点：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">item</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">morphTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如果<code>$item</code>部分不等于<code>item</code>可以自定义传入参数到<code>morphTo()</code></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">morphTo</span><span class="token punctuation">(</span><span class="token variable">$item</span><span class="token punctuation">,</span><span class="token variable">$item_type</span><span class="token punctuation">,</span><span class="token variable">$item_id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>构建控制器测试</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">comment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$video</span> <span class="token operator">=</span> Video<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$video_comments</span> <span class="token operator">=</span> <span class="token variable">$video</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">comments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dd</span><span class="token punctuation">(</span><span class="token variable">$video_comments</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在<code>Comments</code>类中定义<code>item</code>方法反向查询评论对应的项</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">morphTo</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'item'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>定义查询</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">items</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$comment</span> <span class="token operator">=</span> Comments<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$comment_item</span> <span class="token operator">=</span> <span class="token variable">$comment</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">item</span><span class="token punctuation">;</span>
    <span class="token function">dd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="多对多的多态关联"><a href="#多对多的多态关联" class="header-anchor">#</a> 多对多的多态关联</h4> <p>多对多的多态关联表现在标签与文章和视频的关系中,文章和视频有多个标签,单个标签也可获取到多个文章或类型</p> <div class="language-txt line-numbers-mode"><pre class="language-text"><code>                           taggable_id
      More                 taggable_type
+------------------+&lt;-------------+                              More
|  Post            |              |                      +-------------------+
+------------------+       +------+--------------+ tag_id|                   |
                           |  taggables          +------&gt;+  Tags             |
+------------------+       +------+--------------+       |                   |
|  Video           |              |                      +-------------------+
+------------------+&lt;-------------+
      More

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这里可能关系图与上面的评论有点像,但是本质上不同.一个评论只能对应文章或视频中的一种,而一个标签可能既对应文章也对应视频</p> <p>在<code>tags</code>中添加<code>nums</code>字段</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan make:migration alter_tags_add_nums_table --table<span class="token operator">=</span>tags
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>添加中间表<code>taggables</code>并填充数据</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan make:model Taggable
php artisan make:migration create_taggables_table --create<span class="token operator">=</span>taggables
php artisan make:factory TaggablesFactory --model<span class="token operator">=</span>Taggable
php artisan make:seeder TaggablesTableSeeder
php artisan db:seed --class<span class="token operator">=</span>TaggableTableSeeder
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>最终表结构如下</p> <p><img src="http://yanxuan.nosdn.127.net/9c37ba4407908b9f1dfb8569c9ad955a.png" alt="UTOOLS1571645425935.png"></p> <p>在<code>Tag</code>类中编写<code>posts</code>和<code>videos</code>方法</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">posts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">morphedByMany</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'App\Post'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'taggable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">videos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">morphedByMany</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'App\Video'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'taggable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 完整参数列表如下</span>
<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">morphedByMany</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'App\Video'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'taggable'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'taggables'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'tag_id'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'taggable_id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在<code>Post</code>和<code>Video</code>表中添加方法<code>tags</code></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">tags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">morphToMany</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'App\Tag'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'taggable'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 完整参数列表如下</span>
<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">morphToMany</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'App\Tag'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'taggable'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'taggables'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'taggable_id'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'tag_id'</span><span class="token punctuation">,</span><span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>第三个参数是对应关系表名，最后一个值若为<code>true</code>，则查询的是关联对象本身，若为<code>false</code>，查询的是关联对象与父模型的对应关系。</p> <p>定义查询</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">tag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$posts</span> <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$post_tags</span> <span class="token operator">=</span> <span class="token variable">$posts</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">tag</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>或是在<code>tag</code>中查找<code>post</code>和<code>video</code></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">tags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$tags</span> <span class="token operator">=</span> Tag<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$tags_posts</span> <span class="token operator">=</span> <span class="token variable">$tags</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">posts</span><span class="token punctuation">;</span>
    <span class="token variable">$tags_videos</span> <span class="token operator">=</span> <span class="token variable">$tags</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">videos</span><span class="token punctuation">;</span>
    <span class="token function">dd</span><span class="token punctuation">(</span><span class="token variable">$tags_posts</span><span class="token punctuation">,</span><span class="token variable">$tags_videos</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="telescope-安装"><a href="#telescope-安装" class="header-anchor">#</a> Telescope 安装</h2> <p>注：Telescope 要求 Laravel 5.7.7+ 版本。你可以通过 php artisan --version 查看自己的 Laravel 版本。</p> <p>你可以使用 Composer 来安装 Telescope 到 Laravel 项目：</p> <p><code>composer require laravel/telescope</code></p> <p>安装完成后，使用 Artisan 命令 telescope:install 发布其公共资源，然后运行 migrate 命令执行数据库变更：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan telescope:install
php artisan migrate
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>更新 Telescope</p> <p>更新 Telescope 的时候，需要重新发布公共资源：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan telescope:publish
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="只在指定环境安装"><a href="#只在指定环境安装" class="header-anchor">#</a> 只在指定环境安装</h3> <p>如果你计划只在本地开发环境安装 Telescope，可以在安装的时候使用 --dev 标记：</p> <p><code>composer require laravel/telescope --dev</code></p> <p>安装完成后，需要从 app 配置文件中移除 TelescopeServiceProvider 服务提供者的注册。取而代之地，要手动在 AppServiceProvider 的 register 方法中注册它：</p> <p>app\Providers\AppServiceProvider.php</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">/**
 * Register any application services.
 *
 * @return void
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">app</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">app</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">register</span><span class="token punctuation">(</span>TelescopeServiceProvider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="配置"><a href="#配置" class="header-anchor">#</a> 配置</h3> <p>发布完 Telescope 的公共资源后，它的配置文件位于 config/telescope.php。该配置文件允许你配置监听选项 watchers，每个配置项都包含其用途说明，所以建议你使用 Telescope 之前通篇读一下这个配置文件。</p> <p>如果需要，你可以完全禁止 Telescope 的数据收集功能，通过配置项 enabled 来设置即可：</p> <p><code>'enabled' =&gt; env('TELESCOPE_ENABLED', true),</code>
数据清理
如果没有清理的话，telescope_entries 表会迅速累积记录。要缓解这一现状，需要通过调度任务每天运行 Artisan 命令 telescope:prune 来清理老数据：</p> <p><code>$schedule-&gt;command('telescope:prune')-&gt;daily();</code>
默认情况下，所有 24 小时之前的数据都会被清理，你可以在运行上述命令的时候使用 hours 选项来决定要保存多长时间以内的 Telescope 数据。例如，下面这个命令将会删除所有 48 小时以前创建的数据：</p> <p><code>$schedule-&gt;command('telescope:prune --hours=48')-&gt;daily();</code>
后台授权
<strong>Telescope 可以通过 /telescope 后台访问</strong>。和 Horizon 一样，默认情况下，你只能在本地开发环境（local）下访问。在你的 app/Providers/TelescopeServiceProvider.php 文件中，有一个 gate 方法，通过该访问控制方法，可以配置哪些用户可以在非本地环境访问 Telescope 后台，你可以根据需要随时修改该方法，以便限制对 Telescope 的访问：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">gate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Gate<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'viewTelescope'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">email</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
            <span class="token single-quoted-string string">'taylor@laravel.com'</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="访问"><a href="#访问" class="header-anchor">#</a> 访问</h3> <p>本地服务的域名加上<code>/telescope</code>的路由</p> <p><code>localurl/telescope</code></p> <h1 id="faq"><a href="#faq" class="header-anchor">#</a> FAQ</h1> <ol><li><code>SQLSTATE[HY000\] [2002] Connection refused</code></li></ol> <p>可能是配置文件缓存问题</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan cache:clear
php artisan config:cache
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>可能问题得不到解决</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>php artisan optimize:clear
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="2"><li>没有 现有目录储存/日志且不可构建:权限被拒绝</li></ol> <div class="language-php line-numbers-mode"><pre class="language-php"><code>php artisan optimize<span class="token punctuation">:</span>clear
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>清除所有缓存,但是可能导致其它问题</p> <ol start="3"><li><code>(PDOException(code: HY000): SQLSTATE[HY000]: General error: 1364 Field 'title' doesn't have a default value at</code></li></ol> <p>将<code>database</code>文件中<code>sql</code>配置项的<code>strict</code>严格改为 false</p></div> <!----> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后一次修改于: </span> <span class="time">10/22/2019, 1:20:35 PM</span></div></footer> <!----> </main> <div class="valine-wrapper" data-v-5029e45b><div id="valine" data-v-5029e45b></div></div></div> <div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;background-color:rgba(231, 234, 241,.5);display:none;" data-v-cd623d78 data-v-cd623d78><i class="iconfont reco-up" data-v-cd623d78></i></div></div></div></div><div class="global-ui"><div class="kanbanniang" data-v-3a90f39c><div class="banniang-container" style="display:;" data-v-3a90f39c><div class="messageBox" style="position:fixed;right:80px;bottom:195px;display:none;" data-v-3a90f39c>
      欢迎来到 LLORZ-O
    </div> <div class="operation" style="display:none;" data-v-3a90f39c><i class="iconfont icon-ban-home ban-home" data-v-3a90f39c></i> <i class="iconfont icon-aliicon-copy message" data-v-3a90f39c></i> <i class="iconfont icon-close close" data-v-3a90f39c></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-3a90f39c><i class="iconfont icon-info info" data-v-3a90f39c></i></a> <i class="iconfont icon-theme skin" style="display:none;" data-v-3a90f39c></i></div> <canvas id="banniang" width="150" height="220" class="live2d" style="position:fixed;right:90px;bottom:-20px;opacity:0.9;" data-v-3a90f39c></canvas></div> <div class="showBanNiang" style="display:none;" data-v-3a90f39c>
    看板娘
  </div></div></div></div>
    <script src="/assets/js/app.47c924c6.js" defer></script><script src="/assets/js/4.4a909b2e.js" defer></script><script src="/assets/js/1.412fd552.js" defer></script><script src="/assets/js/21.f77bec32.js" defer></script>
  </body>
</html>
