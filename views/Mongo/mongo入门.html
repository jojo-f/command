<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mongodb | LLORZ-O</title>
    <meta name="description" content="与君共勉">
    <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.cc085390.css" as="style"><link rel="preload" href="/assets/js/app.47c924c6.js" as="script"><link rel="preload" href="/assets/js/4.4a909b2e.js" as="script"><link rel="preload" href="/assets/js/1.412fd552.js" as="script"><link rel="preload" href="/assets/js/18.7f22e8b6.js" as="script"><link rel="prefetch" href="/assets/js/10.bee858e5.js"><link rel="prefetch" href="/assets/js/11.38f4443d.js"><link rel="prefetch" href="/assets/js/12.33d57f5f.js"><link rel="prefetch" href="/assets/js/13.9a85efae.js"><link rel="prefetch" href="/assets/js/14.68e24796.js"><link rel="prefetch" href="/assets/js/15.93441024.js"><link rel="prefetch" href="/assets/js/16.b6333f12.js"><link rel="prefetch" href="/assets/js/17.fb733925.js"><link rel="prefetch" href="/assets/js/19.4a71e6a8.js"><link rel="prefetch" href="/assets/js/2.90ebb111.js"><link rel="prefetch" href="/assets/js/20.9e7175ec.js"><link rel="prefetch" href="/assets/js/21.f77bec32.js"><link rel="prefetch" href="/assets/js/22.412c9495.js"><link rel="prefetch" href="/assets/js/23.03ee322c.js"><link rel="prefetch" href="/assets/js/24.1ba7bd6b.js"><link rel="prefetch" href="/assets/js/25.fa44eb9e.js"><link rel="prefetch" href="/assets/js/26.4e0ceaae.js"><link rel="prefetch" href="/assets/js/27.ef71ef9a.js"><link rel="prefetch" href="/assets/js/28.65489282.js"><link rel="prefetch" href="/assets/js/29.594894eb.js"><link rel="prefetch" href="/assets/js/30.d70d1394.js"><link rel="prefetch" href="/assets/js/31.f134f541.js"><link rel="prefetch" href="/assets/js/5.f232a475.js"><link rel="prefetch" href="/assets/js/6.ed43c739.js"><link rel="prefetch" href="/assets/js/7.b0e2ce4c.js"><link rel="prefetch" href="/assets/js/8.f5102ae2.js"><link rel="prefetch" href="/assets/js/9.33224a89.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cc085390.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container"><div><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/head.jpg" alt="LLORZ-O" class="logo"> <span class="site-name">LLORZ-O</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><!----> <div class="dark-theme-options toggle-option"><label for="dark-theme-toggle">Enable Dark Theme?</label> <input id="dark-theme-toggle" type="checkbox" checked="checked"></div></div></div></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/代码.html" class="nav-link"><i class="iconfont undefined"></i>
  代码
</a></li><li class="dropdown-item"><!----> <a href="/category/Tools.html" class="nav-link"><i class="iconfont undefined"></i>
  Tools
</a></li><li class="dropdown-item"><!----> <a href="/category/Chaos.html" class="nav-link"><i class="iconfont undefined"></i>
  Chaos
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><a href="/say/" class="nav-link"><i class="iconfont reco-account"></i>
  说说
</a></div><div class="nav-item"><a href="/collection/" class="nav-link"><i class="iconfont reco-other"></i>
  收藏
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      关于我
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Mrzhoulichao" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="/unpack/about.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于我
</a></li><li class="dropdown-item"><!----> <a href="/unpack/memo.html" class="nav-link"><i class="iconfont reco-document"></i>
  备忘录
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/代码.html" class="nav-link"><i class="iconfont undefined"></i>
  代码
</a></li><li class="dropdown-item"><!----> <a href="/category/Tools.html" class="nav-link"><i class="iconfont undefined"></i>
  Tools
</a></li><li class="dropdown-item"><!----> <a href="/category/Chaos.html" class="nav-link"><i class="iconfont undefined"></i>
  Chaos
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><a href="/say/" class="nav-link"><i class="iconfont reco-account"></i>
  说说
</a></div><div class="nav-item"><a href="/collection/" class="nav-link"><i class="iconfont reco-other"></i>
  收藏
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      关于我
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Mrzhoulichao" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="/unpack/about.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于我
</a></li><li class="dropdown-item"><!----> <a href="/unpack/memo.html" class="nav-link"><i class="iconfont reco-document"></i>
  备忘录
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Mongodb</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#安装" class="sidebar-link">安装</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#基本命令" class="sidebar-link">基本命令</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#库操作" class="sidebar-link">库操作</a></li></ul></li><li><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#js写mongo" class="sidebar-link">js写mongo</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#batch-insert-批量插入" class="sidebar-link">batch insert 批量插入</a></li><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#插入性能对比" class="sidebar-link">插入性能对比</a></li><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#插入文档" class="sidebar-link">插入文档</a></li><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#更新文档" class="sidebar-link">更新文档</a></li><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#删除文档" class="sidebar-link">删除文档</a></li><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#查询文档-条件查询" class="sidebar-link">查询文档&amp;条件查询</a></li><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#type" class="sidebar-link">$type</a></li><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#limit-skip" class="sidebar-link">limit &amp; skip</a></li><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#排序" class="sidebar-link">排序</a></li></ul></li><li><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#索引" class="sidebar-link">索引</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#全文索引" class="sidebar-link">全文索引</a></li><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#索引限制" class="sidebar-link">索引限制</a></li></ul></li><li><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#聚合" class="sidebar-link">聚合</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#管道符" class="sidebar-link">管道符</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#复制（副本集）" class="sidebar-link">复制（副本集）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#创建副本集" class="sidebar-link">创建副本集</a></li><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#配置主从权重" class="sidebar-link">配置主从权重</a></li></ul></li><li><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#分片" class="sidebar-link">分片</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#备份与恢复" class="sidebar-link">备份与恢复</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#备份" class="sidebar-link">备份</a></li><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#恢复" class="sidebar-link">恢复</a></li></ul></li><li><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#监控" class="sidebar-link">监控</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#状态返回与安全" class="sidebar-link">状态返回与安全</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#mongodb-用户群" class="sidebar-link">mongoDB 用户群</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#数据库关系" class="sidebar-link">数据库关系</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#嵌入式关系" class="sidebar-link">嵌入式关系</a></li><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#引用式关系" class="sidebar-link">引用式关系</a></li></ul></li><li><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#数据库引用" class="sidebar-link">数据库引用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#dbrefs" class="sidebar-link">DBRefs</a></li></ul></li><li><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#查询分析" class="sidebar-link">查询分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#explain" class="sidebar-link">explain()</a></li><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#hint-参照索引篇-hint" class="sidebar-link">hint() 参照索引篇 hint</a></li></ul></li><li><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#原子操作" class="sidebar-link">原子操作</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#objectid" class="sidebar-link">ObjectId</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#map-reduce" class="sidebar-link">Map Reduce</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#正则" class="sidebar-link">正则</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#固定集合" class="sidebar-link">固定集合</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#使用场景" class="sidebar-link">使用场景</a></li></ul></li><li><a href="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html#图形化管理工具" class="sidebar-link">图形化管理工具</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><main class="page reco-hide"> <div class="page-title"><h1>Mongodb</h1> <hr> <div data-v-362e684e><i class="iconfont reco-account" data-v-362e684e><span data-v-362e684e>T9</span></i> <i class="iconfont reco-date" data-v-362e684e><span data-v-362e684e>2019-6-28</span></i> <span id="/views/Mongo/mongo%E5%85%A5%E9%97%A8.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-2e99e05a data-v-362e684e><i class="iconfont reco-eye" style="margin-right: .5rem" data-v-2e99e05a></i> <a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;" data-v-2e99e05a></a></span> <i class="iconfont reco-tag tags" data-v-362e684e><span class="tag-item" data-v-362e684e>
      MongoDB
    </span><span class="tag-item" data-v-362e684e>
      数据库
    </span></i></div></div> <div class="content__default"><blockquote><p><code>MongoDB</code>的基本特性,选择性的过一遍</p></blockquote> <h2 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h2> <p>安装太过简单就不介绍了，只说重点</p> <ol><li><p>安装完配置<strong>环境变量</strong></p> <p>将<code>mongodb</code>安装目录下的<code>bin</code>目录的完整路径拷贝，复制到<code>window</code>的环境变量中</p></li> <li><p>在 <code>c</code> 盘根目录下新建 <code>data/db</code> 的目录</p></li> <li><p>启动主进程 <code>mongod</code></p></li> <li><p>启动操作进程 <code>mongo</code></p></li></ol> <h2 id="基本命令"><a href="#基本命令" class="header-anchor">#</a> 基本命令</h2> <ol><li><code>show dbs</code>查看本地的数据库</li> <li><code>db.version()</code> 查看版本号</li> <li><code>var a = 'a'</code> 类似 <code>javascript</code> ，也可以直接定义函数参考 <code>node</code> 的 <code>REPL</code></li> <li><code>print(a)</code> 输出至控制台</li></ol> <div class="language-shell line-numbers-mode"><pre class="language-text"><code>
&gt; show dbs
admin   0.000GB
config  0.000GB
local   0.000GB
&gt; db.version()
4.0.4
&gt; var a = 'zhou'
&gt; porint(a)
&gt; print(a)
zhou
&gt; function show(){
... return 'zhoulichao'
... }
&gt; print(show())
zhoulichao
&gt;  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="库操作"><a href="#库操作" class="header-anchor">#</a> 库操作</h3> <ol><li><code>use &lt;library name&gt;</code> 进入数据库 成功:<code>switched to db &lt;library name&gt;</code></li> <li><code>show collections</code> 展示数据库的集合</li> <li><code>db</code> 查看当前操作的所在库，类似<code>git</code>中的 <code>git branch</code>查看当前分支</li> <li><code>use &lt;new library name&gt;</code> 新建库</li> <li><code>db.user.insert({&quot;name&quot;:&quot;zhoulichao&quot;})</code> 插入数据</li> <li><code>db.user.find()</code> 查询所有数据</li> <li><code>db.user.findOne()</code> 查询第一条</li> <li><code>db.user.update(Object\&lt;String&gt;,Object\&lt;String&gt;)</code> 更新，更改一条数据</li> <li><code>db.user.remove({&quot;name&quot;:&quot;zhoulichao&quot;})</code> 删除某一条</li> <li><code>db.user.drop()</code> 整个集合</li> <li><code>db.dropDatabase( )</code> 一定要先进入数据库，然后再删除</li></ol> <div class="language-shell line-numbers-mode"><pre class="language-text"><code>
&gt; db.user.insert({&quot;name&quot;:&quot;Ruth&quot;})
WriteResult({ &quot;nInserted&quot; : 1 })
&gt; db.user.find()
{ &quot;_id&quot; : ObjectId(&quot;5d14e920b5ee2454bccd1598&quot;), &quot;name&quot; : &quot;zhoulichao&quot; }
{ &quot;_id&quot; : ObjectId(&quot;5d14e971b5ee2454bccd1599&quot;), &quot;name&quot; : &quot;ruth&quot; }
{ &quot;_id&quot; : ObjectId(&quot;5d14e97bb5ee2454bccd159a&quot;), &quot;name&quot; : &quot;HanMeiMei&quot; }
{ &quot;_id&quot; : ObjectId(&quot;5d14ea1cb5ee2454bccd159c&quot;), &quot;name&quot; : &quot;Ruth&quot; }
&gt; db.user.findOne()
{ &quot;_id&quot; : ObjectId(&quot;5d14e920b5ee2454bccd1598&quot;), &quot;name&quot; : &quot;zhoulichao&quot; }
&gt; db.user.update({&quot;name&quot;:&quot;zhoulichao&quot;},{&quot;name&quot;:&quot;zhoulichao&quot;,&quot;age&quot;:&quot;23&quot;,&quot;gender&quot;:&quot;male&quot;}))
WriteResult({ &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 })
&gt; db.user.findOne()
{
        &quot;_id&quot; : ObjectId(&quot;5d14e920b5ee2454bccd1598&quot;),
        &quot;name&quot; : &quot;zhoulichao&quot;,
        &quot;age&quot; : &quot;23&quot;,
        &quot;gender&quot; : &quot;male&quot;
}
&gt; db.user.remove({&quot;name&quot;:&quot;zhoulichao&quot;})
WriteResult({ &quot;nRemoved&quot; : 1 })
&gt; db.user.find()
{ &quot;_id&quot; : ObjectId(&quot;5d14e971b5ee2454bccd1599&quot;), &quot;name&quot; : &quot;ruth&quot; }
{ &quot;_id&quot; : ObjectId(&quot;5d14e97bb5ee2454bccd159a&quot;), &quot;name&quot; : &quot;HanMeiMei&quot; }
{ &quot;_id&quot; : ObjectId(&quot;5d14ea1cb5ee2454bccd159c&quot;), &quot;name&quot; : &quot;Ruth&quot; }
&gt; db.user.drop()
true


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><div class="custom-block tip"><p>mongodb采用小驼峰命名法</p></div> <h2 id="js写mongo"><a href="#js写mongo" class="header-anchor">#</a> js写mongo</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token keyword">var</span> user_name <span class="token operator">=</span> <span class="token string">'zhoulichao'</span>
<span class="token keyword">var</span> timeStamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;loginname&quot;</span><span class="token punctuation">:</span>user_name<span class="token punctuation">,</span>
    <span class="token string">&quot;logintime&quot;</span><span class="token punctuation">:</span>timeStamp
<span class="token punctuation">}</span>
<span class="token keyword">var</span> db <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'log'</span><span class="token punctuation">)</span> <span class="token comment">// 链接数据库，没有则创建</span>
db<span class="token punctuation">.</span>login<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">// 在 login 集合中插入 data 数据，没有则创建</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'[demo]: log print success'</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><blockquote><p>这里的js建议使用<code>var</code> 来命名变量，如果使用 <code>let</code> 命名 <code>db</code> 时会产生一个预期之外的错误。其他的变量如<code>user_name,timeStamp,data</code>则不会产生该错误，
鉴于避免未知错误的发生，应避免使用 <code>let</code></p></blockquote> <h3 id="batch-insert-批量插入"><a href="#batch-insert-批量插入" class="header-anchor">#</a> batch insert 批量插入</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token comment">// 以数组形式就是批量插入</span>
    <span class="token punctuation">{</span>
        <span class="token string">&quot;_id&quot;</span><span class="token punctuation">:</span><span class="token number">1</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">,</span><span class="token punctuation">{</span>
        <span class="token string">&quot;_id&quot;</span><span class="token punctuation">:</span><span class="token number">2</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">,</span><span class="token punctuation">{</span>
        <span class="token string">&quot;_id&quot;</span><span class="token punctuation">:</span><span class="token number">3</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

<span class="token keyword">var</span> db <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>

db<span class="token punctuation">.</span>batch<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'[test]: batch insert success'</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><blockquote><p>批量插入单次数据量不可超过 <code>48m</code>，<code>3.2</code>之前的版本使用<code>batchInsert()</code></p></blockquote> <h3 id="插入性能对比"><a href="#插入性能对比" class="header-anchor">#</a> 插入性能对比</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token comment">/* 测试批量插入与循环插入的性能 */</span>

<span class="token keyword">var</span> origin_data <span class="token operator">=</span> <span class="token string">'qwertyuiopasdfghjklzxcvbnm1234567890_-'</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    len <span class="token operator">=</span> origin_data<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
    data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">var</span> <span class="token function-variable function">generation</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> random <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> len<span class="token punctuation">)</span>
    <span class="token keyword">return</span> origin_data<span class="token punctuation">[</span>random<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">len_generation</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">min<span class="token punctuation">,</span>max</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>max <span class="token operator">-</span>min<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> min
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">str_generation</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        res <span class="token operator">+=</span> <span class="token function">generation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">data_generation</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> num <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        data<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            name<span class="token punctuation">:</span><span class="token function">str_generation</span><span class="token punctuation">(</span><span class="token function">len_generation</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            text<span class="token punctuation">:</span><span class="token function">str_generation</span><span class="token punctuation">(</span><span class="token function">len_generation</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token function">data_generation</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> db <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span> <span class="token comment">// 连接一个数据库，没有则创建</span>

<span class="token keyword">var</span> <span class="token function-variable function">cycle</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> begin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        db<span class="token punctuation">.</span>diff<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token comment">// 在当前库的集合中插入，没有则创建</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">,</span> <span class="token string">'cycle insert ms'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">batch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> begin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    db<span class="token punctuation">.</span>diff<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">,</span> <span class="token string">'batch insert ms'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">cycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">batch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 50 cycle insert ms</span>
<span class="token comment">// 2 batch insert ms</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>毫无疑问批量插入是最快的方式</p> <h3 id="插入文档"><a href="#插入文档" class="header-anchor">#</a> 插入文档</h3> <ol><li>inset(data:Object||Array) // 使用数组即为批量插入</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
<span class="token punctuation">{</span>id<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>id<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="2"><li>save([ id:Object&lt;String&gt;,])</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 不指定id字段即为插入,指定id则为更新, 注意该id为对象id，你无法直接写入 {_id:''}, 这种方式并没有什么卵用</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="更新文档"><a href="#更新文档" class="header-anchor">#</a> 更新文档</h3> <ol><li>update(query :Object,update:Object,[upsert :Boolean,multi :Boolean,writeConcern :Object])</li></ol> <ul><li>**query ** update的查询条件</li> <li>**update **  update的对象和一些更新的操作符</li> <li>**upsert ** 如果该条记录不存在是否直接插入，default:false { 不插入 }</li> <li>**multi ** default：false { 只更新找到的第一条数据 }</li> <li>**writeConcern ** 抛出异常级别</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token comment">//只更新第一条记录：</span>

db<span class="token punctuation">.</span>col<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token string">&quot;count&quot;</span> <span class="token punctuation">:</span> <span class="token punctuation">{</span> $gt <span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span> $<span class="token keyword">set</span> <span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;test2&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//全部更新：</span>

db<span class="token punctuation">.</span>col<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token string">&quot;count&quot;</span> <span class="token punctuation">:</span> <span class="token punctuation">{</span> $gt <span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span> $<span class="token keyword">set</span> <span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;test2&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//只添加第一条：</span>

db<span class="token punctuation">.</span>col<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token string">&quot;count&quot;</span> <span class="token punctuation">:</span> <span class="token punctuation">{</span> $gt <span class="token punctuation">:</span> <span class="token number">4</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span> $<span class="token keyword">set</span> <span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;test5&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//全部添加进去:</span>

db<span class="token punctuation">.</span>col<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token string">&quot;count&quot;</span> <span class="token punctuation">:</span> <span class="token punctuation">{</span> $gt <span class="token punctuation">:</span> <span class="token number">5</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span> $<span class="token keyword">set</span> <span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;test5&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//全部更新：</span>

db<span class="token punctuation">.</span>col<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token string">&quot;count&quot;</span> <span class="token punctuation">:</span> <span class="token punctuation">{</span> $gt <span class="token punctuation">:</span> <span class="token number">15</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span> $inc <span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;count&quot;</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//只更新第一条记录：</span>

db<span class="token punctuation">.</span>col<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token string">&quot;count&quot;</span> <span class="token punctuation">:</span> <span class="token punctuation">{</span> $gt <span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">,</span> <span class="token punctuation">{</span> $inc <span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;count&quot;</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//修改嵌套内容</span>
db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span><span class="token string">'zhoulichao'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    $<span class="token keyword">set</span><span class="token punctuation">:</span><span class="token punctuation">{</span>
        skill<span class="token punctuation">.</span>skillOne<span class="token punctuation">:</span><span class="token string">'这条数据就是该文档的 skill 对象下的 skillOne 数据'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><ol start="2"><li>save(document:Object,writeConcern :Object)</li></ol> <ul><li><strong>document</strong> 保存的数据，如果传入id就是覆盖该id原来的数据，不传入则是插入</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    _id<span class="token punctuation">:</span><span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">'56064f89ade2f21f36b03136'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span><span class="token string">'超人不穿内裤'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="删除文档"><a href="#删除文档" class="header-anchor">#</a> 删除文档</h3> <ol><li>remove([query :Object,[justOne :Boolean,[writeConcern :Object]]])</li></ol> <ul><li><strong>query</strong> 删除的文档的条件</li> <li><strong>justOne</strong> default:false 删除所有匹配条件的文档</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
db<span class="token punctuation">.</span>user_info<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    _id<span class="token punctuation">:</span><span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">'5d1a014af39338a5301ebea7'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="查询文档-条件查询"><a href="#查询文档-条件查询" class="header-anchor">#</a> 查询文档&amp;条件查询</h3> <ol><li>find([query :Object,[projection :??]])</li></ol> <ul><li><strong>query</strong> 查询条件</li> <li><strong>projection</strong> 使用投影操作符指定返回的键。查询时返回文档中所有键值</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>user_info<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    _id<span class="token punctuation">:</span><span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">'5d1a014af39338a5301ebea9'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="2"><li>pretty() find的修饰符,用于以格式化的方式来显示所有文档。</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>user_info<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pretty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="3"><li>findOne ([query :Object,[projection :??]])  返回一个文档</li> <li>where 语句</li></ol> <table><thead><tr><th style="text-align:center;">操作</th> <th>格式</th></tr></thead> <tbody><tr><td style="text-align:center;">等于</td> <td>{k:v}</td></tr> <tr><td style="text-align:center;">小于</td> <td>{k:{$lt:v}}</td></tr> <tr><td style="text-align:center;">小于等于</td> <td>{k:{$lte:v}}</td></tr> <tr><td style="text-align:center;">大于</td> <td>{k:{$gt:v}}</td></tr> <tr><td style="text-align:center;">大于等于</td> <td>{k:{$gte:v}}</td></tr> <tr><td style="text-align:center;">不等</td> <td>{k:{$ne:v}}</td></tr></tbody></table> <ol start="5"><li>AND</li></ol> <div class="language-JS line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span><span class="token string">'liu'</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span><span class="token number">12</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 多个查询条件既是 and</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="6"><li>OR</li></ol> <div class="language-JS line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    $or<span class="token punctuation">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">'liu'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>age<span class="token punctuation">:</span><span class="token punctuation">{</span>
            $lt<span class="token punctuation">:</span><span class="token number">20</span>， <span class="token comment">// 小于20</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol start="7"><li>AND <strong>+</strong> OR</li></ol> <div class="language-JS line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span><span class="token string">'liu'</span><span class="token punctuation">,</span>
    $or<span class="token punctuation">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>age<span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>age<span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="8"><li>模糊查询</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span><span class="token regex">/^周/</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="type"><a href="#type" class="header-anchor">#</a> $type</h3> <table><thead><tr><th><strong>类型</strong></th> <th><strong>数字</strong></th> <th><strong>备注</strong></th></tr></thead> <tbody><tr><td>Double</td> <td>1</td> <td></td></tr> <tr><td>String</td> <td>2</td> <td></td></tr> <tr><td>Object</td> <td>3</td> <td></td></tr> <tr><td>Array</td> <td>4</td> <td></td></tr> <tr><td>Binary data</td> <td>5</td> <td></td></tr> <tr><td>Undefined</td> <td>6</td> <td>已废弃。</td></tr> <tr><td>Object id</td> <td>7</td> <td></td></tr> <tr><td>Boolean</td> <td>8</td> <td></td></tr> <tr><td>Date</td> <td>9</td> <td></td></tr> <tr><td>Null</td> <td>10</td> <td></td></tr> <tr><td>Regular Expression</td> <td>11</td> <td></td></tr> <tr><td>JavaScript</td> <td>13</td> <td></td></tr> <tr><td>Symbol</td> <td>14</td> <td></td></tr> <tr><td>JavaScript (with scope)</td> <td>15</td> <td></td></tr> <tr><td>32-bit integer</td> <td>16</td> <td></td></tr> <tr><td>Timestamp</td> <td>17</td> <td></td></tr> <tr><td>64-bit integer</td> <td>18</td> <td></td></tr> <tr><td>Min key</td> <td>255</td> <td>Query with <code>-1</code>.</td></tr> <tr><td>Max key</td> <td>127</td> <td></td></tr></tbody></table> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// EXAMPLE </span>
db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span><span class="token punctuation">{</span>
        $type<span class="token punctuation">:</span><span class="token string">'string'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// EXAMPLE</span>
db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span><span class="token punctuation">{</span>
        $type<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="limit-skip"><a href="#limit-skip" class="header-anchor">#</a> limit &amp; skip</h3> <ol><li>limit(num :Number)</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 返回查询集中的两条</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="2"><li>skit(num :Number)</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// 跳过前10条数据</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="排序"><a href="#排序" class="header-anchor">#</a> 排序</h3> <ol><li>sort(condition :Object)</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>test<span class="token punctuation">.</span>find<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    age<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 升序， -1 降序</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>! skip(), limilt(), sort()三个放在一起执行的时候，执行的顺序是先 sort(), 然后是 skip()，最后是显示的 limit()。</p></blockquote> <h2 id="索引"><a href="#索引" class="header-anchor">#</a> 索引</h2> <ol><li>createIndex(key :Object [,opts : Object])</li></ol> <table><thead><tr><th>Parameter</th> <th>Type</th> <th>Description</th></tr></thead> <tbody><tr><td>background</td> <td>Boolean</td> <td>建索引过程会阻塞其它数据库操作，background可指定以后台方式创建索引，即增加 &quot;background&quot; 可选参数。 &quot;background&quot; 默认值为<strong>false</strong>。</td></tr> <tr><td>unique</td> <td>Boolean</td> <td>建立的索引是否唯一。指定为true创建唯一索引。默认值为<strong>false</strong>.</td></tr> <tr><td>name</td> <td>string</td> <td>索引的名称。如果未指定，MongoDB的通过连接索引的字段名和排序顺序生成一个索引名称。</td></tr> <tr><td>dropDups</td> <td>Boolean</td> <td>3.0+版本已废弃。在建立唯一索引时是否删除重复记录,指定 true 创建唯一索引。默认值为 <strong>false</strong>.</td></tr> <tr><td>sparse</td> <td>Boolean</td> <td>对文档中不存在的字段数据不启用索引；这个参数需要特别注意，如果设置为true的话，在索引字段中不会查询出不包含对应字段的文档.。默认值为 <strong>false</strong>.</td></tr> <tr><td>expireAfterSeconds</td> <td>integer</td> <td>指定一个以秒为单位的数值，完成 TTL设定，设定集合的生存时间。</td></tr> <tr><td>v</td> <td>index version</td> <td>索引的版本号。默认的索引版本取决于mongod创建索引时运行的版本。</td></tr> <tr><td>weights</td> <td>document</td> <td>索引权重值，数值在 1 到 99,999 之间，表示该索引相对于其他索引字段的得分权重。</td></tr> <tr><td>default_language</td> <td>string</td> <td>对于文本索引，该参数决定了停用词及词干和词器的规则的列表。 默认为英语</td></tr> <tr><td>language_override</td> <td>string</td> <td>对于文本索引，该参数指定了包含在文档中的字段名，语言覆盖默认的language，默认值为 language.</td></tr></tbody></table> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// EXAMPLE</span>
db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    age<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 升序or -1 降序索引</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// EXMPLE 多字段索引</span>
db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    age<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span> 
    name<span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol start="2"><li>ensureIndex(key :Object)</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// EXMPLE 多字段索引</span>
db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">ensureIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    age<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span> 
    name<span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="3"><li>getIndexes()  查看集合索引</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">getIndexes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="4"><li>totalIndexSize() 查看集合索引大小</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">totalIndexSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="5"><li>dropIndexes() 删除所有索引</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">dropIndexes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="6"><li>dropIndex(name :String) 删除集合指定索引</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">dropIndex</span><span class="token punctuation">(</span><span class="token string">&quot;索引名称&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="7"><li>hint(key :Object) 指定索引查询</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span><span class="token string">'zhou'</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span><span class="token string">'23'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hint</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    age<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 指定字段为 1，代表开启该字段为优先使用的索引值。</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// hint 用于复合索引</span>
<span class="token comment">// 在同时拥有多个索引的情况下 mongo 会在索引表中一项一项的进行查找，按照默认顺序，如果索引表中name在前，那么就优先使用name进行索引</span>
<span class="token comment">// 但是，在数据库中，数字索引的速度远高于字符索引，所以在海量数据查找中，可以使用 hint 指定优先使用数字索引 </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>! 利用 TTL 集合对存储的数据进行失效时间设置 ,到达指定时间自动删除索引,</p> <p>mongoDB 每个集合最多64个索引值</p> <p>索引建立好后直接使用 <code>find ({name:'zhou'})</code>查询索引字段就行了.</p> <p>因为普通查询默认包含 _id 字段，如果在普通查询和索引查询具有相同字段时禁用 _id 字段，就会导致普通查询被索引查询所覆盖。这样能提高查询速度</p> <p>多使用 <a href="#explain()">explain </a>检测是否能使用索引</p></blockquote> <h3 id="全文索引"><a href="#全文索引" class="header-anchor">#</a> 全文索引</h3> <ol><li>db.test.ensureIndex({conText:'text' })  使用text关键词来代表全文索引</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    $text<span class="token punctuation">:</span><span class="token punctuation">{</span>
        $search<span class="token punctuation">:</span><span class="token string">&quot;\&quot;站点信息\&quot;非我&quot;</span>， <span class="token comment">// 使用 反斜杠转义查询多个字段</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="索引限制"><a href="#索引限制" class="header-anchor">#</a> 索引限制</h3> <ul><li>数据不超万条时，不需要使用索引。性能的提升并不明显，而大大增加了内存和硬盘的消耗。</li> <li>查询数据超过表数据量30%时，不要使用索引字段查询。实际证明会比不使用索引更慢，因为它大量检索了索引表和我们原表。</li> <li>数字索引，要比字符串索引快的多，在百万级甚至千万级数据量面前，使用数字索引是个明确的选择。</li> <li>把你经常查询的数据做成一个内嵌数据（对象型的数据），然后集体进行索引</li> <li>索引储存在内存，所以索引不应超过内存大小</li> <li>索引不能被一下查询使用
<ul><li>正则表达式，非操作符，$nin,$not..</li> <li>算数运算符 $mod..</li> <li>$where 子句</li></ul></li> <li>索引名的长度不能超过128个字符</li> <li>一个复合索引最多可以有31个字段</li></ul> <h2 id="聚合"><a href="#聚合" class="header-anchor">#</a> 聚合</h2> <ol><li>aggregate()</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>diff<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
    $group<span class="token punctuation">:</span><span class="token punctuation">{</span>
        _id<span class="token punctuation">:</span><span class="token string">'$name'</span><span class="token punctuation">,</span>
        count<span class="token punctuation">:</span><span class="token punctuation">{</span>
            $sum<span class="token punctuation">:</span><span class="token number">1</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>聚合表达式</strong></p> <table><thead><tr><th>表达式</th> <th>描述</th> <th>实例</th></tr></thead> <tbody><tr><td>$sum</td> <td>计算总和。</td> <td>db.mycol.aggregate([{$group : {_id : &quot;$by_user&quot;, num_tutorial : {$sum : &quot;$likes&quot;}}}])</td></tr> <tr><td>$avg</td> <td>计算平均值</td> <td>db.mycol.aggregate([{$group : {_id : &quot;$by_user&quot;, num_tutorial : {$avg : &quot;$likes&quot;}}}])</td></tr> <tr><td>$min</td> <td>获取集合中所有文档对应值得最小值。</td> <td>db.mycol.aggregate([{$group : {_id : &quot;$by_user&quot;, num_tutorial : {$min : &quot;$likes&quot;}}}])</td></tr> <tr><td>$max</td> <td>获取集合中所有文档对应值得最大值。</td> <td>db.mycol.aggregate([{$group : {_id : &quot;$by_user&quot;, num_tutorial : {$max : &quot;$likes&quot;}}}])</td></tr> <tr><td>$push</td> <td>在结果文档中插入值到一个数组中。</td> <td>db.mycol.aggregate([{$group : {_id : &quot;$by_user&quot;, url : {$push: &quot;$url&quot;}}}])</td></tr> <tr><td>$addToSet</td> <td>在结果文档中插入值到一个数组中，但不创建副本。</td> <td>db.mycol.aggregate([{$group : {_id : &quot;$by_user&quot;, url : {$addToSet : &quot;$url&quot;}}}])</td></tr> <tr><td>$first</td> <td>根据资源文档的排序获取第一个文档数据。</td> <td>db.mycol.aggregate([{$group : {_id : &quot;$by_user&quot;, first_url : {$first : &quot;$url&quot;}}}])</td></tr> <tr><td>$last</td> <td>根据资源文档的排序获取最后一个文档数据</td> <td>db.mycol.aggregate([{$group : {_id : &quot;$by_user&quot;, last_url : {$last : &quot;$url&quot;}}}])</td></tr></tbody></table> <h2 id="管道符"><a href="#管道符" class="header-anchor">#</a> 管道符</h2> <ol><li>$project 修改输入文档的结构。可以用来重命名、增加或删除域，也可以用于创建计算结果以及嵌套文档。</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> rs <span class="token operator">=</span> db<span class="token punctuation">.</span>runoob<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    $project<span class="token punctuation">:</span><span class="token punctuation">{</span>
        title<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>
        author<span class="token punctuation">:</span><span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 输出这两个字段的值， 注意 _id 为默认输出</span>
_id<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 可关闭id的默认输出</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol start="2"><li>$match：用于过滤数据，只输出符合条件的文档。match使用MongoDB的标准查询操作。</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> rs <span class="token operator">=</span> db<span class="token punctuation">.</span>runoob<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token comment">// 注意这里的数组，有多个限制条件时，使用数组</span>
    <span class="token punctuation">{</span>
        $match<span class="token punctuation">:</span><span class="token punctuation">{</span>
            likes<span class="token punctuation">:</span><span class="token punctuation">{</span>
                $gt<span class="token punctuation">:</span><span class="token number">70</span><span class="token punctuation">,</span> <span class="token comment">//大于</span>
                $lte<span class="token punctuation">:</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token comment">// 小于等于</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        $group<span class="token punctuation">:</span><span class="token punctuation">{</span>
            _id<span class="token punctuation">:</span><span class="token string">'$by_user'</span><span class="token punctuation">,</span>
            count<span class="token punctuation">:</span><span class="token punctuation">{</span>
                $sum<span class="token punctuation">:</span><span class="token number">1</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// 多个限制条件下，由数组中第一个限制条件返回的结果，进入第二个限制条件</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><ol start="3"><li>$limit  用来限制MongoDB聚合管道返回的文档数。</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> rs <span class="token operator">=</span> db<span class="token punctuation">.</span>runoob<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    $skip<span class="token punctuation">:</span><span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="4"><li>$unwind 将文档中的某一个数组类型字段拆分成多条，每条包含数组中的一个值。</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> rs <span class="token operator">=</span> db<span class="token punctuation">.</span>runoob<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    $unwind<span class="token punctuation">:</span><span class="token string">'tags'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 这在检索文章的标签时非常有用</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="5"><li>$group 将集合中的文档分组，可用于统计结果。</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>diff<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
    $group<span class="token punctuation">:</span><span class="token punctuation">{</span>
        _id<span class="token punctuation">:</span><span class="token string">'$name'</span><span class="token punctuation">,</span> <span class="token comment">// 按name属性进行分组</span>
        count<span class="token punctuation">:</span><span class="token punctuation">{</span>
            $sum<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 统计分组数量</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol start="6"><li>$sort  输入文档排序后输出</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> rs <span class="token operator">=</span> db<span class="token punctuation">.</span>runoob<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    $sort<span class="token punctuation">:</span><span class="token punctuation">{</span>
        likes<span class="token punctuation">:</span><span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="7"><li>$geoNear  输出接近某一地理位置的有序文档。</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="8"><li>时间聚合</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> rs <span class="token operator">=</span> db<span class="token punctuation">.</span>runoob<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>$match<span class="token punctuation">:</span><span class="token punctuation">{</span>m_id<span class="token punctuation">:</span><span class="token number">10001</span><span class="token punctuation">,</span>mark_time<span class="token punctuation">:</span><span class="token punctuation">{</span>$gt<span class="token punctuation">:</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token number">2017</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>$group<span class="token punctuation">:</span> <span class="token punctuation">{</span>
       _id<span class="token punctuation">:</span> <span class="token punctuation">{</span>$dayOfMonth<span class="token punctuation">:</span><span class="token string">'$mark_time'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        pv<span class="token punctuation">:</span> <span class="token punctuation">{</span>$sum<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>$sort<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>时间关键字如下：</p> <ul><li>$dayOfYear: 返回该日期是这一年的第几天（全年 366 天）。</li> <li>$dayOfMonth: 返回该日期是这一个月的第几天（1到31）。</li> <li>$dayOfWeek: 返回的是这个周的星期几（1：星期日，7：星期六）。</li> <li>$year: 返回该日期的年份部分。</li> <li>$month： 返回该日期的月份部分（ 1 到 12）。</li> <li>$week： 返回该日期是所在年的第几个星期（ 0 到 53）。</li> <li>$hour： 返回该日期的小时部分。</li> <li>$minute: 返回该日期的分钟部分。</li> <li>$second: 返回该日期的秒部分（以0到59之间的数字形式返回日期的第二部分，但可以是60来计算闰秒）。</li> <li>$millisecond：返回该日期的毫秒部分（ 0 到 999）。</li> <li>$dateToString： { $dateToString: { format: , date: } }。</li></ul> <h2 id="复制（副本集）"><a href="#复制（副本集）" class="header-anchor">#</a> 复制（副本集）</h2> <blockquote><p>复制可保障数据安全性，让数据具有高可用性，具有灾难恢复，无需停机维护，分布式读取数据的优点</p></blockquote> <blockquote><p>副本集是具有N个节点的集群，任何节点都可作为主节点，所有的写入操作都在主节点上，然后与副本集进行数据同步。副本集对故障能进行自动转移，自动恢复。</p></blockquote> <div class="language-shell line-numbers-mode"><pre class="language-text"><code>mongod --port 29077 --dbpath &quot;C:\data\fb01&quot; --replSet fb01
# 启动端口号为 29077 名为 fb01（副本01） 的mongoDB实例
mongo --port 29077
# 连接到 29077 端口副本集
rs.initiate()
# 启动新的副本集
rs.conf()
# 查看副本集的配置
rs.status()
# 查看副本集状态
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="创建副本集"><a href="#创建副本集" class="header-anchor">#</a> 创建副本集</h3> <div class="language-shell line-numbers-mode"><pre class="language-text"><code>mongod --port 29077 --dbpath &quot;C:\data\fb01&quot; --replSet fb01
mongod --port 29078 --dbpath &quot;C:\data\fb02&quot; --replSet fb01

mongo --port 29077

config = {
    _id:'fb01', # 副本集名称，多个副本的名称需要保持一致
    members:[
        {
            _id:0,
            host:'localhost:29077', # fb01
        },
        {
            _id:1,
            host:'localhost:29078', # fb01
        },
    ]
}

rs.initiate(config)
# 使用配置 初始化 副本集
{
        &quot;ok&quot; : 1,
        &quot;operationTime&quot; : Timestamp(1562401664, 1),
        &quot;$clusterTime&quot; : {
                &quot;clusterTime&quot; : Timestamp(1562401664, 1),
                &quot;signature&quot; : {
                        &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),
                        &quot;keyId&quot; : NumberLong(0)
                }
        }
}

fb01:PRIMARY&gt; rs.conf()
# 查看副本集状态
{
        &quot;_id&quot; : &quot;fb01&quot;,
        &quot;version&quot; : 1,
        &quot;protocolVersion&quot; : NumberLong(1),
        &quot;writeConcernMajorityJournalDefault&quot; : true,
        &quot;members&quot; : [ 		# 成员
                {
                        &quot;_id&quot; : 0,
                        &quot;host&quot; : &quot;localhost:29077&quot;,
                        &quot;arbiterOnly&quot; : false,
                        &quot;buildIndexes&quot; : true,
                        &quot;hidden&quot; : false,
                        &quot;priority&quot; : 1,
                        &quot;tags&quot; : {

                        },
                        &quot;slaveDelay&quot; : NumberLong(0),
                        &quot;votes&quot; : 1
                },
                {
                        &quot;_id&quot; : 1,
                        &quot;host&quot; : &quot;localhost:29078&quot;,
                        &quot;arbiterOnly&quot; : false,
                        &quot;buildIndexes&quot; : true,
                        &quot;hidden&quot; : false,
                        &quot;priority&quot; : 1,
                        &quot;tags&quot; : {

                        },
                        &quot;slaveDelay&quot; : NumberLong(0),
                        &quot;votes&quot; : 1
                }
        ],
        &quot;settings&quot; : {
                &quot;chainingAllowed&quot; : true,
                &quot;heartbeatIntervalMillis&quot; : 2000,
                &quot;heartbeatTimeoutSecs&quot; : 10,
                &quot;electionTimeoutMillis&quot; : 10000,
                &quot;catchUpTimeoutMillis&quot; : -1,
                &quot;catchUpTakeoverDelayMillis&quot; : 30000,
                &quot;getLastErrorModes&quot; : {

                },
                &quot;getLastErrorDefaults&quot; : {
                        &quot;w&quot; : 1,
                        &quot;wtimeout&quot; : 0
                },
                &quot;replicaSetId&quot; : ObjectId(&quot;5d205b80e6d0fbe7d5626d81&quot;)
        }
}

fb01:PRIMARY&gt; rs.isMaster()
# 查看当前副本 是否为主节点
{
        &quot;hosts&quot; : [
                &quot;localhost:29077&quot;,
                &quot;localhost:29078&quot;
        ],
        &quot;setName&quot; : &quot;fb01&quot;,
        &quot;setVersion&quot; : 1,
        &quot;ismaster&quot; : true,
        &quot;secondary&quot; : false,
        &quot;primary&quot; : &quot;localhost:29077&quot;,
        &quot;me&quot; : &quot;localhost:29077&quot;,
        &quot;electionId&quot; : ObjectId(&quot;7fffffff0000000000000001&quot;),
        &quot;lastWrite&quot; : {
                &quot;opTime&quot; : {
                        &quot;ts&quot; : Timestamp(1562401906, 1),
                        &quot;t&quot; : NumberLong(1)
                },
                &quot;lastWriteDate&quot; : ISODate(&quot;2019-07-06T08:31:46Z&quot;),
                &quot;majorityOpTime&quot; : {
                        &quot;ts&quot; : Timestamp(1562401906, 1),
                        &quot;t&quot; : NumberLong(1)
                },
                &quot;majorityWriteDate&quot; : ISODate(&quot;2019-07-06T08:31:46Z&quot;)
        },
        &quot;maxBsonObjectSize&quot; : 16777216,
        &quot;maxMessageSizeBytes&quot; : 48000000,
        &quot;maxWriteBatchSize&quot; : 100000,
        &quot;localTime&quot; : ISODate(&quot;2019-07-06T08:31:56.201Z&quot;),
        &quot;logicalSessionTimeoutMinutes&quot; : 30,
        &quot;minWireVersion&quot; : 0,
        &quot;maxWireVersion&quot; : 7,
        &quot;readOnly&quot; : false,
        &quot;ok&quot; : 1,
        &quot;operationTime&quot; : Timestamp(1562401906, 1),
        &quot;$clusterTime&quot; : {
                &quot;clusterTime&quot; : Timestamp(1562401906, 1),
                &quot;signature&quot; : {
                        &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),
                        &quot;keyId&quot; : NumberLong(0)
                }
        }
}

# 接着打开 从库 的shell面板
mongo --port 29078
rs.isMaster()
{
        &quot;hosts&quot; : [
                &quot;localhost:29077&quot;,
                &quot;localhost:29078&quot;
        ],
        &quot;setName&quot; : &quot;fb01&quot;,
        &quot;setVersion&quot; : 1,
        &quot;ismaster&quot; : false, # 非主节点
        &quot;secondary&quot; : true, # 副节点
        &quot;primary&quot; : &quot;localhost:29077&quot;,
        &quot;me&quot; : &quot;localhost:29078&quot;,
        &quot;lastWrite&quot; : {
                &quot;opTime&quot; : {
                        &quot;ts&quot; : Timestamp(1562402086, 1),
                        &quot;t&quot; : NumberLong(1)
                },
                &quot;lastWriteDate&quot; : ISODate(&quot;2019-07-06T08:34:46Z&quot;),
                &quot;majorityOpTime&quot; : {
                        &quot;ts&quot; : Timestamp(1562402086, 1),
                        &quot;t&quot; : NumberLong(1)
                },
                &quot;majorityWriteDate&quot; : ISODate(&quot;2019-07-06T08:34:46Z&quot;)
        },
        &quot;maxBsonObjectSize&quot; : 16777216,
        &quot;maxMessageSizeBytes&quot; : 48000000,
        &quot;maxWriteBatchSize&quot; : 100000,
        &quot;localTime&quot; : ISODate(&quot;2019-07-06T08:34:51.857Z&quot;),
        &quot;logicalSessionTimeoutMinutes&quot; : 30,
        &quot;minWireVersion&quot; : 0,
        &quot;maxWireVersion&quot; : 7,
        &quot;readOnly&quot; : false,
        &quot;ok&quot; : 1,
        &quot;operationTime&quot; : Timestamp(1562402086, 1),
        &quot;$clusterTime&quot; : {
                &quot;clusterTime&quot; : Timestamp(1562402086, 1),
                &quot;signature&quot; : {
                        &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),
                        &quot;keyId&quot; : NumberLong(0)
                }
        }
}
# 现在你直接 使用 show dbs 会报错
rs.slaveOk()
# 执行从库 的初始化
# 现在开始你在主库写入数据，从库也能实时同步了
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br></div></div><p><img src="http://yanxuan.nosdn.127.net/c3a740c6db2fc234a4e78af7933bc001.png" alt="mongodb主从副本集"></p> <h3 id="配置主从权重"><a href="#配置主从权重" class="header-anchor">#</a> 配置主从权重</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 注意需要在主库上操作</span>
cfg <span class="token operator">=</span> rs.conf<span class="token punctuation">(</span><span class="token punctuation">)</span>
cfg.members<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.priority <span class="token operator">=</span> <span class="token number">2</span>
cfg.members<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>.priority <span class="token operator">=</span> <span class="token number">1</span>
rs.reconfig<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="分片"><a href="#分片" class="header-anchor">#</a> 分片</h2> <p>分片配置</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>Shard <span class="token number">1</span>:27001 <span class="token comment"># 存储实际的数据块</span>
Shard <span class="token number">2</span>:27002
Shard <span class="token number">3</span>:27003
<span class="token comment"># 3.4 版本以后 config 必须为 集群</span>
Config Server:27000 conf01 <span class="token comment"># mongod实例,存储了整个集群元数据，包括分块信息</span>
Config Server:27222 conf01
Route Process:30000 <span class="token comment"># 前端路由，客户端由此接入</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>创建Shard Server (分片服务)</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>mongod --port <span class="token number">27001</span> --dbpath<span class="token operator">=</span>c:<span class="token punctuation">\</span>data<span class="token punctuation">\</span>shard<span class="token punctuation">\</span>s1
mongod --port <span class="token number">27002</span> --dbpath<span class="token operator">=</span>c:<span class="token punctuation">\</span>data<span class="token punctuation">\</span>shard<span class="token punctuation">\</span>s2
mongod --port <span class="token number">27003</span> --dbpath<span class="token operator">=</span>c:<span class="token punctuation">\</span>data<span class="token punctuation">\</span>shard<span class="token punctuation">\</span>s3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><a href="http://www.mongoing.com/docs/core/sharded-cluster-config-servers.html" target="_blank" rel="noopener noreferrer"><em>config servers</em><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：配置服务器存储群集的元数据和配置设置。从MongoDB 3.4开始，必须将配置服务器部署为副本集（CSRS） <em>参考官网文档</em></p> <p>创建 Config Server 副本集</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>mongod --port <span class="token number">27000</span> --dbpath <span class="token string">&quot;c:\data\shard<span class="token entity" title="\c">\c</span>onfig<span class="token entity" title="\f">\f</span>b01&quot;</span> --replSet fb01
mongod --port <span class="token number">27222</span> --dbpath <span class="token string">&quot;c:\data\shard<span class="token entity" title="\c">\c</span>onfig<span class="token entity" title="\f">\f</span>b02&quot;</span> --replSet fb01
mongo --port <span class="token number">27000</span>
config <span class="token operator">=</span> <span class="token punctuation">{</span>
    _id:<span class="token string">'fb01'</span>,
    member:<span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            _id:0,
            host:<span class="token string">'localhost:27000'</span>,
        <span class="token punctuation">}</span>,
         <span class="token punctuation">{</span>
            _id:1,
            host:<span class="token string">'localhost:27222'</span>,
        <span class="token punctuation">}</span>,
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
rs.initiate<span class="token punctuation">(</span>config<span class="token punctuation">)</span>
mongo --port <span class="token number">27222</span>
rs.slaveOk<span class="token punctuation">(</span><span class="token punctuation">)</span>
mongos --port <span class="token number">30000</span> --configdb fb01/localhost:27000,localhost:27222
mongo --port <span class="token number">30000</span> <span class="token comment"># ok 进行到这一步的时候卡壳了。。。</span>
<span class="token comment"># 关于错误，截至我写到这里时仍没有一个好的解决方法</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h2 id="备份与恢复"><a href="#备份与恢复" class="header-anchor">#</a> 备份与恢复</h2> <h3 id="备份"><a href="#备份" class="header-anchor">#</a> 备份</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 备份之前记得打开服务 mongo</span>
mongodump -h localhost:27017 -d <span class="token builtin class-name">test</span> -o c:<span class="token punctuation">\</span>data<span class="token punctuation">\</span>dump<span class="token punctuation">\</span>test
<span class="token comment"># -h 服务器地址</span>
<span class="token comment"># -d 数据库实例</span>
<span class="token comment"># -o 备份的数据输出目录</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><table><thead><tr><th style="text-align:center;">描述</th> <th style="text-align:center;">实例</th></tr></thead> <tbody><tr><td style="text-align:center;">备份所有数据</td> <td style="text-align:center;">mongodump --host localhost --port 27017</td></tr> <tr><td style="text-align:center;">指定数据输出指定目录</td> <td style="text-align:center;">mongodump --dbpath c:\data\db --out c:\data\dump\db</td></tr> <tr><td style="text-align:center;">备份指定数据库的集合</td> <td style="text-align:center;">mongodump --collection diff --db test</td></tr></tbody></table> <h3 id="恢复"><a href="#恢复" class="header-anchor">#</a> 恢复</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># mongorestore -h &lt;hostname&gt;&lt;:port&gt; -d dbname &lt;path&gt;</span>
<span class="token comment"># &lt;path&gt; 设置备份数据所在位置</span>
<span class="token comment"># --drop 用备份数据替换当前数据</span>
<span class="token comment"># --dir 指定备份的目录，无法同时指定&lt;path&gt; 和 --dir</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="监控"><a href="#监控" class="header-anchor">#</a> 监控</h2> <ol><li>mongostat  查看mongo状态</li> <li>mongotop &lt;sleeptime&gt; 提供每个集合的水平的统计数据</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// sleeptime 是每次数据的间隔</span>
<span class="token comment">// --locks 这个是报告每个数据库的锁的使用中状态，需要数据库具有锁状态</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="状态返回与安全"><a href="#状态返回与安全" class="header-anchor">#</a> 状态返回与安全</h2> <p>普通数据库操作方法并没有任何的状态返回，用户无法得知修改的结果。</p> <p><strong>因此在实际使用中应该采用应答式方法。</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>diff<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span><span class="token string">'zhou'</span><span class="token punctuation">,</span>
    text<span class="token punctuation">:</span><span class="token string">'feafeafea'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> resultState <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    getLastError<span class="token punctuation">:</span><span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">printjson</span><span class="token punctuation">(</span>resultState<span class="token punctuation">)</span>
<span class="token comment">// =&gt; </span>
<span class="token comment">/*

{
        &quot;connectionId&quot; : 1,
        &quot;updatedExisting&quot; : true,
        &quot;n&quot; : 2,
        &quot;syncMillis&quot; : 0,
        &quot;writtenTo&quot; : null,
        &quot;err&quot; : null,
        &quot;ok&quot; : 1
}

*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ol><li>db.listCommands( )  查看所有的Commad命令</li> <li>findAndModify 查找并修改</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> modify <span class="token operator">=</span> <span class="token punctuation">{</span>
    findAndModify<span class="token punctuation">:</span><span class="token string">'diff'</span><span class="token punctuation">,</span>
    query<span class="token punctuation">:</span><span class="token punctuation">{</span>
        name<span class="token punctuation">:</span><span class="token string">'zhou'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    update<span class="token punctuation">:</span><span class="token punctuation">{</span>
        $<span class="token keyword">set</span><span class="token punctuation">:</span><span class="token punctuation">{</span>
            age<span class="token punctuation">:</span><span class="token number">23</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span><span class="token punctuation">:</span><span class="token boolean">true</span> <span class="token comment">// 更新完成，true 为查看结果，flase 反之</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> rs <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">runCommand</span><span class="token punctuation">(</span>modify<span class="token punctuation">)</span>

<span class="token comment">/*

query：需要查询的条件/文档
sort: 进行排序
remove：[boolean]是否删除查找到的文档，值填写true，可以删除。
new:[boolean]返回更新前的文档还是更新后的文档。
fields：需要返回的字段
upsert：没有这个值是否增加

*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="mongodb-用户群"><a href="#mongodb-用户群" class="header-anchor">#</a> mongoDB 用户群</h2> <blockquote><p>mongodb 默认给用户使用的是最高权限的账号，但是这样会造成使用上的数据不安全性。</p> <p>所以我们有必要为数据库创建权限用户</p></blockquote> <ol><li>db.createUser()</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 你需要先进入 admin 文档</span>
db<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    user<span class="token punctuation">:</span><span class="token string">'zhoulicjhap'</span><span class="token punctuation">,</span>
    pwd<span class="token punctuation">:</span><span class="token string">'725361'</span><span class="token punctuation">,</span>
    customData<span class="token punctuation">:</span><span class="token punctuation">{</span>
        name<span class="token punctuation">:</span><span class="token string">'州吏曹'</span><span class="token punctuation">,</span>
        email<span class="token punctuation">:</span><span class="token string">'54554155@qq.com'</span><span class="token punctuation">,</span>
        age<span class="token punctuation">:</span><span class="token number">23</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    roles<span class="token punctuation">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            role<span class="token punctuation">:</span><span class="token string">&quot;readWrite&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 开发权限</span>
            db<span class="token punctuation">:</span><span class="token string">'diff'</span> <span class="token comment">// 该仓库</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;read&quot;</span> <span class="token comment">// 所有库开放权限</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ol><li><p>数据库用户角色：read、readWrite；</p></li> <li><p>数据库管理角色：dbAdmin、dbOwner、userAdmin;</p></li> <li><p>集群管理角色：clusterAdmin、clusterManager、clusterMonitor、hostManage；</p></li> <li><p>备份恢复角色：backup、restore；</p></li> <li><p>所有数据库角色：readAnyDatabase、readWriteAnyDatabase、userAdminAnyDatabase、dbAdminAnyDatabase</p></li> <li><p>超级用户角色：root</p></li> <li><p>内部角色：__system</p></li> <li><p>查看用户</p></li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>system<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// count 修饰符</span>
db<span class="token punctuation">.</span>system<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// or pretty()</span>
db<span class="token punctuation">.</span>system<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pretty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="3"><li>删除用户</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>system<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span><span class="token string">'zhouo'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="4"><li>鉴权</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'password'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>启MongoDB服务器，然后设置必须使用建权登录。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>mongod <span class="token operator">--</span>auth
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>启动后，用户登录只能用用户名和密码进行登录</p> <ol start="5"><li>登录</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>mongo <span class="token operator">-</span>u username <span class="token operator">-</span>p password <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">27017</span><span class="token operator">/</span>admin
<span class="token comment">// 注意，一定要先连接至 admin</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>用户名<code>zlc</code>密码<code>725361</code></p> <h2 id="数据库关系"><a href="#数据库关系" class="header-anchor">#</a> 数据库关系</h2> <h3 id="嵌入式关系"><a href="#嵌入式关系" class="header-anchor">#</a> 嵌入式关系</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> user <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        name<span class="token punctuation">:</span><span class="token string">'zhou'</span><span class="token punctuation">,</span>
        address<span class="token punctuation">:</span><span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                countries<span class="token punctuation">:</span><span class="token string">'china'</span><span class="token punctuation">,</span>
                province<span class="token punctuation">:</span><span class="token string">'hu bei'</span><span class="token punctuation">,</span>
                city<span class="token punctuation">:</span><span class="token string">'wu han'</span><span class="token punctuation">,</span>
                area<span class="token punctuation">:</span><span class="token string">'hong shan'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
                countries<span class="token punctuation">:</span><span class="token string">'china'</span><span class="token punctuation">,</span>
                province<span class="token punctuation">:</span><span class="token string">'hu bei'</span><span class="token punctuation">,</span>
                city<span class="token punctuation">:</span><span class="token string">'huang gang'</span><span class="token punctuation">,</span>
                area<span class="token punctuation">:</span><span class="token string">'ma cheng'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>这样会产生的问题是数据无法重用，数据量会一直增长，影响读写性能</p> <h3 id="引用式关系"><a href="#引用式关系" class="header-anchor">#</a> 引用式关系</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> user <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        name<span class="token punctuation">:</span><span class="token string">'zhou'</span><span class="token punctuation">,</span>
        address<span class="token punctuation">:</span><span class="token punctuation">[</span>
            <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">'52ffc4a5d85242602e000000'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">'52ffc4a5d85242602e000001'</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>将用户信息和地址分文档储存，通过引用id建立关系</p> <h2 id="数据库引用"><a href="#数据库引用" class="header-anchor">#</a> 数据库引用</h2> <h3 id="dbrefs"><a href="#dbrefs" class="header-anchor">#</a> DBRefs</h3> <p><code>{ $ref: &lt;集合名&gt;, $id:&lt;引用id&gt; , $db:&lt;可选，数据库名&gt; }</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> user <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span><span class="token string">'zhou'</span><span class="token punctuation">,</span>
    address<span class="token punctuation">:</span><span class="token punctuation">{</span>
        $ref<span class="token punctuation">:</span><span class="token string">'address'</span><span class="token punctuation">,</span>
        $id<span class="token punctuation">:</span><span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">'52ffc4a5d85242602e000000'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        $db<span class="token punctuation">:</span><span class="token string">'other'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="查询分析"><a href="#查询分析" class="header-anchor">#</a> 查询分析</h2> <h3 id="explain"><a href="#explain" class="header-anchor">#</a> explain()</h3> <p>explain 操作提供了查询信息，使用索引及查询统计等。有利于我们对索引的优化</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code> db.runoob.find<span class="token punctuation">(</span><span class="token punctuation">{</span>     likes:10 <span class="token punctuation">}</span>,<span class="token punctuation">{</span>     title:1,     _id:0 <span class="token punctuation">}</span><span class="token punctuation">)</span>.<span class="token function-name function">explain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token string">&quot;queryPlanner&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;plannerVersion&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
                <span class="token string">&quot;namespace&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;test.runoob&quot;</span>,
                <span class="token string">&quot;indexFilterSet&quot;</span> <span class="token builtin class-name">:</span> false,
                <span class="token string">&quot;parsedQuery&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                        <span class="token string">&quot;likes&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                                <span class="token string">&quot;<span class="token variable">$eq</span>&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">10</span>
                        <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>,
                <span class="token string">&quot;winningPlan&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                        <span class="token string">&quot;stage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;PROJECTION&quot;</span>,
                        <span class="token string">&quot;transformBy&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                                <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
                                <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>
                        <span class="token punctuation">}</span>,
                        <span class="token string">&quot;inputStage&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                                <span class="token string">&quot;stage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;COLLSCAN&quot;</span>,
                                <span class="token string">&quot;filter&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                                        <span class="token string">&quot;likes&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                                                <span class="token string">&quot;<span class="token variable">$eq</span>&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">10</span>
                                        <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span>,
                                <span class="token string">&quot;direction&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;forward&quot;</span>
                        <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>,
                <span class="token string">&quot;rejectedPlans&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;serverInfo&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;host&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;DESKTOP-700R2G4&quot;</span>,
                <span class="token string">&quot;port&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">27017</span>,
                <span class="token string">&quot;version&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;4.0.4&quot;</span>,
                <span class="token string">&quot;gitVersion&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;f288a3bdf201007f3693c58e140056adf8b04839&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;ok&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><ul><li><strong>indexOnly</strong>: 字段为 true ，表示我们使用了索引。</li> <li><strong>cursor</strong>：因为这个查询使用了索引，MongoDB 中索引存储在B树结构中，所以这是也使用了 BtreeCursor 类型的游标。如果没有使用索引，游标的类型是 BasicCursor。这个键还会给出你所使用的索引的名称，你通过这个名称可以查看当前数据库下的system.indexes集合（系统自动创建，由于存储索引信息，这个稍微会提到）来得到索引的详细信息。</li> <li><strong>n</strong>：当前查询返回的文档数量。</li> <li><strong>nscanned/nscannedObjects</strong>：表明当前这次查询一共扫描了集合中多少个文档，我们的目的是，让这个数值和返回文档的数量越接近越好。</li> <li><strong>millis</strong>：当前查询所需时间，毫秒数。</li> <li><strong>indexBounds</strong>：当前查询具体使用的索引。</li></ul> <h3 id="hint-参照索引篇-hint"><a href="#hint-参照索引篇-hint" class="header-anchor">#</a> hint() 参照索引篇 hint</h3> <h2 id="原子操作"><a href="#原子操作" class="header-anchor">#</a> 原子操作</h2> <p>参照 <a href="#%E7%8A%B6%E6%80%81%E8%BF%94%E5%9B%9E%E4%B8%8E%E5%AE%89%E5%85%A8">状态返回与安全</a> 这一章，使用 findAndModify() 方法确保修改的有效性，该方法返回修改的状态确保我们知道修改的成功与否，因为它的修改是同步的，这与sql的事务机制本质上要达到的功能是一样的。</p> <p><strong>原子操作命令</strong>一般出现在update中</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">findAndModify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    query<span class="token punctuation">:</span><span class="token punctuation">{</span>
        age<span class="token punctuation">:</span><span class="token punctuation">{</span>
            $gt<span class="token punctuation">:</span><span class="token number">18</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    update<span class="token punctuation">:</span><span class="token punctuation">{</span>
        $push<span class="token punctuation">:</span><span class="token punctuation">{</span>
            tags<span class="token punctuation">:</span><span class="token string">'未成年'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ol><li>$set  对指定key更新value</li></ol> <p><code>$set:{key:value}</code></p> <ol start="2"><li>$unset 删除key对应的键值对</li></ol> <p><code>$unset:{key:value}</code></p> <ol start="3"><li>$inc 对value为数字的value进行增减</li></ol> <p><code>$inc:{age:1}</code></p> <ol start="4"><li>$push 追加到数组，如果没有则创建数组</li></ol> <p><code>$push:{key:value}</code></p> <ol start="5"><li>$pushAll 追加多个值到数组 (<strong>不可用</strong>)</li></ol> <p><code>$pushAll:{key:array}</code></p> <ol start="6"><li>$pull 在数组中删除一个和value相等的值</li></ol> <p><code>$pull:{key:value}</code></p> <ol start="7"><li>$addToSet 当value不存在于key的数组中，添加这个value</li></ol> <p><code>$addToSet:{key:value}</code></p> <ol start="8"><li>$pop 删除数组第一个或最后一个，-1删除第一个，1删除最后一个</li></ol> <p><code>$pop:{key:1 or -1}</code></p> <ol start="9"><li>rename 给key换一个字段</li></ol> <p><code>$rename:{key:new_key}</code></p> <ol start="10"><li>$ 代量 修改数组中的对象的属性</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>comments<span class="token punctuation">:</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        count<span class="token punctuation">:</span><span class="token number">21</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        count<span class="token punctuation">:</span><span class="token number">25</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>$inc:{'comments.$.count':1}</code></p> <h2 id="objectid"><a href="#objectid" class="header-anchor">#</a> ObjectId</h2> <p>ObjectId 是一个12字节 BSON 类型数据，有以下格式：</p> <ul><li>前4个字节表示时间戳</li> <li>接下来的3个字节是机器标识码</li> <li>紧接的两个字节由进程id组成（PID）</li> <li>最后三个字节是随机数</li></ul> <p><code>new_objec_id = new ObjectId()</code>手动生成ObjectId</p> <p><code>ObjectId('5349b4ddd2781d08c09890f4').getTimestamp()</code> 返回创建时间</p> <p><code>new ObjectId().str</code> 返回guid字符串</p> <h2 id="map-reduce"><a href="#map-reduce" class="header-anchor">#</a> Map Reduce</h2> <p><img src="http://yanxuan.nosdn.127.net/f2cc5c392d7433da5bf52c7d82ece122.png" alt="map reduce"></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token punctuation">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">&quot;5d221002ea2c383a764c0d26&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;id&quot;</span> <span class="token punctuation">:</span> <span class="token number">116</span><span class="token punctuation">,</span> <span class="token string">&quot;amount&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;100.00&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;balance&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;100.00&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;create_time&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;2019-07-03 11:43:30&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;status&quot;</span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;change_type&quot;</span> <span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token punctuation">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">&quot;5d221002ea2c383a764c0d27&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;id&quot;</span> <span class="token punctuation">:</span> <span class="token number">117</span><span class="token punctuation">,</span> <span class="token string">&quot;amount&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;300.00&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;balance&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;400.00&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;create_time&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;2019-07-03 11:44:15&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;status&quot;</span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;change_type&quot;</span> <span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token punctuation">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">&quot;5d221002ea2c383a764c0d28&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;id&quot;</span> <span class="token punctuation">:</span> <span class="token number">118</span><span class="token punctuation">,</span> <span class="token string">&quot;amount&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;300.00&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;balance&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;700.00&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;create_time&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;2019-07-03 11:45:14&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;status&quot;</span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;change_type&quot;</span> <span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token punctuation">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">&quot;5d221002ea2c383a764c0d29&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;id&quot;</span> <span class="token punctuation">:</span> <span class="token number">129</span><span class="token punctuation">,</span> <span class="token string">&quot;amount&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;5000.00&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;balance&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;5700.00&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;create_time&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;2019-07-03 14:12:28&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;status&quot;</span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;change_type&quot;</span> <span class="token punctuation">:</span> <span class="token number">10</span> <span class="token punctuation">}</span>

db<span class="token punctuation">.</span>time<span class="token punctuation">.</span><span class="token function">mapReduce</span><span class="token punctuation">(</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">emit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// =&gt; </span>
        <span class="token comment">/*
        
        {
        	116:[1]
        },
        {
        	117:[1]
        }
        ...
        */</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">k<span class="token punctuation">,</span>v</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">/*
        {
            _id:116, // 如果该key下有多个值时也只取第0个下标
            value:1
        }
        */</span>
        <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        query<span class="token punctuation">:</span><span class="token punctuation">{</span>
            status<span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 查询所有</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        out<span class="token punctuation">:</span><span class="token string">'time_total'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// =&gt;</span>
<span class="token comment">//result</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token punctuation">:</span> <span class="token number">116</span><span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span> <span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token punctuation">:</span> <span class="token number">117</span><span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span> <span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token punctuation">:</span> <span class="token number">118</span><span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span> <span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token punctuation">:</span> <span class="token number">129</span><span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span> <span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h2 id="正则"><a href="#正则" class="header-anchor">#</a> 正则</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code>db<span class="token punctuation">.</span>runoob<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    context<span class="token punctuation">:</span><span class="token regex">/html/i</span><span class="token punctuation">,</span> <span class="token comment">// 你可以检索文章</span>
    tags<span class="token punctuation">:</span><span class="token regex">/mongodb/i</span><span class="token punctuation">,</span> <span class="token comment">// 也可以检索数组</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>如果字段设置了索引，优先使用索引，这样比正则更快</p> <p>正则表达式中使用变量 <code>context:eval(&quot;/&quot; + variable + &quot;/i&quot;)</code></p></blockquote> <p>MongoDB使用$regex操作符来设置匹配字符串的正则表达式，使用PCRE(Pert Compatible Regular Expression)作为正则表达式语言。</p> <p>regex 操作符 <code>{key:{$regex:/pattern/,$options:'&lt;option&gt;'}}</code></p> <p>正则表达式对象<code>{key:/pattern/&lt;options&gt;}</code></p> <p>$regex 和正则表达式的区别</p> <ul><li>在$in操作符中只能使用正则表达式对象。<code>{name:{$in:[/^joe/i,/^jack/]}}</code></li> <li>在使用隐式的$and操作符中，只能使用$regex 。<code>{name:{$regex:/^jo/i,$nin:['john']}'}</code></li> <li>当option选项中包含X或S选项时，只能使用$regex。<code>{name:{$regex:/m.*line/,$options:&quot;si&quot;}}</code></li></ul> <p>$regex 操作符的使用。（包括i, m, x以及S四个选项 ）</p> <ul><li>x 忽略非转义的空白字符，{&lt;field&gt;:{$regex:/pattern/,$options:'m'}，设置x选项后，正则表达式中的非转义的空白字符将被忽略，同时井号 # 被解释为注释的开头注，只能显式位于option选项中。</li> <li>s 单行匹配模式{&lt;field&gt;:{$regex:/pattern/,$options:'s'}，设置s选项后，会改变模式中的点号(.)元字符的默认行为，它会匹配所有字符，包括换行符(\n)，只能显式位于option选项中。</li> <li>在设置索引的字段上进行正则匹配可以提高查询速度，而且当正则表达式使用的是前缀表达式时，查询速度会进一步提高，例如:{name:{$regex: /^joe/}</li></ul> <h2 id="固定集合"><a href="#固定集合" class="header-anchor">#</a> 固定集合</h2> <p>MongoDB 固定集合（Capped Collections）是性能出色且有着固定大小的集合 ，当集合空间用完后，再插入的元素就会覆盖最初始的头部的元素！</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 创建固定集合</span>
db<span class="token punctuation">.</span><span class="token function">createCollection</span><span class="token punctuation">(</span><span class="token string">'fixationCollection'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
   capped<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 设置为创建固定集合</span>
   size<span class="token punctuation">:</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token comment">// 集合大小</span>
   max<span class="token punctuation">:</span><span class="token number">1000</span> <span class="token comment">// 文档个数</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 判断 time 是否为固定集合</span>
db<span class="token punctuation">.</span>time<span class="token punctuation">.</span><span class="token function">isCapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 将已存在集合转换为固定集合</span>
db<span class="token punctuation">.</span><span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
   <span class="token string">'convertToCapped'</span><span class="token punctuation">:</span><span class="token string">'posts'</span><span class="token punctuation">,</span> <span class="token comment">// 将posts 转换为固定集合</span>
   size<span class="token punctuation">:</span><span class="token number">10000</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>固定集合文档按照插入顺序储存的,默认情况下查询就是按照插入顺序返回的,也可以使用$natural调整返回顺序。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&gt;db.cappedLogCollection.find().sort({$natural:-1})
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>可以插入及更新,但更新不能超出collection的大小,否则更新失败,不允许删除,但是可以调用drop()删除集合中的所有行,但是drop后需要显式地重建集合。</p> <p>在32位机子上一个cappped collection的最大值约为482.5M,64位上只受系统文件大小的限制。</p></blockquote> <ul><li>固定集合插入速度极快</li> <li>按插入顺序查询输出速度极快</li> <li>插入新数据时，如果数据量触顶将淘汰最旧数据</li></ul> <h3 id="使用场景"><a href="#使用场景" class="header-anchor">#</a> 使用场景</h3> <ul><li>储存日志</li> <li>缓存少量文档</li></ul> <h2 id="图形化管理工具"><a href="#图形化管理工具" class="header-anchor">#</a> 图形化管理工具</h2> <ol><li><a href="https://github.com/mongo-express/mongo-express" target="_blank" rel="noopener noreferrer">mongo-express<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/mrvautin/adminMongo" target="_blank" rel="noopener noreferrer">adminMongo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol></div> <!----> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后一次修改于: </span> <span class="time">10/30/2019, 4:53:43 PM</span></div></footer> <!----> </main> <div class="valine-wrapper" data-v-5029e45b><div id="valine" data-v-5029e45b></div></div></div> <div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;background-color:rgba(231, 234, 241,.5);display:none;" data-v-cd623d78 data-v-cd623d78><i class="iconfont reco-up" data-v-cd623d78></i></div></div></div></div><div class="global-ui"><div class="kanbanniang" data-v-3a90f39c><div class="banniang-container" style="display:;" data-v-3a90f39c><div class="messageBox" style="position:fixed;right:80px;bottom:195px;display:none;" data-v-3a90f39c>
      欢迎来到 LLORZ-O
    </div> <div class="operation" style="display:none;" data-v-3a90f39c><i class="iconfont icon-ban-home ban-home" data-v-3a90f39c></i> <i class="iconfont icon-aliicon-copy message" data-v-3a90f39c></i> <i class="iconfont icon-close close" data-v-3a90f39c></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-3a90f39c><i class="iconfont icon-info info" data-v-3a90f39c></i></a> <i class="iconfont icon-theme skin" style="display:none;" data-v-3a90f39c></i></div> <canvas id="banniang" width="150" height="220" class="live2d" style="position:fixed;right:90px;bottom:-20px;opacity:0.9;" data-v-3a90f39c></canvas></div> <div class="showBanNiang" style="display:none;" data-v-3a90f39c>
    看板娘
  </div></div></div></div>
    <script src="/assets/js/app.47c924c6.js" defer></script><script src="/assets/js/4.4a909b2e.js" defer></script><script src="/assets/js/1.412fd552.js" defer></script><script src="/assets/js/18.7f22e8b6.js" defer></script>
  </body>
</html>
